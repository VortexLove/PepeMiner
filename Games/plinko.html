<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plinko Pro | PepeBlackJack</title>
    
    <!-- Librer√≠as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- TEM√ÅTICA CASINO CYBERPUNK --- */
        :root {
            --primary: #00ff2a;
            --primary-glow: rgba(0, 255, 42, 0.6);
            --bg-dark: #05080a;
            --bg-panel: #0b1016;
            --bg-card: #121924;
            --border-color: #1f2937;
        }

        body { 
            background-color: var(--bg-dark); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; /* Evitar scroll global durante el juego */
            touch-action: manipulation;
        }

        h1, .brand-font { font-family: 'Space Grotesk', sans-serif; }

        /* UI Elements */
        .glass-panel {
            background: rgba(11, 16, 22, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .text-neon { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }

        .btn-gradient {
            background: linear-gradient(135deg, #00ff2a 0%, #009919 100%);
            color: #000; font-weight: 900; letter-spacing: 0.5px;
            box-shadow: 0 0 15px rgba(0, 255, 42, 0.2);
            transition: all 0.2s;
        }
        .btn-gradient:active { transform: scale(0.98); }
        .btn-gradient:hover { box-shadow: 0 0 30px var(--primary-glow); brightness: 1.1; }

        /* GAME LAYOUT */
        .game-wrapper {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar & Controls */
        .controls-area {
            background: var(--bg-panel);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 15px;
            overflow-y: auto;
            z-index: 20;
        }

        /* Game Stage */
        .stage-area {
            position: relative;
            background: radial-gradient(circle at 50% 30%, #1a2332 0%, #05080a 70%);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Canvas Container */
        .canvas-wrapper {
            flex: 1;
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 0;
        }

        /* Inputs */
        .input-group {
            background: #05080a;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2px;
            display: flex;
            align-items: center;
            transition: 0.3s;
        }
        .input-group:focus-within { border-color: var(--primary); box-shadow: 0 0 10px rgba(0,255,42,0.1); }
        .input-clean {
            background: transparent; border: none; color: white; width: 100%;
            padding: 10px; font-weight: bold; outline: none;
        }

        /* Multipliers (HTML overlay for tooltips) */
        .multipliers-overlay {
            position: absolute;
            bottom: 20px;
            display: flex;
            justify-content: center;
            width: 100%;
            gap: 4px; /* Ajustado din√°micamente por JS */
            padding: 0 20px;
            pointer-events: none; /* Dejar pasar clicks al canvas si fuera necesario */
        }
        
        .mult-pill {
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 800;
            color: #000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: transform 0.1s, filter 0.1s;
            pointer-events: auto;
            cursor: help;
            border-bottom: 2px solid rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        .mult-pill:hover { transform: translateY(-5px) scale(1.1); filter: brightness(1.2); z-index: 50; }

        /* History Bar */
        .history-bar {
            height: 40px;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 20px;
            gap: 5px;
            overflow: hidden;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .hist-pill {
            min-width: 40px; height: 24px; border-radius: 12px;
            font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center;
            color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Floating UI */
        #hoverInfo {
            position: absolute; background: rgba(5, 8, 10, 0.95); 
            border: 1px solid var(--primary); color: white;
            padding: 8px 12px; border-radius: 8px; pointer-events: none; opacity: 0;
            z-index: 100; font-size: 11px; transform: translate(-50%, -120%);
            box-shadow: 0 0 20px rgba(0,255,42,0.15); transition: opacity 0.2s;
        }

        /* Mobile Adjustments */
        @media (max-width: 1023px) {
            .game-wrapper { grid-template-columns: 1fr; grid-template-rows: auto 1fr; height: 100vh; }
            .controls-area { order: 2; height: auto; max-height: 40vh; border-right: none; border-top: 1px solid var(--border-color); padding: 15px; }
            .stage-area { order: 1; height: 60vh; }
            .brand-mobile { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        }
        @media (min-width: 1024px) {
            .brand-mobile { display: none; }
        }
    </style>
</head>
<body class="antialiased">

    <!-- AUDIO -->
    <audio id="sfx-plink" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.mp3"></audio>
    <audio id="sfx-bigwin" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>

    <div class="game-wrapper">
        
        <!-- SIDEBAR CONTROLS -->
        <div class="controls-area custom-scrollbar">
            
            <!-- Mobile Header inside controls -->
            <div class="brand-mobile lg:hidden">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üê∏</span>
                    <span class="font-bold font-mono">PepeBJ</span>
                </div>
                <div class="bg-black/30 px-3 py-1 rounded text-xs font-mono">
                    <span class="text-neon" id="mobBalance">0.00</span> PBJ
                </div>
            </div>

            <!-- Desktop Brand -->
            <div class="hidden lg:flex items-center gap-3 mb-4 cursor-pointer" onclick="window.location.href='../index.html'">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-green-900 flex items-center justify-center text-xl shadow-[0_0_15px_rgba(0,255,42,0.4)]">üê∏</div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white leading-none">Pepe<span class="text-neon">BJ</span></h1>
                    <span class="text-[9px] text-gray-500 uppercase tracking-widest">Plinko v2.0</span>
                </div>
            </div>

            <!-- Balance Card -->
            <div class="bg-[#0e141b] p-4 rounded-xl border border-white/5 relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-20 h-20 bg-neon/10 rounded-full blur-2xl -mr-10 -mt-10 transition group-hover:bg-neon/20"></div>
                <div class="flex justify-between items-end mb-1">
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Balance</span>
                    <span class="text-[10px] text-neon cursor-pointer hover:underline">Deposit</span>
                </div>
                <div class="flex items-baseline gap-1">
                    <span class="text-2xl font-black font-mono tracking-tight" id="uiBalance">1,000.00</span>
                    <span class="text-xs text-green-500 font-bold">PBJ</span>
                </div>
            </div>

            <!-- Controls Form -->
            <div class="flex flex-col gap-4 mt-2">
                
                <!-- Mode Toggle -->
                <div class="flex bg-black/40 p-1 rounded-lg">
                    <button id="modeManual" class="flex-1 py-2 rounded-md text-xs font-bold bg-gray-700 text-white shadow-lg transition" onclick="setMode('manual')">Manual</button>
                    <button id="modeAuto" class="flex-1 py-2 rounded-md text-xs font-bold text-gray-500 hover:text-white transition" onclick="setMode('auto')">Auto</button>
                </div>

                <!-- Bet Amount -->
                <div>
                    <div class="flex justify-between mb-1">
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Bet Amount</label>
                        <span class="text-[10px] text-gray-600">Max: 10,000</span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="betInput" value="10" class="input-clean" oninput="validateBet()">
                        <div class="flex gap-1 pr-1">
                            <button onclick="adjustBet(0.5)" class="px-2 py-1 bg-[#1a2c38] hover:bg-[#263549] text-gray-400 text-[10px] rounded font-bold">¬Ω</button>
                            <button onclick="adjustBet(2)" class="px-2 py-1 bg-[#1a2c38] hover:bg-[#263549] text-gray-400 text-[10px] rounded font-bold">2x</button>
                        </div>
                    </div>
                </div>

                <!-- Risk Level -->
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase block mb-1">Risk Level</label>
                    <select id="riskSelect" onchange="updateConfig()" class="w-full bg-[#05080a] border border-gray-800 rounded-lg p-3 text-sm font-bold focus:border-neon outline-none">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>

                <!-- Rows -->
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase block mb-1">Rows: <span id="rowsVal" class="text-white">16</span></label>
                    <input type="range" id="rowsInput" min="8" max="16" value="16" step="1" oninput="updateConfig()" class="w-full h-2 bg-gray-800 rounded-lg appearance-none cursor-pointer accent-[#00ff2a]">
                </div>

                <!-- Auto Controls (Hidden by default) -->
                <div id="autoControls" class="hidden">
                    <label class="text-[10px] font-bold text-gray-500 uppercase block mb-1">Number of Bets (0 = Infinite)</label>
                    <input type="number" id="autoCount" value="0" class="w-full bg-[#05080a] border border-gray-800 rounded-lg p-2 text-xs font-bold mb-2">
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 gap-2 bg-white/5 p-3 rounded-lg border border-white/5">
                    <div class="text-center">
                        <div class="text-[9px] text-gray-500 uppercase">Profit on Win</div>
                        <div class="text-xs font-bold text-neon" id="maxWinDisplay">0.00</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[9px] text-gray-500 uppercase">Chance</div>
                        <div class="text-xs font-bold text-white" id="chanceDisplay">0.00%</div>
                    </div>
                </div>

                <!-- Action Button -->
                <button id="playBtn" class="btn-gradient w-full py-4 rounded-xl mt-2 text-lg uppercase shadow-lg relative overflow-hidden" onclick="triggerAction()">
                    <span id="btnText">BET</span>
                    <div class="absolute inset-0 bg-white/20 skew-x-12 -translate-x-full group-hover:translate-x-full transition duration-500"></div>
                </button>
                
                <p class="text-[9px] text-center text-gray-600 mt-2">Spacebar to drop ‚Ä¢ Fair Play Guaranteed</p>
            </div>
        </div>

        <!-- GAME STAGE -->
        <div class="stage-area">
            <!-- History Strip -->
            <div class="history-bar" id="historyBar">
                <!-- Javascript will populate this -->
                <span class="text-[10px] text-gray-600 mr-auto uppercase tracking-widest">Recent:</span>
            </div>

            <!-- Canvas Container -->
            <div class="canvas-wrapper" id="canvasContainer">
                <canvas id="gameCanvas"></canvas>
                
                <!-- Tooltip Overlay -->
                <div id="hoverInfo">
                    <div class="font-bold text-sm text-center" id="tipMult">100x</div>
                    <div class="text-[10px] text-gray-400">Profit: <span id="tipProfit" class="text-neon">0.00</span></div>
                    <div class="text-[10px] text-gray-400">Chance: <span id="tipChance" class="text-yellow-400">0.00%</span></div>
                </div>

                <!-- Multipliers Container (Generated by JS) -->
                <div id="multipliersContainer" class="multipliers-overlay"></div>
            </div>
        </div>

    </div>

    <script>
        /**
         * PEPE BLACKJACK PLINKO ENGINE V2
         * High Performance Canvas Rendering
         */
        
        // --- CONFIG & STATE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: true }); // Optimized
        const container = document.getElementById('canvasContainer');
        
        // Game State
        let balance = 1000.00;
        let config = { rows: 16, risk: 'medium' };
        let gameMode = 'manual'; // manual | auto
        let autoActive = false;
        let autoInterval = null;
        let balls = [];
        let particles = [];
        let pegs = [];
        let multipliers = []; // { val: 100, color: '#f00' }
        
        // Settings
        const PEG_RADIUS = 3;
        const BALL_RADIUS = 5;
        const GRAVITY = 0.25;
        
        // Colors
        const COLORS = {
            peg: '#374151',
            pegActive: '#ffffff',
            ball: '#00ff2a',
            text: '#ffffff',
            multipliers: {
                low: ['#374151', '#4b5563'], // < 1x
                med: ['#10b981', '#059669'], // > 2x
                high: ['#f59e0b', '#d97706'], // > 10x
                extreme: ['#ef4444', '#b91c1c'] // > 50x
            }
        };

        // --- INITIALIZATION ---
        window.onload = () => {
            // Load saved balance if exists
            const saved = localStorage.getItem('pepe_balance');
            if(saved) balance = parseFloat(saved);
            
            updateUI();
            updateConfig(); // Calculate maths
            resize(); // Setup canvas
            loop(); // Start animation
            
            // Listeners
            window.addEventListener('resize', resize);
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && !e.repeat && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    triggerAction();
                }
            });
        };

        function resize() {
            // High DPI Canvas Scaling
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = `${rect.width}px`;
            canvas.style.height = `${rect.height}px`;
            ctx.scale(dpr, dpr);
            
            // Re-calculate geometry
            initGeometry(rect.width, rect.height);
        }

        // --- MATH & GEOMETRY ---
        function initGeometry(width, height) {
            pegs = [];
            // Dynamically calculate gaps to fit screen
            // Bottom area (multipliers) needs about 40px
            const availableHeight = height - 60; 
            const startY = 40; 
            
            // Gap logic:
            // height = startY + (rows * verticalGap)
            const verticalGap = (availableHeight - startY) / config.rows;
            // Limit gap size for aesthetics (not too stretched)
            const gap = Math.min(verticalGap, width / (config.rows + 2));
            
            // Generate Pegs
            for (let r = 0; r < config.rows; r++) {
                for (let c = 0; c <= r; c++) {
                    const x = (width / 2) - (r * gap / 2) + (c * gap);
                    const y = startY + (r * gap);
                    pegs.push({ x, y, r: PEG_RADIUS, glow: 0 });
                }
            }
            
            // Save metric for render loop
            config.gap = gap;
            config.startX = width / 2;
            config.startY = startY;
            
            // Update HTML Multipliers
            renderHTMLMultipliers(width, gap);
        }

        function getMultipliersMath() {
            // Simple binomial distribution probability approx logic for colors
            // Real math for values
            const r = config.rows;
            const mults = [];
            
            // Defines simplified multiplier tables based on Stake/BC.Game style logic
            // This is "Client Side" visualization.
            // Index 0 = Leftmost.
            
            const strategies = {
                low: { 16: [10, 5, 2, 1.5, 1.1, 1, 0.7, 0.7, 0.7, 1, 1.1, 1.5, 2, 5, 10], 8: [5.6, 2.1, 1.1, 1, 0.5, 1, 1.1, 2.1, 5.6] },
                medium: { 16: [110, 41, 10, 5, 3, 1.5, 1, 0.5, 0.5, 1, 1.5, 3, 5, 10, 41, 110], 8: [13, 3, 1.3, 0.7, 0.4, 0.7, 1.3, 3, 13] },
                high: { 16: [1000, 130, 26, 9, 4, 2, 0.2, 0.2, 0.2, 0.2, 0.2, 2, 4, 9, 26, 130, 1000], 8: [29, 4, 1.5, 0.3, 0.2, 0.3, 1.5, 4, 29] }
            };

            // Fallback generation algorithm if preset doesn't exist (simplified)
            let values = [];
            if(strategies[config.risk][config.rows]) {
                values = strategies[config.risk][config.rows];
            } else {
                // Procedural generation fallback
                const count = config.rows + 1;
                for(let i=0; i<count; i++) {
                    const dist = Math.abs(i - Math.floor(count/2));
                    let v = 1 + (dist*dist * (config.risk=='high'?0.5:0.1));
                    values.push(parseFloat(v.toFixed(1)));
                }
            }
            
            // Ensure array length matches config.rows + 1
            // Sometimes presets are symmetric, we double check length
            while(values.length < config.rows + 1) values.push(1); // Padding error safety

            // Map colors
            return values.map(val => {
                let c = COLORS.multipliers.low;
                if(val >= 2) c = COLORS.multipliers.med;
                if(val >= 9) c = COLORS.multipliers.high;
                if(val >= 50) c = COLORS.multipliers.extreme;
                return { val, color: c };
            });
        }

        function renderHTMLMultipliers(width, gap) {
            const container = document.getElementById('multipliersContainer');
            container.innerHTML = '';
            
            multipliers.forEach((m, i) => {
                const el = document.createElement('div');
                el.className = 'mult-pill';
                // Calculate width to fit perfectly in gap, minus margin
                const w = gap - 4; 
                el.style.width = `${w}px`;
                el.style.background = `linear-gradient(180deg, ${m.color[0]}, ${m.color[1]})`;
                el.innerText = m.val + 'x';
                
                // Opacity for low multipliers (loss)
                if(m.val < 1) el.style.opacity = '0.6';

                // Hover Event
                el.onmouseenter = () => {
                    const bet = parseFloat(document.getElementById('betInput').value) || 0;
                    const profit = (bet * m.val) - bet;
                    const tip = document.getElementById('hoverInfo');
                    
                    document.getElementById('tipMult').innerText = m.val + "x";
                    document.getElementById('tipProfit').innerText = profit.toFixed(2);
                    document.getElementById('tipProfit').className = profit >= 0 ? "text-neon font-bold" : "text-red-500 font-bold";
                    
                    // Position Tip
                    const r = el.getBoundingClientRect();
                    const pRect = document.querySelector('.stage-area').getBoundingClientRect();
                    tip.style.left = (r.left - pRect.left + r.width/2) + "px";
                    tip.style.bottom = "50px"; // Fixed from bottom
                    tip.style.opacity = 1;
                };
                el.onmouseleave = () => { document.getElementById('hoverInfo').style.opacity = 0; };
                
                // ID for animation later
                el.id = `mult-${i}`;
                
                container.appendChild(el);
            });
        }

        // --- GAME LOGIC ---

        function updateConfig() {
            config.rows = parseInt(document.getElementById('rowsInput').value);
            config.risk = document.getElementById('riskSelect').value;
            
            document.getElementById('rowsVal').innerText = config.rows;
            multipliers = getMultipliersMath();
            
            // Update stats UI
            const max = Math.max(...multipliers.map(m=>m.val));
            document.getElementById('maxWinDisplay').innerText = max + "x";
            
            // Re-render geometry
            resize(); 
        }

        function setMode(mode) {
            gameMode = mode;
            document.getElementById('modeManual').className = mode==='manual' ? 'flex-1 py-2 rounded-md text-xs font-bold bg-gray-700 text-white shadow-lg transition' : 'flex-1 py-2 rounded-md text-xs font-bold text-gray-500 hover:text-white transition';
            document.getElementById('modeAuto').className = mode==='auto' ? 'flex-1 py-2 rounded-md text-xs font-bold bg-neon text-black shadow-lg transition' : 'flex-1 py-2 rounded-md text-xs font-bold text-gray-500 hover:text-white transition';
            
            const btn = document.getElementById('playBtn');
            const autoOpts = document.getElementById('autoControls');
            
            if(mode === 'auto') {
                btn.classList.remove('btn-gradient');
                btn.classList.add('bg-blue-600', 'text-white');
                btn.innerHTML = 'START AUTO';
                autoOpts.classList.remove('hidden');
            } else {
                stopAuto();
                btn.className = 'btn-gradient w-full py-4 rounded-xl mt-2 text-lg uppercase shadow-lg relative overflow-hidden';
                btn.innerHTML = '<span class="relative z-10">BET</span>';
                autoOpts.classList.add('hidden');
            }
        }

        function triggerAction() {
            if(gameMode === 'manual') {
                dropBall();
            } else {
                if(autoActive) stopAuto();
                else startAuto();
            }
        }

        function startAuto() {
            autoActive = true;
            document.getElementById('playBtn').innerHTML = 'STOP AUTO';
            document.getElementById('playBtn').classList.add('bg-red-500');
            
            let count = parseInt(document.getElementById('autoCount').value) || 0;
            let dropped = 0;
            
            autoInterval = setInterval(() => {
                if(balance <= 0) { stopAuto(); return; }
                
                dropBall();
                dropped++;
                
                if(count > 0 && dropped >= count) stopAuto();
                
            }, 250); // Fast auto speed
        }

        function stopAuto() {
            autoActive = false;
            clearInterval(autoInterval);
            document.getElementById('playBtn').innerHTML = 'START AUTO';
            document.getElementById('playBtn').classList.remove('bg-red-500');
        }

        function dropBall() {
            const betStr = document.getElementById('betInput').value;
            const bet = parseFloat(betStr);
            
            if(isNaN(bet) || bet <= 0) return Swal.fire({toast:true, position:'top', icon:'warning', title:'Invalid bet', background: '#121924', color:'#fff'});
            if(bet > balance) return Swal.fire({toast:true, position:'top', icon:'error', title:'Insufficient balance', background: '#121924', color:'#fff'});
            
            // Deduct
            balance -= bet;
            updateUI();
            
            // Pre-calculate path (Binomial Random Walk)
            // 0 = Left (Left pin side), 1 = Right
            const path = [];
            let currentX = 0; // Relative to center index
            for(let i=0; i<config.rows; i++) {
                // 50/50 chance
                const dir = Math.random() < 0.5 ? -0.5 : 0.5;
                path.push(dir);
            }
            
            // Final index logic:
            // The ball starts at index 0 (top).
            // Rows N has N+1 slots.
            // Sum of directions maps to the slot.
            // Let's simplify: A pure random left/right at each peg determines the final bin.
            // Bin index = (Sum of 1s)
            const rightMoves = path.filter(d => d === 0.5).length;
            const finalIndex = rightMoves; // naturally maps 0 to rows
            
            // Spawn Ball Object
            balls.push({
                x: canvas.width / 2 / (window.devicePixelRatio||1), // Start center
                y: 20,
                vx: 0,
                vy: 0,
                radius: BALL_RADIUS,
                color: COLORS.ball,
                path: path,
                row: 0,
                targetIndex: finalIndex,
                bet: bet,
                active: true,
                trail: [] // {x, y, opacity}
            });
        }

        // --- PHYSICS & ANIMATION LOOP ---
        function loop() {
            // Clear
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 1. Draw Pegs
            ctx.fillStyle = COLORS.peg;
            pegs.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                
                // Glow logic
                if(p.glow > 0) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${p.glow})`;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = "white";
                    p.glow -= 0.05; // Fade out
                } else {
                    ctx.fillStyle = COLORS.peg;
                    ctx.shadowBlur = 0;
                }
                
                ctx.fill();
                ctx.closePath();
            });
            ctx.shadowBlur = 0;

            // 2. Process Balls
            const dpr = window.devicePixelRatio || 1;
            
            for (let i = balls.length - 1; i >= 0; i--) {
                let b = balls[i];
                
                if(!b.active) continue;

                // Move Logic
                // We use a scripted target system for perfect alignment
                const targetRowY = config.startY + (b.row * config.gap);
                
                // Gravity visual
                b.vy += GRAVITY;
                b.y += b.vy;
                b.x += b.vx;

                // Check collision with current row's imaginary plane
                if (b.y >= targetRowY - config.gap/2 && b.row < config.rows) {
                    // It's time to hit a peg or move to next cell
                    
                    // Simple "Magnet" logic to guide ball to the pre-calculated side
                    // Current Path Decision:
                    const dir = b.path[b.row]; // -0.5 or 0.5
                    
                    // Add some randomness to X so it looks organic
                    const noise = (Math.random() - 0.5) * 0.5;
                    
                    // Push ball sideways based on path
                    b.vx += (dir * 0.8) + noise; 
                    
                    // Bounce dampen
                    b.vy *= 0.6; 
                    
                    // Identify which peg was "hit" for visual effect
                    // Approximate closest peg
                    let closestPeg = null;
                    let minDist = 999;
                    pegs.forEach(p => {
                        const dx = p.x - b.x;
                        const dy = p.y - b.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if(dist < config.gap && Math.abs(p.y - b.y) < 20) {
                             if(dist < minDist) { minDist = dist; closestPeg = p; }
                        }
                    });
                    
                    if(closestPeg && minDist < 15) {
                        closestPeg.glow = 1; // Trigger flash
                        playSound('plink');
                    }
                    
                    b.row++;
                }

                // Check Bottom (Finish)
                const finishY = config.startY + (config.rows * config.gap);
                if(b.y > finishY) {
                    finishBall(b, i);
                    continue;
                }
                
                // Draw Trail
                b.trail.push({x:b.x, y:b.y, alpha:1});
                if(b.trail.length > 10) b.trail.shift();
                
                ctx.beginPath();
                for(let t=0; t<b.trail.length-1; t++) {
                    const pt = b.trail[t];
                    const next = b.trail[t+1];
                    ctx.strokeStyle = `rgba(0, 255, 42, ${t/10})`;
                    ctx.lineWidth = 2;
                    ctx.moveTo(pt.x, pt.y);
                    ctx.lineTo(next.x, next.y);
                    b.trail[t].alpha -= 0.1;
                }
                ctx.stroke();

                // Draw Ball
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
                ctx.fillStyle = b.color;
                ctx.shadowColor = b.color;
                ctx.shadowBlur = 10;
                ctx.fill();
                ctx.shadowBlur = 0;
                ctx.closePath();
            }

            // 3. Process Particles
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.02;
                p.vy += 0.1; // gravity
                
                if(p.life <= 0) {
                    particles.splice(i, 1);
                } else {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life;
                    ctx.fillRect(p.x, p.y, 3, 3);
                    ctx.globalAlpha = 1;
                }
            }

            requestAnimationFrame(loop);
        }

        function finishBall(b, index) {
            balls.splice(index, 1);
            
            // Logic Result
            const mult = multipliers[b.targetIndex];
            const payout = b.bet * mult.val;
            
            balance += payout;
            updateUI();
            
            // Visuals
            spawnParticles(b.x, b.y, mult.color[1]);
            animateMultiplier(b.targetIndex);
            addToHistory(mult.val);
            
            // Sounds & Alerts
            if(mult.val >= 10) {
                document.getElementById('sfx-bigwin').currentTime = 0;
                document.getElementById('sfx-bigwin').play();
            } else if (payout > 0) {
                document.getElementById('sfx-win').currentTime = 0;
                document.getElementById('sfx-win').play().catch(()=>{});
            }

            localStorage.setItem('pepe_balance', balance.toFixed(2));
        }

        function spawnParticles(x, y, color) {
            for(let i=0; i<15; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 5,
                    vy: (Math.random() - 1) * 5,
                    life: 1,
                    color: color
                });
            }
        }

        function animateMultiplier(idx) {
            const el = document.getElementById(`mult-${idx}`);
            if(el) {
                el.style.transform = "translateY(-10px) scale(1.2)";
                el.style.filter = "brightness(1.5)";
                setTimeout(() => {
                    el.style.transform = "none";
                    el.style.filter = "none";
                }, 200);
            }
        }

        function addToHistory(val) {
            const bar = document.getElementById('historyBar');
            const pill = document.createElement('div');
            pill.className = 'hist-pill';
            pill.innerText = val + 'x';
            
            let bg = '#374151'; // grey
            let txt = '#fff';
            if(val >= 2) { bg = '#10b981'; txt='#000'; }
            if(val >= 10) { bg = '#f59e0b'; txt='#000'; }
            if(val >= 50) { bg = '#ef4444'; txt='#fff'; }
            
            pill.style.background = bg;
            pill.style.color = txt;
            
            // Keep only last 10
            if(bar.children.length > 10) bar.removeChild(bar.lastChild);
            bar.insertBefore(pill, bar.children[1]); // Insert after label
        }

        // --- UTILS ---
        function playSound(id) {
            const s = document.getElementById(`sfx-${id}`);
            if(s) {
                const clone = s.cloneNode();
                clone.volume = 0.2;
                clone.play().catch(()=>{});
            }
        }

        function adjustBet(m) {
            const input = document.getElementById('betInput');
            let val = parseFloat(input.value) || 0;
            val *= m;
            if(val < 1) val = 1;
            if(val > 10000) val = 10000;
            input.value = parseFloat(val.toFixed(2));
        }
        
        function validateBet() {
            const input = document.getElementById('betInput');
            if(input.value < 0) input.value = 1;
        }

        function updateUI() {
            const str = balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('uiBalance').innerText = str;
            document.getElementById('mobBalance').innerText = str;
        }

    </script>
</body>
</html>
