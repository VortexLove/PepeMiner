<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plinko | PepeBlackJack</title>
    
    <!-- Librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- TEMA CYBERPUNK STAKE --- */
        :root {
            --primary: #00ff2a;
            --primary-glow: rgba(0, 255, 42, 0.5);
            --bg-dark: #070b10;
            --bg-panel: #0f1621;
            --border-color: rgba(255,255,255,0.08);
        }

        body { 
            background-color: var(--bg-dark); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            background-image: radial-gradient(circle at 50% -20%, #112218 0%, var(--bg-dark) 70%);
        }

        h1, .brand-font { font-family: 'Space Grotesk', sans-serif; }

        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(15, 22, 33, 0.85);
            backdrop-filter: blur(12px);
            border-right: 1px solid var(--border-color);
        }

        /* Inputs modernos */
        .input-slot {
            background: #0b1018;
            border: 1px solid var(--border-color);
            color: white;
            transition: all 0.3s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .input-slot:focus {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 255, 42, 0.1);
            outline: none;
        }

        /* Botón Principal */
        .btn-neon {
            background: linear-gradient(180deg, #00ff2a 0%, #00cc22 100%);
            color: #000;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 15px rgba(0, 255, 42, 0.2);
            transition: all 0.2s;
            border: none;
        }
        .btn-neon:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(0, 255, 42, 0.4);
            filter: brightness(1.1);
        }
        .btn-neon:active { transform: scale(0.98); }

        /* Multiplicadores (Buckets) */
        .multipliers-row {
            display: flex; gap: 4px; justify-content: center; 
            margin-top: -20px; z-index: 10; width: 90%; max-width: 800px;
            position: relative;
        }
        .mult-box {
            flex: 1; height: 35px; border-radius: 6px; 
            font-size: 10px; font-weight: 800; 
            display: flex; align-items: center; justify-content: center;
            color: #000; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s, filter 0.2s;
            cursor: help;
            border-bottom: 3px solid rgba(0,0,0,0.2);
        }
        .mult-box:hover {
            transform: translateY(-5px) scale(1.1);
            z-index: 20;
            filter: brightness(1.2);
        }

        /* Tooltip de Probabilidades */
        #hoverInfo {
            position: absolute;
            background: rgba(0,0,0,0.9);
            border: 1px solid var(--primary);
            padding: 8px 12px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            font-size: 11px;
            box-shadow: 0 0 15px rgba(0,255,42,0.2);
            transform: translate(-50%, -120%);
        }

        /* Animación Pop */
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); filter: brightness(2); } 100% { transform: scale(1); } }
        .pop-anim { animation: pop 0.2s ease-out; }

        /* Layout */
        .game-wrapper { display: flex; height: 100vh; }
        .sidebar { width: 320px; flex-shrink: 0; display: flex; flex-direction: column; gap: 20px; padding: 24px; z-index: 20; }
        .game-area { flex: 1; position: relative; background: radial-gradient(circle at center, #131b29 0%, #070b10 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }

        /* Responsive */
        @media (max-width: 1024px) {
            .game-wrapper { flex-direction: column-reverse; overflow-y: auto; }
            .sidebar { width: 100%; height: auto; border-right: none; border-top: 1px solid var(--border-color); background: var(--bg-panel); }
            .game-area { min-height: 600px; }
        }
    </style>
</head>
<body>

    <!-- SONIDOS -->
    <audio id="sfx-plink" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.mp3"></audio>

    <div class="game-wrapper">
        
        <!-- SIDEBAR CONTROLS -->
        <div class="sidebar glass-panel">
            <!-- Header -->
            <div class="flex items-center justify-between mb-2">
                <a href="../index.html" class="flex items-center gap-2 text-gray-400 hover:text-white transition group">
                    <div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center group-hover:bg-white/10">
                        <i class="fas fa-chevron-left text-xs"></i>
                    </div>
                    <span class="font-bold text-sm">Casino</span>
                </a>
                <div class="flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-full border border-white/5">
                    <i class="fas fa-wallet text-neon text-[10px]" style="color:var(--primary)"></i>
                    <span id="displayBalance" class="text-sm font-bold font-mono text-white">0.00</span>
                    <span class="text-[10px] text-gray-500 font-bold">PBJ</span>
                </div>
            </div>

            <!-- Bet Control -->
            <div class="bg-[#0b1018] p-4 rounded-xl border border-white/5 shadow-inner">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-[10px] font-bold text-gray-500 tracking-wider">MONTO DE APUESTA</label>
                    <span class="text-[10px] text-gray-600" id="maxBetLabel">Max: 10,000</span>
                </div>
                <div class="relative">
                    <input type="number" id="betAmount" value="100" class="w-full p-3 input-slot rounded-lg font-bold text-sm pr-20">
                    <div class="absolute right-1 top-1 bottom-1 flex gap-1">
                        <button onclick="halfBet()" class="bg-[#1a2c38] hover:bg-[#263549] text-gray-400 text-[10px] font-bold px-2 rounded transition">½</button>
                        <button onclick="doubleBet()" class="bg-[#1a2c38] hover:bg-[#263549] text-gray-400 text-[10px] font-bold px-2 rounded transition">2x</button>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-500 tracking-wider block mb-2">RIESGO</label>
                    <select id="riskSelect" onchange="updateGameConfig()" class="w-full p-3 input-slot rounded-lg text-xs font-bold cursor-pointer">
                        <option value="low">Bajo</option>
                        <option value="medium" selected>Medio</option>
                        <option value="high">Alto</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-500 tracking-wider block mb-2">FILAS: <span id="rowsDisplay" class="text-white">16</span></label>
                    <input type="range" id="rowsInput" min="8" max="16" value="16" oninput="updateGameConfig()" class="w-full h-2 bg-[#0b1018] rounded-lg appearance-none cursor-pointer accent-[#00ff2a]">
                </div>
            </div>

            <!-- Stats Rápidas -->
            <div class="bg-white/5 rounded-lg p-3 grid grid-cols-2 gap-2 text-center border border-white/5">
                <div>
                    <p class="text-[9px] text-gray-500">Beneficio Max</p>
                    <p class="text-xs font-bold text-neon" id="maxProfitDisplay" style="color:var(--primary)">1000x</p>
                </div>
                <div>
                    <p class="text-[9px] text-gray-500">Probabilidad Min</p>
                    <p class="text-xs font-bold text-white" id="minChanceDisplay">0.0015%</p>
                </div>
            </div>

            <!-- Botón Jugar -->
            <button onclick="dropBall()" id="btnBet" class="btn-neon w-full py-4 rounded-xl mt-auto text-lg shadow-lg relative group overflow-hidden">
                <span class="relative z-10">JUGAR</span>
                <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition"></div>
            </button>
        </div>

        <!-- GAME AREA -->
        <div class="game-area">
            <!-- Tooltip Flotante -->
            <div id="hoverInfo">
                <div class="text-white font-bold" id="hoverMultiplier">1000x</div>
                <div class="text-[10px] text-gray-400">Profit: <span id="hoverProfit" class="text-green-400">100.00</span></div>
                <div class="text-[10px] text-gray-400">Chance: <span id="hoverChance" class="text-yellow-400">0.0015%</span></div>
            </div>

            <!-- Score Flotante (Animación Ganar) -->
            <div id="floatScore" class="absolute top-20 text-6xl font-black text-white opacity-0 pointer-events-none z-50 drop-shadow-[0_0_20px_rgba(0,255,42,0.8)] transition-transform duration-100">0.00</div>

            <!-- Canvas -->
            <canvas id="gameCanvas" width="800" height="650" class="max-w-full h-auto"></canvas>
            
            <!-- Multiplier Buckets -->
            <div id="multipliersContainer" class="multipliers-row">
                <!-- Se generan con JS -->
            </div>
            
            <!-- Shadow Floor -->
            <div class="absolute bottom-0 w-full h-32 bg-gradient-to-t from-[#00ff2a]/10 to-transparent pointer-events-none"></div>
        </div>
    </div>

    <!-- LOGICA -->
    <script>
        // === ENGINE PLINKO (STAKE LOGIC) ===
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let userBalance = 0;
        let username = "Invitado";
        
        // Configuración
        let rows = 16;
        let risk = 'medium';
        let balls = [];
        let pegs = [];
        let multipliers = []; // Array de objetos { value, probability }

        // Colores de Multiplicadores (Gradientes)
        const colorSchemes = {
            loss: ['#374151', '#4b5563'], // < 1x (Gris/Azul oscuro)
            low: ['#f59e0b', '#fbbf24'],  // 1x - 3x (Naranja)
            win: ['#10b981', '#34d399'],  // 3x - 10x (Verde)
            big: ['#8b5cf6', '#a78bfa'],  // 10x - 50x (Morado)
            jackpot: ['#ef4444', '#f87171'] // > 50x (Rojo)
        };

        // === INICIALIZACIÓN ===
        window.onload = () => {
            // Cargar datos
            let storedData = localStorage.getItem('pepebet_user') || localStorage.getItem('pbj_user_v2');
            if(storedData) {
                const data = JSON.parse(storedData);
                userBalance = parseFloat(data.balance);
                username = data.user || data.username;
            } else {
                Swal.fire({
                    title: 'Login Requerido',
                    text: 'Conecta tu wallet en el inicio.',
                    background: '#0f1621', color: '#fff',
                    confirmButtonText: 'Ir al Inicio'
                }).then(() => window.location.href = '../index.html');
            }
            updateBalanceUI();
            updateGameConfig();
            gameLoop();
        };

        // === MATEMÁTICAS & LÓGICA DE STAKE ===
        
        // 1. Calcular Probabilidad Binomial (Triángulo Pascal)
        function getProbability(n, k) {
            // n = filas, k = posición bucket (0 a n)
            // Coeficiente binomial: n! / (k! * (n-k)!)
            // Probabilidad: Coeff * (0.5)^n
            
            function factorialize(num) {
                if (num < 0) return -1;
                else if (num == 0) return 1;
                else return (num * factorialize(num - 1));
            }
            
            const coeff = factorialize(n) / (factorialize(k) * factorialize(n - k));
            return (coeff * Math.pow(0.5, n)) * 100; // Porcentaje
        }

        // 2. Definir Multiplicadores (Aproximación Algorítmica a Stake)
        function getMultipliersValues() {
            const count = rows + 1;
            const center = Math.floor(count / 2);
            let arr = [];

            // Estos son valores aproximados para simular las curvas de Stake
            // Ajustamos la curva exponencial basada en el riesgo
            let riskFactor;
            if(risk === 'low') riskFactor = 0.15;
            if(risk === 'medium') riskFactor = 0.35;
            if(risk === 'high') riskFactor = 0.65;

            for(let i=0; i<count; i++) {
                const dist = Math.abs(i - center);
                let val;
                
                if(dist === 0) {
                    val = risk === 'high' ? 0.2 : (risk === 'medium' ? 0.5 : 1); // Centro pierde en alto riesgo
                } else {
                    // Formula exponencial para crecer hacia los bordes
                    val = 1 + Math.pow(dist, risk === 'low' ? 1.5 : (risk === 'medium' ? 2.5 : 4)) * (0.1 / (1-riskFactor));
                }
                
                // Ajustes manuales para replicar los "Jackpots" de Stake en 16 filas
                if(rows === 16 && risk === 'high') {
                    if(dist === 8) val = 1000; // Bordes extremos
                    else if(dist === 7) val = 130;
                    else if(dist === 6) val = 26;
                    else if(dist === 0) val = 0.2;
                }
                
                // Normalización visual
                if(val < 1) val = Math.max(0.2, val);
                
                // Guardar valor y probabilidad
                let prob = getProbability(rows, i);
                arr.push({ val: parseFloat(val.toFixed(2)), prob: prob.toFixed(4) });
            }
            return arr;
        }

        function updateGameConfig() {
            rows = parseInt(document.getElementById('rowsInput').value);
            document.getElementById('rowsDisplay').innerText = rows;
            risk = document.getElementById('riskSelect').value;
            
            initPegs();
            renderMultipliersHTML();
            
            // Actualizar stats UI
            const vals = multipliers.map(m => m.val);
            document.getElementById('maxProfitDisplay').innerText = Math.max(...vals) + "x";
            document.getElementById('minChanceDisplay').innerText = multipliers[0].prob + "%";
        }

        function initPegs() {
            pegs = [];
            const startY = 80;
            // Ajuste dinámico de espacio
            const gap = canvas.width / (rows + 4); 
            
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c <= r; c++) {
                    const x = (canvas.width / 2) - (r * gap / 2) + (c * gap);
                    const y = startY + (r * 32); 
                    pegs.push({ x, y, r: 3 });
                }
            }
        }

        // Renderizado de Buckets con Hover Info
        function renderMultipliersHTML() {
            const container = document.getElementById('multipliersContainer');
            container.innerHTML = '';
            const data = getMultipliersValues();
            multipliers = data; // Update global state

            data.forEach((m, i) => {
                const div = document.createElement('div');
                div.className = 'mult-box';
                div.id = `bucket-${i}`;
                div.innerText = m.val + 'x';
                
                // Asignar color según valor
                let colors = colorSchemes.loss;
                if(m.val >= 1 && m.val < 3) colors = colorSchemes.low;
                if(m.val >= 3 && m.val < 10) colors = colorSchemes.win;
                if(m.val >= 10 && m.val < 50) colors = colorSchemes.big;
                if(m.val >= 50) colors = colorSchemes.jackpot;

                div.style.background = `linear-gradient(180deg, ${colors[0]}, ${colors[1]})`;
                // Opacidad en los extremos para foco visual
                if(m.val < 1) div.style.opacity = "0.7"; 
                
                // Eventos Hover
                div.onmouseenter = (e) => showTooltip(e, m.val, m.prob);
                div.onmouseleave = hideTooltip;

                container.appendChild(div);
            });
        }

        // Tooltip Logic
        function showTooltip(e, val, prob) {
            const tip = document.getElementById('hoverInfo');
            const bet = parseFloat(document.getElementById('betAmount').value);
            
            document.getElementById('hoverMultiplier').innerText = val + "x";
            document.getElementById('hoverProfit').innerText = (bet * val).toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('hoverChance').innerText = prob + "%";
            
            // Posicionar encima del elemento
            const rect = e.target.getBoundingClientRect();
            // Ajustar relativo al contenedor del juego
            const gameRect = document.querySelector('.game-area').getBoundingClientRect();
            
            tip.style.left = (rect.left - gameRect.left + rect.width/2) + "px";
            tip.style.top = (rect.top - gameRect.top - 10) + "px";
            tip.style.opacity = 1;
        }

        function hideTooltip() {
            document.getElementById('hoverInfo').style.opacity = 0;
        }

        // === GAMEPLAY ===
        function dropBall() {
            const betInput = document.getElementById('betAmount');
            const bet = parseFloat(betInput.value);

            if(bet <= 0 || isNaN(bet)) return;
            if(bet > userBalance) return Swal.fire({title:"Saldo Insuficiente", icon:"error", background:'#0f1621', color:'#fff'});

            userBalance -= bet;
            saveData();
            updateBalanceUI();

            // Determinar Path (RNG)
            let path = [];
            let currentIndex = 0;
            for(let i=0; i<rows; i++) {
                const goRight = Math.random() < 0.5; // 50/50 real en cada clavo
                path.push(goRight ? 1 : -1);
                if(goRight) currentIndex++;
            }

            balls.push({
                x: canvas.width / 2 + (Math.random() * 2 - 1), // Ligera variación inicial
                y: 30,
                radius: 5,
                active: true,
                path: path,
                currentRow: 0,
                targetIndex: currentIndex,
                bet: bet,
                vx: 0,
                vy: 0,
                trail: [] // Para efecto visual
            });
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dibujar Clavos (Glowing)
            ctx.fillStyle = "white";
            ctx.shadowBlur = 4;
            ctx.shadowColor = "rgba(255,255,255,0.5)";
            pegs.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.shadowBlur = 0;

            // Procesar Bolas
            const gap = canvas.width / (rows + 4);
            const startY = 80;

            balls.forEach(b => {
                if(!b.active) return;

                const targetRowY = startY + (b.currentRow * 32);

                // Física simple suavizada
                if(b.y < targetRowY) {
                    b.vy += 0.4;
                    b.y += b.vy;
                    b.x += b.vx;
                } else {
                    if(b.currentRow < rows) {
                        // Impacto
                        playAudio('sfx-plink', 0.2);
                        b.vy = -2.5; // Rebote
                        const dir = b.path[b.currentRow];
                        // Añadir ruido aleatorio pequeño para naturalidad
                        b.vx = (dir * (gap/12)) + (Math.random() * 0.4 - 0.2);
                        b.currentRow++;
                    } else {
                        finishBall(b);
                    }
                }

                // Dibujar Trail
                b.trail.push({x:b.x, y:b.y});
                if(b.trail.length > 10) b.trail.shift();
                
                ctx.beginPath();
                b.trail.forEach((p, i) => {
                    ctx.lineTo(p.x, p.y);
                    ctx.strokeStyle = `rgba(0, 255, 42, ${i/10})`;
                });
                ctx.stroke();

                // Dibujar Bola
                ctx.beginPath();
                ctx.fillStyle = "#00ff2a";
                ctx.shadowBlur = 10;
                ctx.shadowColor = "#00ff2a";
                ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            requestAnimationFrame(gameLoop);
        }

        function finishBall(b) {
            b.active = false;
            const m = multipliers[b.targetIndex];
            const win = b.bet * m.val;
            
            userBalance += win;
            saveData();
            updateBalanceUI();

            playAudio('sfx-win');

            // UI Anim
            const bucket = document.getElementById(`bucket-${b.targetIndex}`);
            if(bucket) {
                bucket.classList.remove('pop-anim');
                void bucket.offsetWidth;
                bucket.classList.add('pop-anim');
            }

            // Floating Text
            if(m.val >= 1) {
                const fs = document.getElementById('floatScore');
                fs.innerText = m.val + "x";
                // Posicionar cerca de donde cayó (aproximado)
                const bucketRect = bucket.getBoundingClientRect();
                const gameRect = document.querySelector('.game-area').getBoundingClientRect();
                fs.style.left = (bucketRect.left - gameRect.left) + "px";
                
                fs.style.opacity = 1;
                fs.style.transform = "translateY(-50px) scale(1.2)";
                setTimeout(() => {
                    fs.style.opacity = 0;
                    fs.style.transform = "translateY(0) scale(1)";
                }, 800);
            }
        }

        // === UTILS ===
        function updateBalanceUI() {
            document.getElementById('displayBalance').innerText = userBalance.toLocaleString('en-US', {maximumFractionDigits: 0});
        }
        function saveData() {
            const data = { user: username, balance: userBalance };
            localStorage.setItem('pepebet_user', JSON.stringify(data));
            localStorage.setItem('pbj_user_v2', JSON.stringify(data));
        }
        function doubleBet() { document.getElementById('betAmount').value *= 2; }
        function halfBet() { document.getElementById('betAmount').value /= 2; }
        function playAudio(id, vol = 0.5) { const el=document.getElementById(id); if(el){ const c=el.cloneNode(); c.volume=vol; c.play().catch(()=>{});}}
    </script>
</body>
</html>
