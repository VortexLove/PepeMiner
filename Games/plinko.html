<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plinko | PepeBlackJack</title>
    
    <!-- Librer√≠as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- TEMA GLOBAL (Igual a tu Index) --- */
        :root {
            --primary: #00ff2a;
            --bg-dark: #05080a;
            --bg-panel: #0b1016;
            --bg-card: #121924;
            --border-color: #1f2937;
        }

        body { 
            background-color: var(--bg-dark); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; /* Evita scroll doble */
        }

        .brand-font { font-family: 'Space Grotesk', sans-serif; }
        
        /* Sidebar y Layout */
        .glass-panel { background: rgba(11, 16, 22, 0.95); border-right: 1px solid rgba(255, 255, 255, 0.05); }
        .text-neon { color: var(--primary); text-shadow: 0 0 10px rgba(0, 255, 42, 0.4); }

        .btn-gradient {
            background: linear-gradient(135deg, #00ff2a 0%, #009919 100%);
            color: #000; font-weight: 800; letter-spacing: 0.5px;
            transition: 0.3s;
        }
        .btn-gradient:hover { box-shadow: 0 0 20px rgba(0, 255, 42, 0.4); transform: translateY(-2px); }

        /* --- ESTILOS ESPEC√çFICOS DE PLINKO --- */
        .main-layout {
            display: grid;
            grid-template-columns: 260px 1fr; /* Sidebar Fija | Contenido */
            height: 100vh;
        }

        .content-area {
            position: relative;
            overflow-y: auto;
            background: radial-gradient(circle at 50% 0%, #1a2530 0%, #05080a 60%);
            padding: 20px;
            padding-top: 90px; /* Espacio para el header flotante */
        }

        /* TARJETA DEL JUEGO */
        .game-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            overflow: hidden;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            min-height: 600px;
        }

        /* CONTROLES (Izquierda) */
        .controls-sidebar {
            background: #0e141b;
            padding: 24px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-box {
            background: #05080a;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex; align-items: center; padding: 4px;
        }
        .input-clean { background: transparent; color: white; border: none; width: 100%; padding: 10px; font-weight: bold; outline: none; }

        /* ESCENARIO (Derecha) */
        .game-stage {
            position: relative;
            background: #151d28;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            overflow: hidden;
        }

        /* MULTIPLICADORES */
        .multipliers-row {
            display: flex; gap: 5px; padding: 20px; z-index: 10;
            width: 100%; max-width: 800px; justify-content: center;
        }
        .mult-box {
            flex: 1; height: 35px; border-radius: 6px; font-size: 10px; font-weight: 800;
            display: flex; align-items: center; justify-content: center; color: #000;
            box-shadow: 0 4px 5px rgba(0,0,0,0.3); transition: 0.2s;
            border-bottom: 3px solid rgba(0,0,0,0.2);
        }
        .pop-anim { animation: pop 0.2s ease-out; }
        @keyframes pop { 50% { transform: scale(1.4); filter: brightness(2); } }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { display: none; } /* Ocultar sidebar en m√≥vil por ahora o usar bot√≥n toggle */
            .sidebar.active { display: flex; position: fixed; top: 0; left: 0; height: 100vh; z-index: 100; width: 260px; }
            .game-container { grid-template-columns: 1fr; display: flex; flex-direction: column-reverse; }
            .game-stage { height: 450px; }
            .controls-sidebar { border-right: none; border-top: 1px solid var(--border-color); }
            .content-area { padding: 10px; padding-top: 80px; }
        }
    </style>
</head>
<body>

    <!-- AUDIO -->
    <audio id="sfx-hit" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.mp3"></audio>

    <div class="main-layout">
        
        <!-- SIDEBAR (Navegaci√≥n) -->
        <div id="sidebar" class="sidebar glass-panel flex flex-col p-6 hidden lg:flex">
            <div class="flex items-center gap-3 mb-8 cursor-pointer" onclick="window.location.href='index.html'">
                <div class="w-10 h-10 rounded-xl bg-green-600 flex items-center justify-center text-2xl">üê∏</div>
                <div>
                    <h1 class="text-xl font-bold brand-font">Pepe<span class="text-neon">BJ</span></h1>
                </div>
            </div>

            <nav class="space-y-2">
                <a href="index.html" class="flex items-center gap-3 p-3 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white transition">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="#" class="flex items-center gap-3 p-3 rounded-lg bg-green-500/10 text-neon font-bold border-l-4 border-neon">
                    <i class="fas fa-caret-down"></i> Plinko
                </a>
                <a href="index.html" class="flex items-center gap-3 p-3 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white transition">
                    <i class="fas fa-heart"></i> Blackjack
                </a>
            </nav>

            <div class="mt-auto bg-[#05080a] p-4 rounded-xl border border-white/5">
                <p class="text-[10px] text-gray-500 uppercase font-bold">Your Balance</p>
                <div class="flex items-baseline gap-1">
                    <span class="text-xl font-bold text-white" id="sidebarBalance">0.00</span>
                    <span class="text-xs text-neon font-bold">PBJ</span>
                </div>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="relative w-full h-full overflow-hidden flex flex-col">
            
            <!-- HEADER FLOTANTE -->
            <header class="absolute top-0 left-0 right-0 h-20 flex items-center justify-between px-6 z-40 bg-opacity-90 backdrop-blur-md border-b border-white/5">
                <button onclick="toggleSidebar()" class="lg:hidden text-white text-xl"><i class="fas fa-bars"></i></button>
                
                <!-- Balance Central -->
                <div class="hidden md:flex items-center bg-black/40 border border-white/10 rounded-lg px-4 py-2 mx-auto">
                    <span class="text-sm font-bold text-white mr-2" id="headerBalance">0.00</span>
                    <span class="text-xs text-neon font-bold">PBJ</span>
                </div>

                <div class="flex items-center gap-4">
                    <div id="userDisplay" class="hidden flex items-center gap-3 bg-white/5 px-3 py-1.5 rounded-full border border-white/10">
                        <span class="text-sm font-bold" id="username">Player</span>
                        <img id="avatar" src="" class="w-8 h-8 rounded-full bg-black">
                    </div>
                    <button onclick="window.location.href='index.html'" class="btn-gradient px-4 py-2 rounded-lg text-xs font-bold shadow-lg">Lobby</button>
                </div>
            </header>

            <!-- AREA DE JUEGO (Con Scroll si es necesario) -->
            <div class="content-area custom-scrollbar">
                
                <div class="game-container">
                    
                    <!-- PANEL IZQUIERDO (CONTROLES) -->
                    <div class="controls-sidebar">
                        
                        <!-- Modo -->
                        <div class="flex bg-black/40 p-1 rounded-lg">
                            <button id="btnManual" class="flex-1 py-2 text-xs font-bold rounded bg-gray-700 text-white shadow" onclick="setMode('manual')">Manual</button>
                            <button id="btnAuto" class="flex-1 py-2 text-xs font-bold rounded text-gray-500 hover:text-white transition" onclick="setMode('auto')">Auto</button>
                        </div>

                        <!-- Apuesta -->
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-400 font-bold uppercase mb-1">
                                <span>Bet Amount</span>
                            </div>
                            <div class="input-box">
                                <input type="number" id="betInput" value="10" class="input-clean">
                                <div class="flex gap-1 pr-1">
                                    <button onclick="changeBet(0.5)" class="px-2 py-1 bg-[#1a2c38] hover:bg-[#263549] text-gray-400 text-[10px] rounded font-bold">¬Ω</button>
                                    <button onclick="changeBet(2)" class="px-2 py-1 bg-[#1a2c38] hover:bg-[#263549] text-gray-400 text-[10px] rounded font-bold">2x</button>
                                </div>
                            </div>
                        </div>

                        <!-- Configuraci√≥n -->
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase mb-1 block">Risk</label>
                            <select id="riskSelect" onchange="updateGame()" class="w-full bg-[#05080a] border border-white/10 text-white text-sm font-bold rounded-lg p-3 outline-none">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase mb-1 block">Rows: <span id="rowsVal">16</span></label>
                            <select id="rowsSelect" onchange="updateGame()" class="w-full bg-[#05080a] border border-white/10 text-white text-sm font-bold rounded-lg p-3 outline-none">
                                <option value="8">8 Rows</option>
                                <option value="12">12 Rows</option>
                                <option value="16" selected>16 Rows</option>
                            </select>
                        </div>

                        <button id="playBtn" class="btn-gradient w-full py-4 rounded-xl mt-auto text-lg uppercase shadow-lg" onclick="play()">BET</button>
                    </div>

                    <!-- PANEL DERECHO (CANVAS) -->
                    <div class="game-stage" id="stageContainer">
                        <!-- Historial Flotante -->
                        <div id="historyBar" class="absolute top-4 right-4 flex gap-1 z-20"></div>
                        
                        <!-- El Juego -->
                        <canvas id="gameCanvas"></canvas>
                        
                        <!-- Multiplicadores HTML -->
                        <div id="multipliersContainer" class="multipliers-row"></div>
                    </div>

                </div>

                <div class="text-center mt-6 text-xs text-gray-500">
                    Provably Fair System ‚Ä¢ Decentralized ‚Ä¢ 60 FPS
                </div>

            </div>
        </div>
    </div>

    <!-- SCRIPT DEL JUEGO -->
    <script>
        // CONFIGURACI√ìN Y ESTADO
        const STORAGE_KEY = 'pepeblackjack_v2';
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('stageContainer');
        
        let state = { balance: 1000, user: 'Guest', avatar: '' };
        let config = { rows: 16, risk: 'medium' };
        let balls = [], pegs = [], particles = [];
        let autoInterval = null;

        // TABLAS DE PAGOS (House Edge integrado)
        const PAYOUTS = {
            low: { 16: [16, 9, 2, 1.4, 1.4, 1.2, 1.1, 1, 0.5, 1, 1.1, 1.2, 1.4, 1.4, 2, 9, 16], 12: [10, 3, 1.6, 1.2, 1.1, 1, 0.5, 1, 1.1, 1.2, 1.6, 3, 10], 8: [5.6, 2.1, 1.1, 1, 0.5, 1, 1.1, 2.1, 5.6] },
            medium: { 16: [110, 41, 10, 5, 3, 1.5, 1, 0.5, 0.5, 1, 1.5, 3, 5, 10, 41, 110], 12: [33, 11, 4, 2, 1.1, 0.6, 0.3, 0.6, 1.1, 2, 4, 11, 33], 8: [13, 3, 1.3, 0.7, 0.4, 0.7, 1.3, 3, 13] },
            high: { 16: [1000, 130, 26, 9, 4, 2, 0.2, 0.2, 0.2, 0.2, 0.2, 2, 4, 9, 26, 130, 1000], 12: [170, 51, 14, 5, 2, 0.3, 0.2, 0.3, 2, 5, 14, 51, 170], 8: [29, 4, 1.5, 0.3, 0.2, 0.3, 1.5, 4, 29] }
        };

        // INICIALIZACI√ìN
        window.addEventListener('DOMContentLoaded', () => {
            loadState();
            updateGame();
            resizeCanvas();
            animate();
            window.addEventListener('resize', resizeCanvas);
        });

        function loadState() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if(stored) {
                const data = JSON.parse(stored);
                state.balance = data.balance || 1000;
                state.user = data.user || 'Guest';
                state.avatar = data.avatar || '';
                
                if(data.user) {
                    document.getElementById('userDisplay').classList.remove('hidden');
                    document.getElementById('username').innerText = state.user;
                    document.getElementById('avatar').src = state.avatar;
                }
            }
            updateBalanceUI();
        }

        function saveState() {
            // Solo actualizamos el balance en el storage local para sincronizar con el index
            const stored = localStorage.getItem(STORAGE_KEY);
            let data = stored ? JSON.parse(stored) : {};
            data.balance = state.balance;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            updateBalanceUI();
        }

        function updateBalanceUI() {
            const fmt = state.balance.toLocaleString('en-US', {maximumFractionDigits: 0});
            document.getElementById('sidebarBalance').innerText = fmt;
            document.getElementById('headerBalance').innerText = fmt;
        }

        // L√ìGICA DEL JUEGO
        function updateGame() {
            config.rows = parseInt(document.getElementById('rowsSelect').value);
            config.risk = document.getElementById('riskSelect').value;
            document.getElementById('rowsVal').innerText = config.rows;
            
            renderMultipliers();
            resizeCanvas(); // Recalcular pegs
        }

        function renderMultipliers() {
            const container = document.getElementById('multipliersContainer');
            container.innerHTML = '';
            const arr = PAYOUTS[config.risk][config.rows];
            
            arr.forEach((val, i) => {
                const el = document.createElement('div');
                el.className = 'mult-box';
                el.id = `mult-${i}`;
                el.innerText = val + 'x';
                
                // Colores
                let bg1='#374151', bg2='#1f2937';
                if(val >= 1) { bg1='#22c55e'; bg2='#15803d'; } // Verde
                if(val >= 10) { bg1='#eab308'; bg2='#a16207'; } // Oro
                if(val >= 100) { bg1='#ef4444'; bg2='#b91c1c'; } // Rojo
                if(val < 1) el.style.opacity = '0.7';

                el.style.background = `linear-gradient(180deg, ${bg1}, ${bg2})`;
                el.style.color = val >= 10 || val < 1 ? 'white' : 'black';
                
                container.appendChild(el);
            });
        }

        function resizeCanvas() {
            // Ajustar canvas al tama√±o real del contenedor
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height; // Usamos todo el alto, los multiplicadores flotan encima via CSS
            initPegs();
        }

        function initPegs() {
            pegs = [];
            const rows = config.rows;
            // Calcular geometr√≠a
            const startY = 40;
            // Espacio disponible vertical menos espacio para multiplicadores (aprox 60px)
            const availableH = canvas.height - startY - 60; 
            const gap = availableH / rows;
            
            config.gap = gap;
            config.finishY = startY + (rows * gap) + (gap/2);

            for(let r=0; r < rows; r++) {
                for(let c=0; c <= r; c++) {
                    pegs.push({
                        x: (canvas.width/2) - (r * gap / 2) + (c * gap),
                        y: startY + (r * gap),
                        r: 3,
                        glow: 0
                    });
                }
            }
        }

        // GAMEPLAY
        function play() {
            const bet = parseFloat(document.getElementById('betInput').value);
            if(isNaN(bet) || bet <= 0) return;
            if(state.balance < bet) {
                Swal.fire({toast:true, position:'top', icon:'error', title:'Insufficient Balance', background:'#121924', color:'#fff'});
                if(autoInterval) clearInterval(autoInterval);
                return;
            }

            state.balance -= bet;
            saveState();

            // L√≥gica Determinista (Bell Curve)
            const path = [];
            for(let i=0; i<config.rows; i++) {
                path.push(Math.random() < 0.5 ? -0.5 : 0.5); // Izq o Der
            }

            balls.push({
                x: canvas.width / 2,
                y: 20,
                vx: 0, vy: 0,
                path: path,
                row: 0,
                bet: bet,
                color: '#00ff2a'
            });
        }

        // ANIMATION LOOP
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dibujar Pegs
            pegs.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                if(p.glow > 0) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${p.glow})`;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = 'white';
                    p.glow -= 0.05;
                } else {
                    ctx.fillStyle = '#4b5563';
                    ctx.shadowBlur = 0;
                }
                ctx.fill();
            });
            ctx.shadowBlur = 0;

            // Dibujar Bolas
            for(let i = balls.length - 1; i >= 0; i--) {
                const b = balls[i];
                
                b.vy += 0.25; // Gravedad
                b.y += b.vy;
                b.x += b.vx;

                // Colisi√≥n (Simplificada por filas)
                const targetY = 40 + (b.row * config.gap);
                
                if(b.y > targetY - 5 && b.row < config.rows) {
                    // Choc√≥ con "fila invisible" de clavos
                    const dir = b.path[b.row];
                    
                    // Impulso lateral + Ruido
                    b.vx = (dir * 2) + (Math.random() - 0.5); 
                    b.vy *= 0.5; // Rebote amortiguado
                    b.row++;

                    // Iluminar clavo cercano (Efecto visual)
                    // Buscar clavo m√°s cercano a b.x en esta fila
                    // Optimizaci√≥n: sabemos la Y, buscamos X
                    const pegIndex = Math.floor(pegs.length * (b.y / canvas.height)); // Aprox
                    // B√∫squeda simple por distancia
                    const peg = pegs.find(p => Math.abs(p.y - b.y) < 15 && Math.abs(p.x - b.x) < 15);
                    if(peg) {
                        peg.glow = 1;
                        // Play sound clonado para permitir overlap
                        const sfx = document.getElementById('sfx-hit').cloneNode();
                        sfx.volume = 0.1;
                        sfx.play().catch(()=>{});
                    }
                }

                // Finalizar bola
                if(b.y > config.finishY) {
                    resolveBall(b, i);
                    continue;
                }

                // Render bola
                ctx.beginPath();
                ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
                ctx.fillStyle = b.color;
                ctx.shadowColor = b.color;
                ctx.shadowBlur = 10;
                ctx.fill();
            }

            requestAnimationFrame(animate);
        }

        function resolveBall(b, idx) {
            balls.splice(idx, 1);
            
            // Calcular donde cay√≥
            // Sumamos los movimientos a la derecha (0.5)
            const rightMoves = b.path.filter(m => m === 0.5).length;
            const multiplier = PAYOUTS[config.risk][config.rows][rightMoves];
            
            const win = b.bet * multiplier;
            state.balance += win;
            saveState();

            // Visuals
            const el = document.getElementById(`mult-${rightMoves}`);
            if(el) {
                el.classList.remove('pop-anim');
                void el.offsetWidth; // Trigger reflow
                el.classList.add('pop-anim');
            }

            // Historial
            const hist = document.getElementById('historyBar');
            const pill = document.createElement('div');
            pill.className = "w-8 h-6 rounded flex items-center justify-center text-[9px] font-bold shadow animate-bounce";
            pill.innerText = multiplier + "x";
            pill.style.background = multiplier >= 1 ? (multiplier >= 10 ? '#eab308' : '#22c55e') : '#374151';
            pill.style.color = multiplier >= 1 ? 'black' : 'white';
            hist.prepend(pill);
            if(hist.children.length > 5) hist.removeChild(hist.lastChild);

            if(multiplier >= 10) document.getElementById('sfx-win').play();
        }

        // UTILIDADES
        function changeBet(m) {
            const input = document.getElementById('betInput');
            let val = parseFloat(input.value) * m;
            if(val < 1) val = 1;
            input.value = val.toFixed(0);
        }

        function setMode(m) {
            const btnA = document.getElementById('btnAuto');
            const btnM = document.getElementById('btnManual');
            const playBtn = document.getElementById('playBtn');
            
            if(m === 'auto') {
                btnA.className = "flex-1 py-2 text-xs font-bold rounded bg-green-500 text-black shadow transition";
                btnM.className = "flex-1 py-2 text-xs font-bold rounded text-gray-500 hover:text-white transition";
                playBtn.innerText = "START AUTO";
                playBtn.onclick = toggleAuto;
            } else {
                btnM.className = "flex-1 py-2 text-xs font-bold rounded bg-gray-700 text-white shadow transition";
                btnA.className = "flex-1 py-2 text-xs font-bold rounded text-gray-500 hover:text-white transition";
                playBtn.innerText = "BET";
                playBtn.onclick = play;
                if(autoInterval) clearInterval(autoInterval);
                playBtn.classList.remove('bg-red-600');
            }
        }

        function toggleAuto() {
            const btn = document.getElementById('playBtn');
            if(autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
                btn.innerText = "START AUTO";
                btn.classList.remove('bg-red-600');
            } else {
                autoInterval = setInterval(play, 200);
                btn.innerText = "STOP AUTO";
                btn.classList.add('bg-red-600');
            }
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('hidden');
            sb.classList.toggle('active');
        }
    </script>
</body>
</html>
