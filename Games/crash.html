<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crash | PepeBlackJack</title>
    
    <!-- Librer铆as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #00ff2a; --bg-dark: #070b10; --border: rgba(255,255,255,0.1); }
        body { background: var(--bg-dark); color: white; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        .glass-panel { background: rgba(15, 22, 33, 0.9); backdrop-filter: blur(10px); border-right: 1px solid var(--border); }
        .input-slot { background: #0b1018; border: 1px solid var(--border); color: white; transition: 0.3s; }
        .input-slot:focus { border-color: var(--primary); outline: none; }
        
        .btn-neon { background: linear-gradient(180deg, #00ff2a 0%, #00cc22 100%); color: #000; font-weight: 800; border: none; transition: 0.2s; }
        .btn-neon:hover { transform: translateY(-2px); box-shadow: 0 0 25px rgba(0, 255, 42, 0.4); }
        
        .btn-action { width: 100%; padding: 1rem; border-radius: 0.75rem; font-weight: 800; font-size: 1.1rem; transition: 0.2s; }
        .btn-cashout { background: #fbbf24; color: black; box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
        .btn-cashout:hover { background: #f59e0b; transform: translateY(-2px); }

        .game-wrapper { display: flex; height: 100vh; }
        .sidebar { width: 320px; flex-shrink: 0; padding: 24px; display: flex; flex-direction: column; gap: 20px; z-index: 10; }
        .game-area { flex: 1; position: relative; background: radial-gradient(circle at bottom left, #131b29 0%, #070b10 100%); overflow: hidden; display: flex; flex-direction: column; }
        
        /* Historial */
        .history-bar { height: 40px; display: flex; align-items: center; gap: 8px; padding: 0 20px; overflow: hidden; mask-image: linear-gradient(to right, transparent, black 10%); }
        .badge-mult { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; min-width: 40px; text-align: center; }
        
        @media(max-width:1024px){ .game-wrapper{flex-direction:column-reverse;overflow-y:auto} .sidebar{width:100%;height:auto} .game-area{min-height:500px} }
    </style>
</head>
<body>
    <audio id="sfx-tick" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sfx-crash" src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.mp3"></audio>

    <div class="game-wrapper">
        <!-- SIDEBAR -->
        <div class="sidebar glass-panel">
            <div class="flex justify-between items-center mb-4">
                <a href="../index.html" class="flex items-center gap-2 text-gray-400 hover:text-white"><i class="fas fa-chevron-left"></i> Volver</a>
                <div class="bg-black/40 px-3 py-1 rounded-full border border-white/5 font-mono font-bold"><span id="displayBalance">0.00</span> PBJ</div>
            </div>

            <!-- Bet Input -->
            <div class="bg-[#0b1018] p-4 rounded-xl border border-white/5">
                <label class="text-[10px] font-bold text-gray-500 block mb-2">APUESTA</label>
                <div class="relative">
                    <input type="number" id="betAmount" value="100" class="w-full p-3 input-slot rounded-lg font-bold text-sm">
                    <div class="absolute right-1 top-1 bottom-1 flex gap-1">
                        <button onclick="multBet(0.5)" class="bg-[#1a2c38] px-2 rounded text-[10px] text-gray-400 font-bold">陆</button>
                        <button onclick="multBet(2)" class="bg-[#1a2c38] px-2 rounded text-[10px] text-gray-400 font-bold">2x</button>
                    </div>
                </div>
            </div>

            <!-- Auto Cashout (Visual por ahora) -->
            <div class="bg-[#0b1018] p-4 rounded-xl border border-white/5">
                <label class="text-[10px] font-bold text-gray-500 block mb-2">AUTO CASHOUT (x)</label>
                <input type="number" id="autoCashout" value="2.00" class="w-full p-3 input-slot rounded-lg font-bold text-sm">
            </div>

            <!-- Botones de Estado -->
            <div class="mt-auto">
                <button onclick="placeBet()" id="btnBet" class="btn-neon btn-action shadow-lg">APOSTAR</button>
                <button onclick="cashOut()" id="btnCashout" class="btn-cashout btn-action hidden">RETIRAR (<span id="cashoutProfit">0</span>)</button>
                <button id="btnWaiting" class="bg-gray-700 text-gray-400 btn-action hidden cursor-not-allowed">ESPERANDO...</button>
            </div>
        </div>

        <!-- GAME AREA -->
        <div class="game-area">
            <!-- Historial Superior -->
            <div class="history-bar absolute top-4 left-0 right-0 z-20" id="crashHistory">
                <!-- Se llenar谩 con JS -->
            </div>

            <!-- Informaci贸n Central -->
            <div class="absolute inset-0 flex flex-col items-center justify-center z-10 pointer-events-none">
                <div id="multiplierDisplay" class="text-8xl font-black text-white drop-shadow-[0_0_30px_rgba(255,255,255,0.2)] font-mono">1.00x</div>
                <div id="statusMessage" class="text-sm font-bold text-gray-400 mt-4 tracking-widest uppercase">Pr贸xima Ronda en 5s</div>
            </div>

            <canvas id="crashCanvas" class="w-full h-full"></canvas>
        </div>
    </div>

    <!-- LGICA -->
    <script>
        const canvas = document.getElementById('crashCanvas');
        const ctx = canvas.getContext('2d');
        let userBalance = 0, username = null;
        
        // Variables de Juego
        let gameState = 'IDLE'; // IDLE, BETTING, RUNNING, CRASHED
        let currentMultiplier = 1.00;
        let crashPoint = 0;
        let speed = 0;
        let animationId;
        let userBet = 0;
        let userCashedOut = false;
        
        // Configuraci贸n Visual
        let graphPoints = [];
        let canvasWidth, canvasHeight;

        // INIT
        window.onload = () => {
            const u = localStorage.getItem('pbj_username');
            if(u) {
                fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u}) })
                .then(r=>r.json()).then(d => { userBalance=d.balance; username=d.username; updateUI(); });
            } else { window.location.href = '../index.html'; }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            generateHistory(); // Falso historial inicial
            gameLoop(); // Loop de renderizado
        };

        // --- CORE GAME LOOP ---
        
        function startGame() {
            if(userBet > 0) {
                // Descontar apuesta del servidor
                updateServerBalance(-userBet);
                document.getElementById('btnBet').classList.add('hidden');
                document.getElementById('btnCashout').classList.remove('hidden');
                document.getElementById('btnWaiting').classList.add('hidden');
            }

            gameState = 'RUNNING';
            currentMultiplier = 1.00;
            speed = 0.005; // Velocidad inicial
            userCashedOut = false;
            graphPoints = [{x: 0, y: canvasHeight}]; // Reiniciar gr谩fica
            
            // Determinar punto de Crash (Algoritmo Justo Simulado)
            // F贸rmula est谩ndar: E = 100 / (random * 100 + 1) * (1 - houseEdge)
            // Aqu铆 simplificado:
            crashPoint = (Math.floor(Math.random() * 100) === 0) ? 1.00 : parseFloat((100 / (Math.random() * 100 + 1)).toFixed(2)); 
            if(crashPoint < 1.00) crashPoint = 1.00; 
            
            document.getElementById('statusMessage').innerText = "EN VIVO";
            document.getElementById('multiplierDisplay').classList.remove('text-red-500');
            document.getElementById('multiplierDisplay').classList.add('text-white');
            
            runGameTick();
        }

        function runGameTick() {
            if(gameState !== 'RUNNING') return;

            // Incrementar Multiplicador (Exponencial)
            currentMultiplier += speed;
            speed *= 1.005; // Aceleraci贸n

            document.getElementById('multiplierDisplay').innerText = currentMultiplier.toFixed(2) + "x";
            
            // Actualizar bot贸n de retiro
            if(userBet > 0 && !userCashedOut) {
                document.getElementById('cashoutProfit').innerText = (userBet * currentMultiplier).toFixed(2);
            }

            // Chequear Crash
            if(currentMultiplier >= crashPoint) {
                crash();
            } else {
                animationId = requestAnimationFrame(runGameTick);
            }
        }

        function crash() {
            gameState = 'CRASHED';
            cancelAnimationFrame(animationId);
            document.getElementById('multiplierDisplay').innerText = crashPoint.toFixed(2) + "x";
            document.getElementById('multiplierDisplay').classList.remove('text-white');
            document.getElementById('multiplierDisplay').classList.add('text-red-500');
            document.getElementById('statusMessage').innerText = "CRASHED";
            
            document.getElementById('sfx-crash').play();
            
            // Resetear UI de botones
            document.getElementById('btnCashout').classList.add('hidden');
            if(userBet > 0 && !userCashedOut) {
                // Perdi贸
                userBet = 0; 
                document.getElementById('btnBet').classList.remove('hidden');
            } else if (userCashedOut) {
                // Ya gan贸, bot贸n listo para siguiente ronda
                document.getElementById('btnBet').classList.remove('hidden');
                document.getElementById('btnWaiting').classList.add('hidden');
            } else {
                // No apost贸
                document.getElementById('btnBet').classList.remove('hidden');
            }

            addToHistory(crashPoint);
            
            // Auto Restart
            let countdown = 5;
            const timer = setInterval(() => {
                document.getElementById('statusMessage').innerText = `Pr贸xima Ronda en ${countdown}s`;
                countdown--;
                if(countdown < 0) {
                    clearInterval(timer);
                    if(userBet > 0) { 
                        // Si el usuario puls贸 apostar durante el tiempo de espera
                        startGame(); 
                    } else {
                        // Esperar a que apueste o arrancar sin 茅l (simulado)
                        startGame(); // En realidad arranca siempre
                    }
                }
            }, 1000);
        }

        // --- PLAYER ACTIONS ---

        function placeBet() {
            const amount = parseFloat(document.getElementById('betAmount').value);
            if(amount > userBalance) return Swal.fire({title:"Saldo Insuficiente", icon:"error"});
            if(amount <= 0) return;

            if(gameState === 'RUNNING') {
                // Si ya est谩 corriendo, encolar para la siguiente
                userBet = amount;
                document.getElementById('btnBet').classList.add('hidden');
                document.getElementById('btnWaiting').classList.remove('hidden');
                Swal.fire({toast:true, position:'top-end', icon:'info', title:'Apuesta para la sig. ronda', timer:1500, showConfirmButton:false});
            } else {
                userBet = amount;
                // Bloquear bot贸n visualmente hasta que arranque
                document.getElementById('btnBet').innerText = "APOSTADO";
                document.getElementById('btnBet').classList.add('opacity-50');
            }
        }

        async function cashOut() {
            if(gameState !== 'RUNNING' || userCashedOut) return;
            
            userCashedOut = true;
            const winAmount = userBet * currentMultiplier;
            const profit = winAmount - userBet; // Solo profit para mostrar, pero sumamos todo al balance
            
            // Pagar en servidor
            await updateServerBalance(winAmount); // Devolvemos apuesta + ganancia (porque ya descontamos la apuesta al inicio)
            
            document.getElementById('sfx-win').play();
            document.getElementById('btnCashout').classList.add('hidden');
            document.getElementById('btnWaiting').classList.remove('hidden');
            document.getElementById('btnWaiting').innerText = "GANADO: " + winAmount.toFixed(0);
            document.getElementById('btnWaiting').classList.add('bg-green-600', 'text-white');
            
            // Reset bot贸n waiting styles despues del crash
            setTimeout(() => {
                userBet = 0; // Limpiar apuesta
            }, 100);
        }

        // --- CANVAS DRAWING ---
        function render() {
            if(gameState !== 'RUNNING' && gameState !== 'CRASHED') {
                requestAnimationFrame(render);
                return;
            }

            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // Dibujar Grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let i=0; i<canvasWidth; i+=50) { ctx.moveTo(i,0); ctx.lineTo(i,canvasHeight); }
            for(let i=0; i<canvasHeight; i+=50) { ctx.moveTo(0,i); ctx.lineTo(canvasWidth,i); }
            ctx.stroke();

            // Dibujar Curva
            // Mapear tiempo (X) y Multiplicador (Y) al canvas
            // Simple visualizaci贸n: una curva Bezier que crece
            
            const progress = Math.min(1, (currentMultiplier - 1) / 10); // Escala visual hasta 10x
            const endX = canvasWidth * 0.8; 
            const endY = canvasHeight * 0.8;
            
            const currentX = progress * endX;
            const currentY = canvasHeight - (progress * endY);

            ctx.beginPath();
            ctx.moveTo(0, canvasHeight);
            ctx.quadraticCurveTo(currentX / 2, canvasHeight, currentX, currentY);
            
            ctx.strokeStyle = gameState === 'CRASHED' ? '#ef4444' : '#00ff2a';
            ctx.lineWidth = 4;
            ctx.stroke();
            
            // Relleno
            ctx.lineTo(currentX, canvasHeight);
            ctx.fillStyle = gameState === 'CRASHED' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(0, 255, 42, 0.1)';
            ctx.fill();

            // Cohete / Punto
            ctx.save();
            ctx.translate(currentX, currentY);
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(0, 0, 6, 0, Math.PI*2);
            ctx.fill();
            
            // Texto Cohete
            ctx.font = "20px Arial";
            ctx.fillText("", -10, -10);
            ctx.restore();

            requestAnimationFrame(render);
        }
        render(); // Iniciar loop gr谩fico

        // --- UTILS ---
        async function updateServerBalance(amount) {
            const res = await fetch('/api/update', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username, amount})});
            const d = await res.json();
            if(d.success) { userBalance = d.newBalance; updateBalanceUI(); }
        }
        function updateBalanceUI() { 
            document.getElementById('displayBalance').innerText = userBalance.toFixed(2); 
            // Restaurar bot贸n de apostar si se resete贸
            const btn = document.getElementById('btnBet');
            if(btn.innerText === "APOSTADO" && gameState === 'IDLE') {
                btn.innerText = "APOSTAR";
                btn.classList.remove('opacity-50');
            }
        }
        function multBet(m) { document.getElementById('betAmount').value *= m; }
        function resizeCanvas() {
            canvas.width = document.querySelector('.game-area').offsetWidth;
            canvas.height = document.querySelector('.game-area').offsetHeight;
            canvasWidth = canvas.width;
            canvasHeight = canvas.height;
        }
        
        function generateHistory() {
            const hist = document.getElementById('crashHistory');
            for(let i=0; i<10; i++) {
                let r = (Math.random() * 10 + 1).toFixed(2);
                addToHistory(r);
            }
        }
        
        function addToHistory(val) {
            const hist = document.getElementById('crashHistory');
            const div = document.createElement('div');
            div.className = `badge-mult ${val >= 2 ? 'bg-green-500/20 text-green-400' : 'bg-gray-700/50 text-gray-400'}`;
            div.innerText = val + 'x';
            hist.prepend(div);
            if(hist.children.length > 15) hist.removeChild(hist.lastChild);
        }
    </script>
</body>
</html>
