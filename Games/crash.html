<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crash | PepeBlackJack</title>
    
    <!-- Librer√≠as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- TEM√ÅTICA GLOBAL --- */
        :root {
            --primary: #00ff2a;
            --primary-glow: rgba(0, 255, 42, 0.5);
            --bg-dark: #05080a;
            --bg-panel: #0b1016;
            --bg-card: #121924;
            --border-color: #1f2937;
        }

        body { 
            background-color: var(--bg-dark); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
        }

        h1, .brand-font { font-family: 'Space Grotesk', sans-serif; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }

        /* UI Elements */
        .glass-panel {
            background: rgba(18, 25, 36, 0.85);
            backdrop-filter: blur(16px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .text-neon { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }

        .btn-gradient {
            background: linear-gradient(135deg, #00ff2a 0%, #009919 100%);
            color: #000; font-weight: 800; letter-spacing: 0.5px;
            transition: all 0.3s;
        }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 0 25px var(--primary-glow); }

        /* GAME LAYOUT */
        .game-container-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
            max-width: 1200px;
            margin: 0 auto;
            height: calc(100vh - 140px);
        }

        .game-controls-panel {
            background: var(--bg-panel);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .game-stage-panel {
            background: radial-gradient(circle at bottom left, #1a2332 0%, #070b10 100%);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .input-slot {
            background: #05080a;
            border: 1px solid var(--border-color);
            color: white;
            transition: 0.3s;
        }
        .input-slot:focus { border-color: var(--primary); outline: none; }

        /* Historial en el Canvas */
        .history-bar { 
            position: absolute; top: 15px; right: 15px; left: 15px; height: 30px; 
            display: flex; justify-content: flex-end; gap: 6px; 
            z-index: 10; overflow: hidden; 
            mask-image: linear-gradient(to right, transparent, black 10%);
        }
        .badge-mult { 
            padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: bold; 
            min-width: 50px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            font-family: 'Space Grotesk', sans-serif;
        }

        /* Bot√≥n Cashout Especial */
        .btn-cashout {
            background: #fbbf24; color: black;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
            transition: all 0.1s;
        }
        .btn-cashout:hover { transform: scale(1.02); box-shadow: 0 0 30px rgba(251, 191, 36, 0.5); }
        .btn-cashout:active { transform: scale(0.98); }

        @media (min-width: 1024px) {
            .sidebar { width: 260px; position: fixed; height: 100vh; top: 0; left: 0; z-index: 50; border-right: 1px solid var(--border-color); }
            .main-content { margin-left: 260px; }
        }
        @media (max-width: 1023px) {
            .sidebar { transform: translateX(-100%); transition: 0.3s; position: fixed; height: 100vh; z-index: 60; top: 0; left: 0; width: 260px; }
            .sidebar.open { transform: translateX(0); }
            .game-container-grid { grid-template-columns: 1fr; height: auto; }
            .game-stage-panel { height: 500px; }
        }
        
        .level-progress { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="antialiased">

    <!-- AUDIO -->
    <audio id="sfx-tick" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sfx-crash" src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.mp3"></audio>
    <audio id="sfx-levelup" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>

    <!-- GLOBAL SIDEBAR -->
    <div id="sidebar" class="sidebar bg-panel glass-panel flex flex-col p-5 pt-16 lg:pt-6">
        <div class="flex items-center gap-3 mb-8 px-2 cursor-pointer group" onclick="window.location.href='../index.html'">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-green-800 flex items-center justify-center text-2xl shadow-[0_0_20px_rgba(0,255,42,0.3)]">üê∏</div>
            <div>
                <h1 class="text-xl font-bold tracking-wider brand-font text-white leading-none">Pepe<span class="text-neon">BJ</span></h1>
                <span class="text-[9px] text-gray-500 uppercase tracking-widest">Web3 Casino</span>
            </div>
        </div>

        <nav class="flex-1 space-y-1 overflow-y-auto pr-2 custom-scrollbar">
            <p class="px-3 text-[10px] font-bold text-gray-500 uppercase tracking-widest mt-4 mb-2">Platform</p>
            <a href="../index.html" class="w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 text-white font-medium transition"><i class="fas fa-home text-blue-400"></i> Home</a>
            
            <p class="px-3 text-[10px] font-bold text-gray-500 uppercase tracking-widest mt-6 mb-2">Games</p>
            <a href="blackjack.html" class="w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white transition"><i class="fas fa-heart text-red-500"></i> BlackJack</a>
            <a href="plinko.html" class="w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white transition"><i class="fas fa-caret-down text-pink-500"></i> Plinko</a>
            <a href="#" class="w-full text-left flex items-center gap-3 p-3 rounded-lg bg-white/5 text-neon font-bold transition border-l-4 border-neon"><i class="fas fa-rocket"></i> Crash</a>
        </nav>

        <div class="mt-4 bg-[#05080a] p-4 rounded-xl border border-white/5">
            <div class="flex justify-between items-end mb-2"><span class="text-[10px] text-gray-400 uppercase font-bold">Casino Balance</span></div>
            <div class="flex items-baseline gap-1">
                <h3 class="text-2xl font-bold text-white tracking-tight brand-font" id="sidebarBalance">0.00</h3>
                <span class="text-xs font-bold text-neon">PBJ</span>
            </div>
        </div>
    </div>

    <button onclick="toggleSidebar()" class="lg:hidden fixed top-4 left-4 z-50 bg-panel p-3 rounded-xl border border-white/10 text-white shadow-lg"><i class="fas fa-bars"></i></button>

    <!-- MAIN CONTENT -->
    <div class="main-content pt-24 min-h-screen pb-10 px-4 md:px-8">
        
        <!-- HEADER -->
        <header class="fixed top-0 left-0 lg:left-[260px] right-0 h-20 bg-bg-dark/90 backdrop-blur-md z-40 flex justify-between items-center px-6 border-b border-white/5">
            <div class="flex items-center gap-2">
                <h2 class="text-xl font-bold text-white brand-font">CRASH</h2>
                <span class="bg-blue-500/20 text-blue-400 text-[10px] font-bold px-2 py-0.5 rounded border border-blue-500/30">LIVE</span>
            </div>
            
            <div class="flex gap-4 items-center ml-auto">
                <div id="userInfo" class="hidden flex items-center gap-4 bg-white/5 px-4 py-2 rounded-xl border border-white/10 cursor-pointer hover:bg-white/10 transition">
                    <div class="text-right hidden sm:block">
                        <div class="flex items-center gap-2 justify-end">
                            <span class="text-sm font-bold text-white" id="userNameDisplay">User</span>
                            <span class="text-[9px] bg-yellow-500/20 text-yellow-400 border border-yellow-500/50 font-bold px-2 py-0.5 rounded" id="userRank">Novato</span>
                        </div>
                        <div class="w-32 h-1.5 bg-gray-800 rounded-full mt-1.5 overflow-hidden relative">
                            <div id="xpBar" class="bg-neon h-full w-[0%] level-progress shadow-[0_0_10px_#00ff2a]"></div>
                        </div>
                    </div>
                    <img id="headerAvatar" src="" class="w-10 h-10 rounded-full border-2 border-white/10 bg-black">
                </div>
            </div>
        </header>

        <!-- GAME LAYOUT GRID -->
        <div class="game-container-grid animate-fade-in">
            
            <!-- CONTROLES (IZQUIERDA) -->
            <div class="game-controls-panel">
                <!-- Apuesta -->
                <div class="bg-[#05080a] p-4 rounded-xl border border-white/5">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Bet Amount</label>
                        <span class="text-[10px] text-gray-600">Max: 10000</span>
                    </div>
                    <div class="relative">
                        <input type="number" id="betAmount" value="100" class="w-full p-3 input-slot rounded-lg font-bold text-sm">
                        <div class="absolute right-1 top-1 bottom-1 flex gap-1">
                            <button onclick="changeBet(0.5)" class="bg-[#1a2c38] hover:bg-[#263549] text-gray-400 text-[10px] font-bold px-2 rounded transition">¬Ω</button>
                            <button onclick="changeBet(2)" class="bg-[#1a2c38] hover:bg-[#263549] text-gray-400 text-[10px] font-bold px-2 rounded transition">2x</button>
                        </div>
                    </div>
                </div>

                <!-- Auto Cashout -->
                <div class="bg-[#05080a] p-4 rounded-xl border border-white/5">
                    <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Auto Cashout (x)</label>
                    <input type="number" id="autoCashout" value="2.00" step="0.10" class="w-full p-3 input-slot rounded-lg font-bold text-sm">
                </div>

                <!-- Botones Acci√≥n -->
                <div class="mt-auto">
                    <button onclick="placeBet()" id="btnBet" class="btn-gradient w-full py-4 rounded-xl text-lg font-bold shadow-lg relative group overflow-hidden">
                        <span class="relative z-10">BET</span>
                    </button>
                    
                    <button onclick="cashOut()" id="btnCashout" class="btn-cashout w-full py-4 rounded-xl text-xl font-black shadow-lg hidden relative overflow-hidden">
                        CASHOUT <br>
                        <span id="cashoutProfit" class="text-sm font-medium opacity-80">0.00 PBJ</span>
                    </button>
                    
                    <button id="btnWaiting" class="bg-gray-700 text-gray-400 w-full py-4 rounded-xl font-bold hidden cursor-not-allowed border border-white/5">
                        GAME IN PROGRESS
                    </button>
                </div>
            </div>

            <!-- PANTALLA DE JUEGO (DERECHA) -->
            <div class="game-stage-panel">
                <!-- Historial -->
                <div class="history-bar" id="crashHistory">
                    <!-- JS Generado -->
                </div>

                <!-- Multiplicador Central -->
                <div class="absolute inset-0 flex flex-col items-center justify-center z-10 pointer-events-none">
                    <div id="multiplierDisplay" class="text-8xl font-black text-white drop-shadow-[0_0_40px_rgba(0,0,0,0.6)] font-mono tracking-tighter transition-colors duration-100">1.00x</div>
                    <div id="statusMessage" class="text-xs font-bold text-gray-400 mt-6 tracking-[0.3em] uppercase bg-black/40 px-4 py-1 rounded-full backdrop-blur-sm border border-white/5">Connecting...</div>
                </div>

                <!-- Canvas -->
                <canvas id="crashCanvas" class="w-full h-full"></canvas>
            </div>

        </div>

        <!-- FOOTER INFO -->
        <div class="max-w-[1200px] mx-auto mt-8 text-center">
            <p class="text-[10px] text-gray-600 uppercase tracking-widest"><i class="fas fa-shield-alt"></i> Provably Fair & Decentralized</p>
        </div>

    </div>

    <!-- L√ìGICA -->
    <script>
        const STORAGE_KEY = 'pepeblackjack_v2'; // LLAVE COMPARTIDA
        const canvas = document.getElementById('crashCanvas');
        const ctx = canvas.getContext('2d');
        
        // STATE
        let state = { user: null, balance: 0, xp: 0, level: 1, avatar: '' };
        
        // GAME VARS
        let gameState = 'IDLE'; 
        let currentMultiplier = 1.00;
        let crashPoint = 0;
        let speed = 0;
        let animationId;
        let userBet = 0;
        let userCashedOut = false;
        let canvasWidth, canvasHeight;

        window.onload = () => {
            const stored = localStorage.getItem(STORAGE_KEY);
            if(stored) {
                state = { ...state, ...JSON.parse(stored) };
                updateUI();
                document.getElementById('userInfo').classList.remove('hidden');
            } else {
                window.location.href = '../index.html';
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            generateHistory();
            
            // Auto start
            setTimeout(startGame, 1000);
            render();
        };

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            updateUI();
        }

        // --- UI UPDATE ---
        function updateUI() {
            const fmt = state.balance.toLocaleString('en-US', {maximumFractionDigits: 0});
            document.getElementById('sidebarBalance').innerText = fmt;
            document.getElementById('userNameDisplay').innerText = state.user;
            document.getElementById('headerAvatar').src = state.avatar;
            document.getElementById('userLevel').innerText = state.level;
            document.getElementById('userRank').innerText = state.level < 5 ? "Noob" : "Degen";
            
            const xpNext = state.level * 100;
            document.getElementById('xpBar').style.width = ((state.xp / xpNext) * 100) + "%";
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        // --- CORE GAME LOOP ---
        function startGame() {
            if(userBet > 0) {
                state.balance -= userBet;
                state.xp += (userBet / 10); // XP per bet
                saveData();
                document.getElementById('btnBet').classList.add('hidden');
                document.getElementById('btnCashout').classList.remove('hidden');
                document.getElementById('btnWaiting').classList.add('hidden');
            }

            gameState = 'RUNNING';
            currentMultiplier = 1.00;
            speed = 0.006; 
            userCashedOut = false;
            
            // Crash Algorithm
            crashPoint = (Math.floor(Math.random() * 33) === 0) ? 1.00 : parseFloat((100 / (Math.random() * 100 + 1)).toFixed(2)); 
            if(crashPoint < 1.00) crashPoint = 1.00; 
            
            document.getElementById('statusMessage').innerText = "LIVE ROUND";
            const display = document.getElementById('multiplierDisplay');
            display.classList.remove('text-red-500');
            display.classList.add('text-white');
            
            runGameTick();
        }

        function runGameTick() {
            if(gameState !== 'RUNNING') return;

            currentMultiplier += speed;
            speed *= 1.003; 

            document.getElementById('multiplierDisplay').innerText = currentMultiplier.toFixed(2) + "x";
            
            // Auto Cashout
            const auto = parseFloat(document.getElementById('autoCashout').value);
            if(userBet > 0 && !userCashedOut && auto > 1.0 && currentMultiplier >= auto) {
                cashOut();
            }

            if(userBet > 0 && !userCashedOut) {
                document.getElementById('cashoutProfit').innerText = (userBet * currentMultiplier).toLocaleString('en-US', {maximumFractionDigits:0}) + " PBJ";
            }

            if(currentMultiplier >= crashPoint) {
                crash();
            } else {
                animationId = requestAnimationFrame(runGameTick);
            }
        }

        function crash() {
            gameState = 'CRASHED';
            cancelAnimationFrame(animationId);
            const display = document.getElementById('multiplierDisplay');
            display.innerText = crashPoint.toFixed(2) + "x";
            display.classList.remove('text-white');
            display.classList.add('text-red-500');
            
            document.getElementById('statusMessage').innerText = "CRASHED";
            document.getElementById('sfx-crash').play();
            
            document.getElementById('btnCashout').classList.add('hidden');
            document.getElementById('btnBet').classList.remove('hidden');
            
            if(userBet > 0 && !userCashedOut) {
                userBet = 0; // Lost
                const btn = document.getElementById('btnBet');
                btn.innerHTML = '<span class="relative z-10">BET</span>';
                btn.classList.remove('opacity-50');
            } else if (userCashedOut) {
                document.getElementById('btnWaiting').classList.add('hidden');
                const btn = document.getElementById('btnBet');
                btn.innerHTML = '<span class="relative z-10">BET</span>';
                btn.classList.remove('opacity-50');
            }

            addToHistory(crashPoint);
            
            // Countdown
            let countdown = 4;
            const timer = setInterval(() => {
                document.getElementById('statusMessage').innerText = `NEXT ROUND IN ${countdown}s`;
                countdown--;
                if(countdown < 0) {
                    clearInterval(timer);
                    startGame();
                }
            }, 1000);
        }

        // --- PLAYER ACTIONS ---
        function placeBet() {
            const amount = parseFloat(document.getElementById('betAmount').value);
            if(amount > state.balance) return Swal.fire({title:"Insufficient Balance", icon:"error", background:'#121924', color:'#fff'});
            if(amount <= 0) return;

            userBet = amount;
            if(gameState === 'RUNNING') {
                document.getElementById('btnBet').classList.add('hidden');
                document.getElementById('btnWaiting').classList.remove('hidden');
                document.getElementById('btnWaiting').innerText = "BET QUEUED...";
                document.getElementById('btnWaiting').classList.remove('bg-green-600', 'text-white');
            } else {
                document.getElementById('btnBet').innerText = "BET PLACED";
                document.getElementById('btnBet').classList.add('opacity-50');
            }
        }

        function cashOut() {
            if(gameState !== 'RUNNING' || userCashedOut) return;
            userCashedOut = true;
            const winAmount = userBet * currentMultiplier;
            
            state.balance += winAmount;
            
            // Level Up Check
            const xpNext = state.level * 100;
            if(state.xp >= xpNext) {
                state.level++; state.xp -= xpNext;
                document.getElementById('sfx-levelup').play();
                Swal.fire({title: 'LEVEL UP!', text: `Level ${state.level}`, icon: 'success', background: '#121924', color: '#fff'});
            }
            saveData();
            
            document.getElementById('sfx-win').play();
            document.getElementById('btnCashout').classList.add('hidden');
            document.getElementById('btnWaiting').classList.remove('hidden');
            document.getElementById('btnWaiting').innerText = "WON: " + winAmount.toFixed(0);
            document.getElementById('btnWaiting').classList.add('bg-green-600', 'text-white');
            
            userBet = 0; 
        }

        // --- CANVAS RENDER ---
        function render() {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // Grid Lines
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let i=0; i<canvasWidth; i+=80) { ctx.moveTo(i,0); ctx.lineTo(i,canvasHeight); }
            for(let i=0; i<canvasHeight; i+=80) { ctx.moveTo(0,i); ctx.lineTo(canvasWidth,i); }
            ctx.stroke();

            if(gameState === 'RUNNING' || gameState === 'CRASHED') {
                const progress = Math.min(1, (currentMultiplier - 1) / 5); 
                
                const startX = 0;
                const startY = canvasHeight;
                const endX = canvasWidth * 0.8;
                const endY = canvasHeight * 0.2; 
                
                const curX = startX + (progress * endX);
                const curY = startY - (Math.pow(progress, 0.8) * (startY - endY));

                ctx.beginPath();
                ctx.moveTo(0, canvasHeight);
                ctx.quadraticCurveTo(curX * 0.5, canvasHeight, curX, curY);
                
                ctx.strokeStyle = gameState === 'CRASHED' ? '#ef4444' : '#00ff2a';
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.stroke();
                
                // Fill Gradient
                ctx.lineTo(curX, canvasHeight);
                const grad = ctx.createLinearGradient(0, 0, 0, canvasHeight);
                grad.addColorStop(0, gameState === 'CRASHED' ? 'rgba(239,68,68,0.2)' : 'rgba(0,255,42,0.2)');
                grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad;
                ctx.fill();

                // Rocket / Bang
                ctx.save();
                ctx.translate(curX, curY);
                const angle = -Math.PI / 4 * progress; 
                ctx.rotate(angle);
                ctx.font = "30px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(gameState==='CRASHED' ? "üí•" : "üöÄ", 0, 0);
                ctx.restore();
            }
            requestAnimationFrame(render);
        }

        // --- UTILS ---
        function changeBet(m) { document.getElementById('betAmount').value *= m; }
        function resizeCanvas() {
            const cont = document.querySelector('.game-stage-panel');
            canvas.width = cont.offsetWidth;
            canvas.height = cont.offsetHeight;
            canvasWidth = canvas.width;
            canvasHeight = canvas.height;
        }
        function generateHistory() {
            const hist = document.getElementById('crashHistory');
            for(let i=0; i<8; i++) addToHistory((Math.random()*5+1).toFixed(2));
        }
        function addToHistory(val) {
            const hist = document.getElementById('crashHistory');
            const div = document.createElement('div');
            const isGood = val >= 2;
            div.className = `badge-mult ${isGood ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-gray-700/50 text-gray-400 border border-gray-600/30'}`;
            div.innerText = val + 'x';
            hist.prepend(div);
            if(hist.children.length > 10) hist.removeChild(hist.lastChild);
        }
    </script>
</body>
</html>
