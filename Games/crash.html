<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crash | PepeBlackJack</title>
    
    <!-- Librer铆as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #00ff2a; --bg-dark: #070b10; --border: rgba(255,255,255,0.1); }
        body { background: var(--bg-dark); color: white; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        .glass-panel { background: rgba(15, 22, 33, 0.9); backdrop-filter: blur(10px); border-right: 1px solid var(--border); }
        .input-slot { background: #0b1018; border: 1px solid var(--border); color: white; transition: 0.3s; }
        .input-slot:focus { border-color: var(--primary); outline: none; }
        
        .btn-neon { background: linear-gradient(180deg, #00ff2a 0%, #00cc22 100%); color: #000; font-weight: 800; border: none; transition: 0.2s; }
        .btn-neon:hover { transform: translateY(-2px); box-shadow: 0 0 25px rgba(0, 255, 42, 0.4); }
        
        .btn-action { width: 100%; padding: 1rem; border-radius: 0.75rem; font-weight: 800; font-size: 1.1rem; transition: 0.2s; }
        .btn-cashout { background: #fbbf24; color: black; box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
        .btn-cashout:hover { background: #f59e0b; transform: translateY(-2px); }

        .game-wrapper { display: flex; height: 100vh; }
        .sidebar { width: 300px; flex-shrink: 0; padding: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 20; background: #0f1621; border-right: 1px solid var(--border); }
        
        /* REA DE JUEGO CENTRADA */
        .game-stage { 
            flex: 1; 
            background: radial-gradient(circle at center, #1a2332 0%, #070b10 100%); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
            position: relative;
        }

        .canvas-container {
            width: 100%;
            max-width: 1000px; /* Limite de ancho para que se vea "cerca" */
            aspect-ratio: 16/9;
            background: #0b1018;
            border-radius: 16px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* Historial */
        .history-bar { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            left: 10px; 
            height: 30px; 
            display: flex; 
            justify-content: flex-end;
            gap: 6px; 
            overflow: hidden; 
            z-index: 10;
            mask-image: linear-gradient(to right, transparent, black 20%);
        }
        .badge-mult { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; min-width: 45px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        
        @media(max-width:1024px){ .game-wrapper{flex-direction:column-reverse;overflow-y:auto} .sidebar{width:100%;height:auto} .game-stage{height:600px} }
    </style>
</head>
<body>
    <audio id="sfx-tick" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sfx-crash" src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.mp3"></audio>

    <div class="game-wrapper">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="flex justify-between items-center mb-2">
                <a href="../index.html" class="flex items-center gap-2 text-gray-400 hover:text-white transition"><i class="fas fa-chevron-left"></i> Volver</a>
                <div class="bg-black/40 px-3 py-1 rounded-full border border-white/5 font-mono font-bold text-sm text-white"><span id="displayBalance">0.00</span> PBJ</div>
            </div>

            <!-- Bet Input -->
            <div class="bg-[#0b1018] p-4 rounded-xl border border-white/5">
                <label class="text-[10px] font-bold text-gray-500 block mb-2">APUESTA</label>
                <div class="relative">
                    <input type="number" id="betAmount" value="100" class="w-full p-3 input-slot rounded-lg font-bold text-sm">
                    <div class="absolute right-1 top-1 bottom-1 flex gap-1">
                        <button onclick="multBet(0.5)" class="bg-[#1a2c38] hover:bg-[#263549] text-gray-400 px-2 rounded text-[10px] font-bold">陆</button>
                        <button onclick="multBet(2)" class="bg-[#1a2c38] hover:bg-[#263549] text-gray-400 px-2 rounded text-[10px] font-bold">2x</button>
                    </div>
                </div>
            </div>

            <!-- Auto Cashout -->
            <div class="bg-[#0b1018] p-4 rounded-xl border border-white/5">
                <label class="text-[10px] font-bold text-gray-500 block mb-2">AUTO RETIRO (x)</label>
                <input type="number" id="autoCashout" value="2.00" step="0.10" class="w-full p-3 input-slot rounded-lg font-bold text-sm">
            </div>

            <!-- Botones de Estado -->
            <div class="mt-auto space-y-3">
                <button onclick="placeBet()" id="btnBet" class="btn-neon btn-action shadow-lg tracking-widest">APOSTAR</button>
                <button onclick="cashOut()" id="btnCashout" class="btn-cashout btn-action hidden tracking-widest">RETIRAR <br><span id="cashoutProfit" class="text-sm">0.00</span></button>
                <button id="btnWaiting" class="bg-gray-700 text-gray-400 btn-action hidden cursor-not-allowed font-bold">EN CURSO...</button>
            </div>
            
            <div class="text-[10px] text-center text-gray-600 mt-2">
                <i class="fas fa-shield-alt"></i> Provably Fair
            </div>
        </div>

        <!-- GAME STAGE (CENTRADO) -->
        <div class="game-stage">
            <div class="canvas-container">
                <!-- Historial -->
                <div class="history-bar" id="crashHistory"></div>

                <!-- Multiplicador Central -->
                <div class="absolute inset-0 flex flex-col items-center justify-center z-10 pointer-events-none">
                    <div id="multiplierDisplay" class="text-7xl md:text-8xl font-black text-white drop-shadow-[0_0_30px_rgba(0,0,0,0.5)] font-mono tracking-tighter transition-colors duration-100">1.00x</div>
                    <div id="statusMessage" class="text-xs font-bold text-gray-400 mt-4 tracking-[0.3em] uppercase bg-black/30 px-4 py-1 rounded-full backdrop-blur-sm">Esperando...</div>
                </div>

                <!-- Canvas -->
                <canvas id="crashCanvas" class="w-full h-full"></canvas>
            </div>
        </div>
    </div>

    <!-- LGICA (LOCALSTORAGE) -->
    <script>
        const STORAGE_KEY = 'pepeblackjack_v1';
        const canvas = document.getElementById('crashCanvas');
        const ctx = canvas.getContext('2d');
        
        let userBalance = 0, username = null;
        let gameState = 'IDLE'; // IDLE, BETTING, RUNNING, CRASHED
        let currentMultiplier = 1.00;
        let crashPoint = 0;
        let speed = 0;
        let animationId;
        let userBet = 0;
        let userCashedOut = false;
        let graphPoints = [];
        let canvasWidth, canvasHeight;

        // INIT
        window.onload = () => {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if(data) {
                userBalance = parseFloat(data.balance);
                username = data.username;
                updateBalanceUI();
            } else {
                window.location.href = '../index.html';
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            generateHistory(); 
            
            // Auto start loop
            setTimeout(startGame, 1000);
            render();
        };

        function saveData() {
            const data = { username: username, balance: userBalance };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            updateBalanceUI();
        }

        // --- CORE GAME LOOP ---
        function startGame() {
            if(userBet > 0) {
                userBalance -= userBet;
                saveData();
                document.getElementById('btnBet').classList.add('hidden');
                document.getElementById('btnCashout').classList.remove('hidden');
                document.getElementById('btnWaiting').classList.add('hidden');
            }

            gameState = 'RUNNING';
            currentMultiplier = 1.00;
            speed = 0.006; 
            userCashedOut = false;
            graphPoints = [{x: 0, y: canvasHeight}];
            
            // Algoritmo Crash Simple
            crashPoint = (Math.floor(Math.random() * 33) === 0) ? 1.00 : parseFloat((100 / (Math.random() * 100 + 1)).toFixed(2)); 
            if(crashPoint < 1.00) crashPoint = 1.00; 
            
            document.getElementById('statusMessage').innerText = "EN VIVO";
            document.getElementById('multiplierDisplay').classList.remove('text-red-500');
            document.getElementById('multiplierDisplay').classList.add('text-white');
            
            runGameTick();
        }

        function runGameTick() {
            if(gameState !== 'RUNNING') return;

            currentMultiplier += speed;
            speed *= 1.003; // Aceleraci贸n suave

            document.getElementById('multiplierDisplay').innerText = currentMultiplier.toFixed(2) + "x";
            
            // Auto Cashout Logic
            const auto = parseFloat(document.getElementById('autoCashout').value);
            if(userBet > 0 && !userCashedOut && auto > 1.0 && currentMultiplier >= auto) {
                cashOut();
            }

            if(userBet > 0 && !userCashedOut) {
                document.getElementById('cashoutProfit').innerText = (userBet * currentMultiplier).toFixed(2);
            }

            if(currentMultiplier >= crashPoint) {
                crash();
            } else {
                animationId = requestAnimationFrame(runGameTick);
            }
        }

        function crash() {
            gameState = 'CRASHED';
            cancelAnimationFrame(animationId);
            document.getElementById('multiplierDisplay').innerText = crashPoint.toFixed(2) + "x";
            document.getElementById('multiplierDisplay').classList.remove('text-white');
            document.getElementById('multiplierDisplay').classList.add('text-red-500');
            document.getElementById('statusMessage').innerText = "CRASHED";
            document.getElementById('sfx-crash').play();
            
            document.getElementById('btnCashout').classList.add('hidden');
            document.getElementById('btnBet').classList.remove('hidden');
            
            if(userBet > 0 && !userCashedOut) {
                userBet = 0; // Perdi贸
                document.getElementById('btnBet').innerText = "APOSTAR";
                document.getElementById('btnBet').classList.remove('opacity-50');
            } else if (userCashedOut) {
                document.getElementById('btnWaiting').classList.add('hidden');
                document.getElementById('btnBet').innerText = "APOSTAR";
                document.getElementById('btnBet').classList.remove('opacity-50');
            }

            addToHistory(crashPoint);
            
            // Restart Countdown
            let countdown = 4;
            const timer = setInterval(() => {
                document.getElementById('statusMessage').innerText = `Pr贸xima Ronda en ${countdown}s`;
                countdown--;
                if(countdown < 0) {
                    clearInterval(timer);
                    startGame();
                }
            }, 1000);
        }

        // --- PLAYER ACTIONS ---
        function placeBet() {
            const amount = parseFloat(document.getElementById('betAmount').value);
            if(amount > userBalance) return Swal.fire({title:"Saldo Insuficiente", icon:"error", background:'#0f1621', color:'#fff'});
            if(amount <= 0) return;

            userBet = amount;
            if(gameState === 'RUNNING') {
                document.getElementById('btnBet').classList.add('hidden');
                document.getElementById('btnWaiting').classList.remove('hidden');
                document.getElementById('btnWaiting').innerText = "APUESTA EN COLA...";
                document.getElementById('btnWaiting').classList.remove('bg-green-600', 'text-white');
            } else {
                document.getElementById('btnBet').innerText = "APOSTADO";
                document.getElementById('btnBet').classList.add('opacity-50');
            }
        }

        function cashOut() {
            if(gameState !== 'RUNNING' || userCashedOut) return;
            userCashedOut = true;
            const winAmount = userBet * currentMultiplier;
            
            userBalance += winAmount;
            saveData();
            
            document.getElementById('sfx-win').play();
            document.getElementById('btnCashout').classList.add('hidden');
            document.getElementById('btnWaiting').classList.remove('hidden');
            document.getElementById('btnWaiting').innerText = "GANADO: " + winAmount.toFixed(0);
            document.getElementById('btnWaiting').classList.add('bg-green-600', 'text-white');
            
            userBet = 0; 
        }

        // --- CANVAS RENDER ---
        function render() {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // Grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let i=0; i<canvasWidth; i+=80) { ctx.moveTo(i,0); ctx.lineTo(i,canvasHeight); }
            for(let i=0; i<canvasHeight; i+=80) { ctx.moveTo(0,i); ctx.lineTo(canvasWidth,i); }
            ctx.stroke();

            if(gameState === 'RUNNING' || gameState === 'CRASHED') {
                // Calcular curva
                // X axis: Time (lineal) | Y axis: Multiplier (exponencial visual)
                const progress = Math.min(1, (currentMultiplier - 1) / 5); // Zoom visual
                
                const startX = 0;
                const startY = canvasHeight;
                const endX = canvasWidth * 0.8;
                const endY = canvasHeight * 0.2; // Sube hasta el 20% top
                
                const curX = startX + (progress * endX);
                const curY = startY - (Math.pow(progress, 0.8) * (startY - endY)); // Curva suave

                ctx.beginPath();
                ctx.moveTo(0, canvasHeight);
                ctx.quadraticCurveTo(curX * 0.5, canvasHeight, curX, curY);
                
                ctx.strokeStyle = gameState === 'CRASHED' ? '#ef4444' : '#00ff2a';
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.stroke();
                
                // Gradiente debajo
                ctx.lineTo(curX, canvasHeight);
                const grad = ctx.createLinearGradient(0, 0, 0, canvasHeight);
                grad.addColorStop(0, gameState === 'CRASHED' ? 'rgba(239,68,68,0.2)' : 'rgba(0,255,42,0.2)');
                grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad;
                ctx.fill();

                // Cohete
                ctx.save();
                ctx.translate(curX, curY);
                // Rotaci贸n basada en la pendiente
                const angle = -Math.PI / 4 * progress; 
                ctx.rotate(angle);
                
                ctx.font = "30px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(gameState==='CRASHED' ? "" : "", 0, 0);
                ctx.restore();
            }

            requestAnimationFrame(render);
        }

        // --- UTILS ---
        function updateBalanceUI() { document.getElementById('displayBalance').innerText = userBalance.toFixed(2); }
        function multBet(m) { document.getElementById('betAmount').value *= m; }
        function resizeCanvas() {
            const cont = document.querySelector('.canvas-container');
            canvas.width = cont.offsetWidth;
            canvas.height = cont.offsetHeight;
            canvasWidth = canvas.width;
            canvasHeight = canvas.height;
        }
        function generateHistory() {
            const hist = document.getElementById('crashHistory');
            for(let i=0; i<8; i++) addToHistory((Math.random()*5+1).toFixed(2));
        }
        function addToHistory(val) {
            const hist = document.getElementById('crashHistory');
            const div = document.createElement('div');
            div.className = `badge-mult ${val >= 2 ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-gray-700/50 text-gray-400 border border-gray-600/30'}`;
            div.innerText = val + 'x';
            hist.prepend(div);
            if(hist.children.length > 10) hist.removeChild(hist.lastChild);
        }
    </script>
</body>
</html>
