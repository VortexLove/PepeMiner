<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Pro | PepeCasino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            background: transparent; color: white; font-family: 'Inter', sans-serif;
            overflow: hidden; user-select: none; height: 100vh; margin: 0;
            display: flex; justify-content: center; align-items: center;
        }

        .game-wrapper {
            width: 100%; max-width: 1100px; height: 650px;
            background: #121924; border: 1px solid #1f2937; border-radius: 20px;
            display: grid; grid-template-columns: 300px 1fr;
            overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* CONTROLES */
        .controls { background: #0b1016; padding: 24px; display: flex; flex-direction: column; gap: 20px; border-right: 1px solid #1f2937; z-index: 10; }
        .input-group { background: #05080a; border: 1px solid #1f2937; border-radius: 8px; padding: 5px; display: flex; align-items: center; }
        .input-clean { background: transparent; width: 100%; border: none; color: white; padding: 10px; font-weight: bold; outline: none; }
        
        .btn-action {
            width: 100%; padding: 18px; border-radius: 12px; font-weight: 900; 
            text-transform: uppercase; transition: 0.2s; letter-spacing: 1px; font-size: 1.1rem;
            position: relative; overflow: hidden;
        }
        .btn-bet { background: #00ff2a; color: black; box-shadow: 0 0 20px rgba(0,255,42,0.2); }
        .btn-bet:hover { transform: translateY(-2px); box-shadow: 0 0 35px rgba(0,255,42,0.5); }
        .btn-bet:active { transform: scale(0.98); }

        /* STAGE */
        .stage { 
            position: relative; background: radial-gradient(circle at 50% 50%, #1a2530 0%, #05080a 100%);
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;
        }

        /* RESULTADO GIGANTE */
        .result-display {
            font-size: 6rem; font-weight: 900; font-family: 'Space Grotesk', sans-serif;
            margin-bottom: 40px; transition: 0.2s; position: relative; z-index: 20;
            text-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .win-anim { animation: popWin 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: #00ff2a; text-shadow: 0 0 50px rgba(0, 255, 42, 0.6); }
        .lose-anim { animation: shake 0.4s; color: #ef4444; text-shadow: 0 0 30px rgba(239, 68, 68, 0.4); }

        @keyframes popWin { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* SLIDER CUSTOMIZADO */
        .slider-container {
            width: 100%; max-width: 650px; position: relative;
            background: #1f2937; height: 16px; border-radius: 10px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        
        .slider-fill {
            position: absolute; left: 0; top: 0; bottom: 0; border-radius: 10px;
            background: linear-gradient(90deg, #00ff2a, #00cc22);
            pointer-events: none; transition: width 0.1s;
            box-shadow: 0 0 15px rgba(0, 255, 42, 0.3);
        }
        .slider-fill.reverse { background: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); left: auto; right: 0; }

        .range-input {
            -webkit-appearance: none; width: 100%; height: 16px; background: transparent;
            position: absolute; top: 0; left: 0; margin: 0; z-index: 10; cursor: pointer;
        }
        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none; width: 34px; height: 34px; border-radius: 8px;
            background: white; border: 4px solid #121924; cursor: grab;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            position: relative; top: 0px; transition: transform 0.1s;
        }
        .range-input::-webkit-slider-thumb:hover { transform: scale(1.1); }
        .range-input::-webkit-slider-thumb:active { cursor: grabbing; transform: scale(0.95); }

        /* TARJETAS DE DATOS */
        .stat-card {
            background: #1f2937; border-radius: 12px; padding: 15px; text-align: center;
            flex: 1; border: 1px solid #374151; transition: 0.2s; position: relative; overflow: hidden;
        }
        .stat-card:focus-within { border-color: #00ff2a; box-shadow: 0 0 15px rgba(0, 255, 42, 0.1); }
        
        .stat-label { font-size: 11px; text-transform: uppercase; color: #9ca3af; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 5px; }
        .stat-value { font-size: 1.2rem; font-weight: bold; color: white; background: transparent; width: 100%; text-align: center; outline: none; font-family: 'Space Grotesk', monospace; }

        .marker { position: absolute; top: 25px; transform: translateX(-50%); font-size: 10px; font-weight: bold; color: #6b7280; }

        @media (max-width: 900px) {
            .game-wrapper { grid-template-columns: 1fr; display: flex; flex-direction: column-reverse; height: 100vh; border-radius: 0; border: none; }
            .stage { height: 60%; }
            .controls { padding: 15px; }
            .result-display { font-size: 4rem; margin-bottom: 20px; }
        }
    </style>
</head>
<body>

    <div class="game-wrapper">
        <!-- CONTROLES -->
        <div class="controls">
            <div>
                <div class="flex justify-between text-[10px] font-bold text-gray-500 uppercase mb-1">
                    <span>Bet Amount</span>
                    <span id="balanceDisplay">Loading...</span>
                </div>
                <div class="input-group">
                    <input type="number" id="betInput" value="10" class="input-clean">
                    <button onclick="adjBet(0.5)" class="px-2 text-xs font-bold text-gray-500 hover:text-white">½</button>
                    <button onclick="adjBet(2)" class="px-2 text-xs font-bold text-gray-500 hover:text-white">2x</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-black/30 p-3 rounded-xl border border-white/5">
                    <div class="text-[9px] text-gray-500 uppercase font-bold">Profit on Win</div>
                    <div class="text-green-400 font-bold text-lg" id="profitDisplay">0.00</div>
                </div>
                <div class="bg-black/30 p-3 rounded-xl border border-white/5">
                    <div class="text-[9px] text-gray-500 uppercase font-bold">Win Chance</div>
                    <div class="text-white font-bold text-lg" id="chanceDisplayMini">50%</div>
                </div>
            </div>

            <button onclick="roll()" id="rollBtn" class="btn-action btn-bet mt-auto">ROLL DICE</button>
        </div>

        <!-- STAGE -->
        <div class="stage">
            
            <!-- Resultado Gigante -->
            <div id="resultNumber" class="result-display text-gray-500">50.00</div>
            
            <!-- Cards de Configuración -->
            <div class="flex gap-4 w-full max-w-2xl mb-12 px-4">
                
                <!-- Multiplier Input -->
                <div class="stat-card">
                    <div class="stat-label">Multiplier</div>
                    <div class="relative">
                        <input type="number" id="multiplierInput" value="2.0000" class="stat-value" onchange="syncFromMult()">
                        <span class="absolute right-2 top-1 text-xs text-gray-600 font-bold">x</span>
                    </div>
                </div>

                <!-- Roll Under Display -->
                <div class="stat-card bg-[#1a2530] border-green-500/30">
                    <div class="stat-label text-green-400">Roll Under</div>
                    <div class="stat-value text-green-400 pointer-events-none" id="rollUnderDisplay">50.00</div>
                </div>

                <!-- Win Chance Input -->
                <div class="stat-card">
                    <div class="stat-label">Win Chance</div>
                    <div class="relative">
                        <input type="number" id="chanceInput" value="49.50" class="stat-value" onchange="syncFromChance()">
                        <span class="absolute right-2 top-1 text-xs text-gray-600 font-bold">%</span>
                    </div>
                </div>
            </div>

            <!-- Slider Visual -->
            <div class="slider-container">
                <div class="slider-fill" id="sliderFill" style="width: 50%;"></div>
                <input type="range" min="2" max="98" value="50" step="0.01" class="range-input" id="diceSlider" oninput="updateSliderUI()">
                
                <!-- Marcadores -->
                <span class="marker" style="left: 0%">0</span>
                <span class="marker" style="left: 25%">25</span>
                <span class="marker" style="left: 50%">50</span>
                <span class="marker" style="left: 75%">75</span>
                <span class="marker" style="left: 100%">100</span>
                
                <!-- Target Float -->
                <div id="targetFloat" class="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-[#00ff2a] text-black px-3 py-1 rounded font-bold text-sm shadow-lg pointer-events-none transition-all">50.00</div>
            </div>

        </div>
    </div>

    <!-- AUDIO -->
    <audio id="sfx-roll" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
    <audio id="sfx-lose" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

    <script>
        // --- INFRAESTRUCTURA IFRAME ---
        let userBalance = 0;
        window.addEventListener('message', (e) => {
            if (e.data.type === 'INIT_BALANCE' || e.data.type === 'SYNC_BALANCE') {
                userBalance = e.data.balance;
                document.getElementById('balanceDisplay').innerText = userBalance.toLocaleString();
            }
        });
        function updateParent(amount) { window.parent.postMessage({ type: 'UPDATE_BALANCE', amount: amount }, '*'); }

        // --- LÓGICA DICE ---
        const slider = document.getElementById('diceSlider');
        const fill = document.getElementById('sliderFill');
        const multInput = document.getElementById('multiplierInput');
        const chanceInput = document.getElementById('chanceInput');
        const rollUnderDisp = document.getElementById('rollUnderDisplay');
        const profitDisp = document.getElementById('profitDisplay');
        const resultNum = document.getElementById('resultNumber');
        const targetFloat = document.getElementById('targetFloat');
        
        const houseEdge = 1; // 1% House Edge

        // Init
        updateSliderUI();

        function adjBet(m) {
            const el = document.getElementById('betInput');
            let v = parseFloat(el.value) * m;
            if(v<1) v=1; el.value = v.toFixed(0);
            updateProfit();
        }

        // --- CORE MATHS ---
        function updateSliderUI() {
            const target = parseFloat(slider.value);
            
            // Visual Update
            fill.style.width = target + "%";
            
            // Move Float Label
            // Calcular posición relativa del thumb (aprox)
            const percent = (target - 2) / (98 - 2); 
            const thumbWidth = 34;
            const trackWidth = slider.clientWidth;
            const left = percent * (trackWidth - thumbWidth) + (thumbWidth / 2);
            targetFloat.style.left = left + "px";
            targetFloat.innerText = target.toFixed(2);

            // Sync Inputs
            const chance = target; // Roll Under Mode: Target = Chance
            chanceInput.value = chance.toFixed(2);
            
            // Calc Multiplier: (100 - Edge) / Chance
            const mult = (100 - houseEdge) / chance;
            multInput.value = mult.toFixed(4);

            rollUnderDisp.innerText = target.toFixed(2);
            document.getElementById('chanceDisplayMini').innerText = chance.toFixed(2) + "%";
            
            updateProfit();
        }

        function syncFromMult() {
            let mult = parseFloat(multInput.value);
            // Clamp Multiplier (Max 49.5x -> Min 2% chance / Min 1.0102x -> Max 98% chance)
            if(mult < 1.0102) mult = 1.0102;
            if(mult > 49.5) mult = 49.5;
            
            const chance = (100 - houseEdge) / mult;
            slider.value = chance;
            updateSliderUI();
        }

        function syncFromChance() {
            let chance = parseFloat(chanceInput.value);
            if(chance > 98) chance = 98;
            if(chance < 2) chance = 2;
            
            slider.value = chance;
            updateSliderUI();
        }

        function updateProfit() {
            const bet = parseFloat(document.getElementById('betInput').value || 0);
            const mult = parseFloat(multInput.value || 0);
            const profit = (bet * mult) - bet;
            profitDisp.innerText = profit.toFixed(2);
        }

        // --- GAMEPLAY LOOP ---
        function roll() {
            const bet = parseFloat(document.getElementById('betInput').value);
            if(bet > userBalance) return alert("Insufficient Balance");
            if(bet <= 0) return;

            // Descontar
            updateParent(-bet);
            
            // UI State
            const btn = document.getElementById('rollBtn');
            btn.disabled = true;
            btn.classList.add('opacity-50');
            
            // Generar Resultado Provably Fair (Simulado)
            // Crypto.getRandomValues para mayor aleatoriedad que Math.random
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            const random = array[0] / (0xffffffff + 1);
            const finalResult = (random * 100).toFixed(2);
            
            // Animación "Rolling"
            document.getElementById('sfx-roll').play();
            let frames = 0;
            
            const animInterval = setInterval(() => {
                // Generar números aleatorios visuales
                const temp = (Math.random() * 100).toFixed(2);
                resultNum.innerText = temp;
                resultNum.className = "result-display text-gray-500";
                
                frames++;
                if(frames > 8) { // Velocidad rápida
                    clearInterval(animInterval);
                    finishRoll(finalResult, bet);
                }
            }, 40);
        }

        function finishRoll(resultStr, bet) {
            const result = parseFloat(resultStr);
            const target = parseFloat(slider.value);
            const isWin = result < target; // Roll Under
            
            resultNum.innerText = resultStr;

            if(isWin) {
                // Ganó
                const mult = parseFloat(multInput.value);
                const payout = bet * mult;
                updateParent(payout);
                
                resultNum.className = "result-display win-anim";
                document.getElementById('sfx-win').play();
            } else {
                // Perdió
                resultNum.className = "result-display lose-anim";
                document.getElementById('sfx-lose').play();
            }

            // Reset UI
            const btn = document.getElementById('rollBtn');
            btn.disabled = false;
            btn.classList.remove('opacity-50');
        }

    </script>
</body>
</html>
