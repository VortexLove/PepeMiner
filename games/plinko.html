<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Viewport estricto para evitar zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plinko Royal | PepeCasino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700;900&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pepe-dark': '#020202',
                        'royal-gold': '#FFD700',
                    },
                    fontFamily: {
                        'display': ['Chakra Petch', 'sans-serif'],
                        'body': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background: transparent; color: white; font-family: 'Inter', sans-serif; 
            overflow: hidden; user-select: none;
            height: 100vh; margin: 0; touch-action: none;
        }

        .game-wrapper {
            width: 100%; height: 100%;
            background: #020202; 
            display: flex; flex-direction: column-reverse; /* MÓVIL: Controles abajo */
            position: relative;
        }

        /* En PC: Diseño Horizontal */
        @media (min-width: 1024px) {
            .game-wrapper {
                flex-direction: row; /* PC: Controles izquierda */
                max-width: 1200px; height: 700px;
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 16px;
                margin: auto; /* Centrado */
                background: #050505;
                box-shadow: 0 0 50px rgba(0,0,0,0.8);
            }
        }

        /* CONTROLES */
        .controls { 
            background: #080808; 
            padding: 16px; 
            display: flex; flex-direction: column; gap: 12px; 
            border-top: 1px solid rgba(255, 215, 0, 0.1);
            z-index: 20;
            flex-shrink: 0;
        }

        @media (min-width: 1024px) {
            .controls {
                width: 320px; height: 100%;
                border-top: none; border-right: 1px solid rgba(255, 215, 0, 0.1);
                padding: 30px; gap: 20px;
            }
        }

        .input-group { 
            background: #121212; border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 8px; padding: 4px; display: flex; align-items: center; 
            transition: 0.3s;
        }
        .input-group:focus-within { border-color: #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
        .input-clean { background: transparent; width: 100%; border: none; color: white; padding: 12px; font-weight: bold; outline: none; font-family: 'Chakra Petch'; }

        .select-clean { 
            background: #121212; border: 1px solid rgba(255,255,255,0.1); 
            color: white; padding: 12px; border-radius: 8px; width: 100%; 
            outline: none; font-weight: bold; cursor: pointer; font-family: 'Chakra Petch';
            appearance: none;
        }
        .select-clean:focus { border-color: #FFD700; }

        /* BOTÓN PRINCIPAL */
        .btn-action {
            width: 100%; padding: 16px; border-radius: 8px; font-weight: 900; font-size: 1.1rem;
            text-transform: uppercase; transition: 0.2s; letter-spacing: 1px; font-family: 'Chakra Petch';
            position: relative; overflow: hidden;
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); 
            color: black; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            border: 1px solid #FFE4B5;
        }
        .btn-action:active { transform: scale(0.98); filter: brightness(0.9); }

        /* STAGE & CANVAS */
        .stage { 
            position: relative; flex: 1; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            background: radial-gradient(circle at 50% 50%, #1a1a00 0%, #020202 80%);
            overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; position: absolute; top: 0; left: 0; }

        /* MULTIPLICADORES (BUCKETS) */
        .buckets-container {
            position: absolute; bottom: 20px; width: 95%; max-width: 800px;
            display: flex; justify-content: center; gap: 2px; z-index: 10;
        }
        .bucket {
            flex: 1; height: 30px; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 900; color: #000; font-family: 'Chakra Petch';
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: transform 0.1s; cursor: default;
        }
        @media (min-width: 1024px) { 
            .bucket { height: 40px; font-size: 11px; gap: 4px; } 
            .buckets-container { bottom: 40px; gap: 6px; }
        }
        
        /* POP TEXT */
        .pop-text {
            position: absolute; font-weight: 900; font-size: 14px; pointer-events: none;
            animation: floatUp 1s forwards; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 50;
            font-family: 'Chakra Petch';
        }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.8); opacity: 1; } 100% { transform: translateY(-50px) scale(1.2); opacity: 0; } }

        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body>

    <!-- AUDIO -->
    <audio id="sfx-hit" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.mp3"></audio>
    <audio id="sfx-bigwin" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>

    <div class="game-wrapper" id="mainCard">
        <!-- CONTROLES -->
        <div class="controls">
            
            <!-- Balance Info -->
            <div class="flex justify-between items-center bg-[#121212] p-2 rounded border border-white/5">
                <span class="text-[10px] text-gray-500 font-bold uppercase">Balance</span>
                <span class="text-gold font-mono font-bold" id="balanceDisplay">Loading...</span>
            </div>
            
            <!-- Bet Amount -->
            <div>
                <label class="text-[10px] uppercase font-bold text-gray-500 mb-1 block">Bet Amount</label>
                <div class="input-group">
                    <input type="number" id="betInput" value="10" min="1" class="input-clean">
                    <div class="flex gap-1 pr-1">
                        <button onclick="adjBet(0.5)" class="px-3 py-1 bg-[#222] rounded text-[10px] font-bold text-gray-400 hover:text-white border border-white/5">½</button>
                        <button onclick="adjBet(2)" class="px-3 py-1 bg-[#222] rounded text-[10px] font-bold text-gray-400 hover:text-white border border-white/5">2x</button>
                    </div>
                </div>
            </div>

            <!-- Risk -->
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[10px] uppercase font-bold text-gray-500 mb-1 block">Risk</label>
                    <select id="riskSelect" onchange="updateConfig()" class="select-clean">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>

                <!-- Rows -->
                <div>
                    <label class="text-[10px] uppercase font-bold text-gray-500 mb-1 block">Rows</label>
                    <select id="rowsSelect" onchange="updateConfig()" class="select-clean">
                        <option value="8">8</option>
                        <option value="10">10</option>
                        <option value="12">12</option>
                        <option value="14">14</option>
                        <option value="16" selected>16</option>
                    </select>
                </div>
            </div>

            <!-- Stats -->
            <div class="bg-[#121212] p-2 rounded border border-white/5 flex justify-between items-center mt-auto">
                <p class="text-[9px] text-gray-500 uppercase font-bold">Max Profit</p>
                <p class="text-sm font-bold text-green-400 font-mono" id="uiMaxProfit">0.00</p>
            </div>

            <button onclick="play()" id="playBtn" class="btn-action">DROP BALL</button>
        </div>

        <!-- STAGE -->
        <div class="stage" id="stageContainer">
            <canvas id="gameCanvas"></canvas>
            <div id="bucketsContainer" class="buckets-container"></div>
        </div>
    </div>

    <script>
        // ==================================================================
        // 1. SISTEMA DE CHIPS (COMUNICACIÓN PADRE-HIJO)
        // ==================================================================
        let currentBalance = 0;

        // Ajuste dinámico de altura para móviles
        function fixHeight() { document.querySelector('.game-wrapper').style.height = window.innerHeight + 'px'; }
        window.addEventListener('resize', fixHeight);
        fixHeight();

        // Escuchar mensajes
        window.addEventListener('message', (e) => {
            if (e.data.type === 'INIT_BALANCE' || e.data.type === 'SYNC_BALANCE') {
                updateBalanceUI(e.data.balance);
            }
        });

        // Actualizar UI local
        function updateBalanceUI(newBal) {
            currentBalance = parseFloat(newBal);
            document.getElementById('balanceDisplay').innerText = currentBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // Enviar cambios al padre
        function updateParent(amount) {
            // amount negativo = apuesta, positivo = ganancia
            window.parent.postMessage({ type: 'UPDATE_BALANCE', amount: amount }, '*');
        }

        // ==================================================================
        // 2. LÓGICA DEL JUEGO PLINKO
        // ==================================================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('stageContainer');

        let config = { rows: 16, risk: 'medium' };
        
        // PAYOUTS (Ajustados con House Edge ~4%)
        const PAYOUTS = {
            low: { 16: [16, 9, 2, 1.4, 1.4, 1.2, 1.1, 1, 0.5, 1, 1.1, 1.2, 1.4, 1.4, 2, 9, 16] },
            medium: { 16: [110, 41, 10, 5, 3, 1.5, 1, 0.5, 0.3, 1, 1.5, 3, 5, 10, 41, 110] },
            high: { 16: [1000, 130, 26, 9, 4, 2, 0.2, 0.2, 0.2, 0.2, 0.2, 2, 4, 9, 26, 130, 1000] }
        };

        // Generador de Arrays Simples para filas menores (Fallback)
        function getPayouts(rows, risk) {
            if(PAYOUTS[risk] && PAYOUTS[risk][rows]) return PAYOUTS[risk][rows];
            // Generar dummy si no existe la config exacta
            const arr = [];
            for(let i=0; i<=rows; i++) arr.push(i === 0 || i === rows ? (rows*1.5) : 0.4);
            return arr;
        }

        let pegs = [];
        let balls = [];
        let bucketEls = []; 

        window.onload = () => {
            updateConfig();
            animate();
            window.addEventListener('resize', resize);
        };

        function resize() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            initGeometry();
        }

        function updateConfig() {
            config.rows = parseInt(document.getElementById('rowsSelect').value);
            config.risk = document.getElementById('riskSelect').value;
            renderBuckets();
            resize();
            
            // Update Max Profit Text
            const bet = parseFloat(document.getElementById('betInput').value || 0);
            const mults = getPayouts(config.rows, config.risk);
            const maxM = Math.max(...mults);
            document.getElementById('uiMaxProfit').innerText = (bet * maxM).toLocaleString();
        }

        function initGeometry() {
            pegs = [];
            const rows = config.rows;
            const startY = 40;
            const availableH = canvas.height - startY - 50; 
            const gap = Math.min(availableH / rows, 35); 
            config.gap = gap;
            config.startY = startY;
            config.finishY = startY + (rows * gap) + gap/2;

            for(let r=0; r < rows; r++) {
                for(let c=0; c <= r; c++) {
                    pegs.push({
                        x: (canvas.width/2) - (r*gap/2) + (c*gap),
                        y: startY + (r*gap),
                        r: 2.5,
                        glow: 0
                    });
                }
            }
        }

        function renderBuckets() {
            const container = document.getElementById('bucketsContainer');
            container.innerHTML = '';
            const mults = getPayouts(config.rows, config.risk);
            bucketEls = [];

            mults.forEach((val, i) => {
                const el = document.createElement('div');
                el.className = 'bucket';
                el.innerText = val + 'x';
                
                // Colores Royal Gold & Black
                let bg1='#1f2937', bg2='#000';
                let txt='gray';
                
                if(val >= 1) { bg1='#374151'; txt='white'; }
                if(val >= 3) { bg1='#854d0e'; bg2='#422006'; txt='#FFD700'; } // Bronze/Gold
                if(val >= 10) { bg1='#FFD700'; bg2='#a16207'; txt='black'; } // Pure Gold
                
                el.style.background = `linear-gradient(180deg, ${bg1}, ${bg2})`;
                el.style.color = txt;
                if(val < 1) el.style.opacity = '0.4';

                container.appendChild(el);
                bucketEls.push(el);
            });
        }

        function play() {
            const betInput = document.getElementById('betInput');
            const bet = parseFloat(betInput.value);

            // 1. VALIDACIONES
            if(isNaN(bet) || bet <= 0) return;
            if(bet > currentBalance) {
                betInput.parentNode.style.borderColor = 'red';
                setTimeout(() => betInput.parentNode.style.borderColor = 'rgba(255,255,255,0.1)', 500);
                return;
            }

            // 2. DEDUCIR SALDO (Local y Remoto)
            updateBalanceUI(currentBalance - bet);
            updateParent(-bet);

            // 3. LOGICA DE LA BOLA
            const path = [];
            for(let i=0; i<config.rows; i++) path.push(Math.random() < 0.5 ? -0.5 : 0.5); 

            balls.push({
                x: canvas.width / 2, y: 10,
                vx: 0, vy: 0,
                path: path,
                row: 0,
                bet: bet,
                color: Math.random() > 0.5 ? '#FFD700' : '#ffffff',
                trail: []
            });
        }

        function adjBet(m) {
            const el = document.getElementById('betInput');
            let v = parseFloat(el.value) * m;
            if(v<1) v=1; el.value = v.toFixed(2);
            updateConfig(); 
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Pegs
            pegs.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                if(p.glow > 0) {
                    ctx.fillStyle = `rgba(255, 215, 0, ${p.glow})`; // Gold Glow
                    ctx.shadowBlur = 10; ctx.shadowColor = "#FFD700";
                    p.glow -= 0.05;
                } else {
                    ctx.fillStyle = '#4b5563'; ctx.shadowBlur = 0;
                }
                ctx.fill();
            });
            ctx.shadowBlur = 0;

            // Balls
            for(let i=balls.length-1; i>=0; i--) {
                const b = balls[i];
                b.vy += 0.25; b.y += b.vy; b.x += b.vx;

                const targetY = config.startY + (b.row * config.gap);
                
                if(b.y > targetY - 5 && b.row < config.rows) {
                    const dir = b.path[b.row]; 
                    const noise = (Math.random() - 0.5) * 0.3;
                    b.vx = (dir * 2) + noise; 
                    b.vy *= 0.55; 
                    b.row++;

                    // Find Peg
                    const peg = pegs.find(p => Math.abs(p.y - b.y) < 20 && Math.abs(p.x - b.x) < 20);
                    if(peg) { peg.glow = 1; playAudio('sfx-hit', 0.1); }
                }

                if(b.y > config.finishY) {
                    resolveBall(b, i);
                    continue;
                }

                // Trail
                ctx.beginPath();
                for(let t=0; t<b.trail.length; t++) {
                    const pt = b.trail[t];
                    ctx.lineTo(pt.x, pt.y);
                }
                ctx.strokeStyle = `rgba(255, 215, 0, 0.3)`;
                ctx.lineWidth = 2;
                ctx.stroke();
                
                b.trail.push({x: b.x, y: b.y});
                if(b.trail.length > 8) b.trail.shift();

                // Ball Body
                ctx.beginPath();
                ctx.arc(b.x, b.y, 4, 0, Math.PI*2);
                ctx.fillStyle = b.color;
                ctx.shadowColor = b.color; ctx.shadowBlur = 8;
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            requestAnimationFrame(animate);
        }

        function resolveBall(b, idx) {
            balls.splice(idx, 1);
            
            const rightMoves = b.path.filter(m => m === 0.5).length;
            const mults = getPayouts(config.rows, config.risk);
            // In Plinko, buckets are standard distribution. 
            // Index 0 is all left, Index Last is all right.
            const safeIdx = Math.max(0, Math.min(rightMoves, mults.length - 1));
            const val = mults[safeIdx];
            
            const payout = b.bet * val;

            // 4. SUMAR GANANCIA (Local y Remota)
            if(payout > 0) {
                updateBalanceUI(currentBalance + payout);
                updateParent(payout); 
            }

            spawnText(b.x, config.finishY - 20, payout, val);
            
            const el = bucketEls[safeIdx];
            if(el) {
                el.style.transform = "translateY(-10px) scale(1.3)";
                el.style.filter = "brightness(2)";
                setTimeout(() => { el.style.transform = "none"; el.style.filter = "none"; }, 200);
            }

            if(val >= 10) {
                playAudio('sfx-bigwin');
                document.getElementById('mainCard').classList.add('shake');
                setTimeout(()=>document.getElementById('mainCard').classList.remove('shake'), 300);
            } else if (payout > 0) {
                playAudio('sfx-win');
            }
        }

        // --- UTILS ---
        function spawnText(x, y, amount, mult) {
            const div = document.createElement('div');
            div.className = 'pop-text';
            div.style.left = (x - 20) + 'px'; 
            div.style.top = (y - 40) + 'px';
            div.innerHTML = mult < 1 ? `<span class="text-gray-500 font-bold">${mult}x</span>` : `<span class="text-[#FFD700]">+${amount.toFixed(1)}</span>`;
            container.appendChild(div);
            setTimeout(() => div.remove(), 1000);
        }

        function playAudio(id, vol=0.5) {
            const el = document.getElementById(id);
            if(el) { const clone = el.cloneNode(); clone.volume = vol; clone.play().catch(()=>{}); }
        }
    </script>
</body>
</html>
