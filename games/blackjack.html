<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Viewport estricto -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blackjack Royal | PepeCasino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700;900&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pepe-dark': '#020202',
                        'royal-gold': '#FFD700',
                    },
                    fontFamily: {
                        'display': ['Chakra Petch', 'sans-serif'],
                        'body': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background: transparent; color: white; font-family: 'Inter', sans-serif;
            overflow: hidden; user-select: none; height: 100vh; margin: 0;
            touch-action: none;
        }

        .game-wrapper {
            width: 100%; height: 100%;
            background: #020202; 
            display: flex; flex-direction: column-reverse; /* MÓVIL: Controles abajo */
            position: relative;
        }

        /* En PC: Diseño Horizontal */
        @media (min-width: 1024px) {
            .game-wrapper {
                flex-direction: row; /* PC: Controles izquierda */
                max-width: 1200px; height: 700px;
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 16px;
                margin: auto; /* Centrado */
                background: #050505;
                box-shadow: 0 0 50px rgba(0,0,0,0.8);
            }
        }

        /* --- CONTROLES --- */
        .controls { 
            background: #080808; 
            padding: 16px; 
            display: flex; flex-direction: column; gap: 12px; 
            border-top: 1px solid rgba(255, 215, 0, 0.1);
            z-index: 20;
            flex-shrink: 0;
        }

        @media (min-width: 1024px) {
            .controls {
                width: 320px; height: 100%;
                border-top: none; border-right: 1px solid rgba(255, 215, 0, 0.1);
                padding: 30px; gap: 20px;
            }
        }

        .input-group { 
            background: #121212; border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 8px; padding: 4px; display: flex; align-items: center; 
            transition: 0.3s;
        }
        .input-group:focus-within { border-color: #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
        .input-clean { background: transparent; width: 100%; border: none; color: white; padding: 12px; font-weight: bold; outline: none; font-family: 'Chakra Petch'; }

        /* BOTONES */
        .btn-action {
            width: 100%; padding: 14px; border-radius: 8px; font-weight: 900; font-size: 1rem;
            text-transform: uppercase; transition: 0.2s; letter-spacing: 1px; font-family: 'Chakra Petch';
            position: relative; overflow: hidden; cursor: pointer;
        }
        
        .btn-deal { 
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); 
            color: black; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); border: 1px solid #FFE4B5;
            font-size: 1.2rem; padding: 16px;
        }
        .btn-deal:active { transform: scale(0.98); }

        .game-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: auto; }
        
        .btn-hit { background: #22c55e; color: black; border: 1px solid #86efac; }
        .btn-stand { background: #ef4444; color: white; border: 1px solid #f87171; }
        .btn-double { grid-column: span 2; background: #3b82f6; color: white; border: 1px solid #60a5fa; }
        
        .btn-disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; filter: grayscale(1); }

        /* --- MESA DE JUEGO --- */
        .stage { 
            position: relative; flex: 1; 
            display: flex; flex-direction: column; align-items: center; justify-content: space-between; 
            padding: 20px;
            /* Tapete oscuro premium */
            background: radial-gradient(circle at 50% 50%, #0f2e1d 0%, #020202 90%);
        }

        /* CARTAS */
        .card-slot { 
            width: 70px; height: 100px; border: 2px dashed rgba(255,215,0,0.1); 
            border-radius: 6px; display: flex; align-items: center; justify-content: center; 
        }
        
        .card {
            width: 70px; height: 100px; background: white; border-radius: 6px;
            color: black; position: relative; font-family: 'Chakra Petch', sans-serif;
            box-shadow: -3px 3px 10px rgba(0,0,0,0.5);
            transition: transform 0.3s; 
            margin-left: -35px; /* Solapamiento móvil */
            display: flex; flex-direction: column; justify-content: space-between; padding: 4px;
            animation: deal 0.3s ease-out;
            border: 1px solid #ccc;
        }
        
        .card-val-top { font-size: 14px; font-weight: 900; line-height: 1; }
        .card-suit-center { font-size: 28px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .card-val-bot { font-size: 14px; font-weight: 900; line-height: 1; transform: rotate(180deg); }

        /* Desktop Card Override */
        @media (min-width: 1024px) {
            .card-slot { width: 100px; height: 140px; border-radius: 10px; }
            .card {
                width: 100px; height: 140px; border-radius: 8px; padding: 8px;
                margin-left: -50px;
            }
            .card-val-top { font-size: 18px; }
            .card-suit-center { font-size: 40px; }
            .card-val-bot { font-size: 18px; }
        }

        .card.red { color: #dc2626; }
        .card.black { color: #000; }

        .card-hidden {
            background: linear-gradient(135deg, #1f2937 25%, #111827 25%, #111827 50%, #1f2937 50%, #1f2937 75%, #111827 75%, #111827 100%);
            background-size: 10px 10px;
            border: 2px solid #FFD700; color: transparent;
            display: flex; align-items: center; justify-content: center;
        }
        .card-hidden::after { content: 'PBJ'; color: #FFD700; font-weight: 900; font-size: 10px; transform: rotate(-45deg); }

        @keyframes deal { from { opacity: 0; transform: translateY(-50px) translateX(50px) rotate(10deg); } to { opacity: 1; transform: translateY(0) rotate(0); } }

        /* SCORES */
        .score-bubble {
            background: rgba(0,0,0,0.8); border: 1px solid #FFD700;
            padding: 2px 12px; border-radius: 20px; font-weight: 900; font-size: 12px;
            margin-bottom: 5px; color: #FFD700; backdrop-filter: blur(4px);
            transition: 0.3s; opacity: 0; font-family: 'Chakra Petch';
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }
        .score-bubble.visible { opacity: 1; }

        /* OVERLAY RESULTADO */
        .result-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .result-overlay.active { opacity: 1; pointer-events: auto; }
        .result-text { font-size: 3rem; font-weight: 900; text-transform: uppercase; margin-bottom: 10px; text-shadow: 0 0 30px rgba(255,215,0,0.5); transform: scale(0.8); transition: 0.3s; font-family: 'Chakra Petch'; }
        .result-overlay.active .result-text { transform: scale(1); }
    </style>
</head>
<body>

    <div class="game-wrapper">
        <!-- CONTROLES -->
        <div class="controls">
            <!-- Balance -->
            <div class="flex justify-between items-center bg-[#121212] p-2 rounded border border-white/5">
                <span class="text-[10px] text-gray-500 font-bold uppercase">Balance</span>
                <span class="text-gold font-mono font-bold" id="balanceDisplay">Loading...</span>
            </div>

            <!-- Bet Input -->
            <div class="space-y-4 flex-1 lg:flex-none flex flex-col justify-center">
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Bet Amount</label>
                    <div class="input-group">
                        <input type="number" id="betInput" value="10" min="1" class="input-clean">
                        <div class="flex gap-1 pr-1">
                            <button onclick="adjBet(0.5)" class="px-3 py-1 bg-[#222] rounded text-[10px] font-bold text-gray-400 hover:text-white border border-white/5">½</button>
                            <button onclick="adjBet(2)" class="px-3 py-1 bg-[#222] rounded text-[10px] font-bold text-gray-400 hover:text-white border border-white/5">2x</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div id="betControls" class="mt-auto">
                <button onclick="startGame()" class="btn-action btn-deal">DEAL CARDS</button>
            </div>

            <div id="playControls" class="game-actions hidden mt-auto">
                <button onclick="hit()" class="btn-action btn-hit shadow-lg">HIT</button>
                <button onclick="stand()" class="btn-action btn-stand shadow-lg">STAND</button>
                <button id="btnDouble" onclick="doubleDown()" class="btn-action btn-double shadow-lg">DOUBLE</button>
            </div>
            
            <div class="hidden lg:block mt-auto text-[10px] text-gray-600 text-center font-bold uppercase tracking-widest">
                Blackjack Pays 3:2 • Dealer stands on 17
            </div>
        </div>

        <!-- MESA DE JUEGO -->
        <div class="stage">
            <!-- Dealer Area -->
            <div class="flex flex-col items-center justify-start pt-4 w-full">
                <div class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-widest">Dealer</div>
                <div id="dealer-score" class="score-bubble">0</div>
                <div id="dealer-hand" class="flex items-center justify-center pl-8 min-h-[110px] lg:min-h-[150px]">
                    <div class="card-slot opacity-20"></div>
                </div>
            </div>

            <!-- Logo -->
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-10 text-4xl lg:text-6xl font-black tracking-widest pointer-events-none select-none whitespace-nowrap text-gold font-display">
                PEPE<span class="text-white">ROYAL</span>
            </div>

            <!-- Player Area -->
            <div class="flex flex-col items-center justify-end pb-4 w-full">
                <div id="player-hand" class="flex items-center justify-center pl-8 min-h-[110px] lg:min-h-[150px]">
                    <div class="card-slot opacity-20"></div>
                </div>
                <div id="player-score" class="score-bubble mt-2">0</div>
                <div class="text-[10px] font-bold text-gray-400 uppercase mt-1 tracking-widest">You</div>
            </div>

            <!-- Overlay Resultado -->
            <div id="resultOverlay" class="result-overlay">
                <div id="resultText" class="result-text text-white">WINNER</div>
                <div id="payoutText" class="text-xl font-bold text-green-400 mb-6 font-mono">+0.00 PBJ</div>
                <button onclick="resetGame()" class="px-8 py-3 bg-white text-black font-bold rounded hover:scale-105 transition shadow-[0_0_20px_rgba(255,255,255,0.3)] font-display uppercase tracking-widest">PLAY AGAIN</button>
            </div>
        </div>
    </div>

    <!-- AUDIO -->
    <audio id="sfx-flip" src="https://assets.mixkit.co/active_storage/sfx/2070/2070-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
    <audio id="sfx-lose" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

    <script>
        // ==================================================================
        // 1. SISTEMA DE CHIPS
        // ==================================================================
        let currentBalance = 0;

        function fixHeight() { document.querySelector('.game-wrapper').style.height = window.innerHeight + 'px'; }
        window.addEventListener('resize', fixHeight);
        fixHeight();

        window.addEventListener('message', (e) => {
            if (e.data.type === 'INIT_BALANCE' || e.data.type === 'SYNC_BALANCE') {
                updateBalanceUI(e.data.balance);
            }
        });

        function updateBalanceUI(newBal) {
            currentBalance = parseFloat(newBal);
            document.getElementById('balanceDisplay').innerText = currentBalance.toLocaleString(undefined, {minimumFractionDigits: 2});
        }

        function updateParent(amount) {
            window.parent.postMessage({ type: 'UPDATE_BALANCE', amount: amount }, '*');
        }

        // ==================================================================
        // 2. LÓGICA BLACKJACK (CON 10% HOUSE EDGE)
        // ==================================================================
        const suits = ['♠', '♥', '♦', '♣'];
        const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        
        let deck = [];
        let dealerHand = [];
        let playerHand = [];
        let gameActive = false;
        let currentBet = 0;

        function createDeck() {
            deck = [];
            for (let suit of suits) {
                for (let value of values) {
                    deck.push({ value, suit, weight: getWeight(value) });
                }
            }
            deck.sort(() => Math.random() - 0.5); 
        }

        function getWeight(v) {
            if (v === 'J' || v === 'Q' || v === 'K') return 10;
            if (v === 'A') return 11;
            return parseInt(v);
        }

        // --- RIGGING LOGIC (10% HOUSE EDGE) ---
        function getRiggedCard(targetHand, isDealer) {
            // House Edge logic: 10% chance to force a bad outcome for player
            const shouldRig = Math.random() < 0.15; // 15% attempt rate per card draw

            if (shouldRig) {
                const currentScore = calculateScore(targetHand);
                
                // Si es el Jugador y tiene mano peligrosa (12-16) -> Intentar BUST
                if (!isDealer && currentScore >= 12 && currentScore <= 16) {
                    // Buscar una figura (10) en el mazo
                    const badCardIndex = deck.findIndex(c => c.weight === 10);
                    if (badCardIndex > -1) return deck.splice(badCardIndex, 1)[0];
                }

                // Si es el Dealer y está perdiendo -> Intentar salvar (hacer 17-21)
                if (isDealer && currentScore < 17) {
                    const needed = 21 - currentScore;
                    // Buscar carta que no lo pase de 21
                    const goodCardIndex = deck.findIndex(c => c.weight <= needed && (currentScore + c.weight) >= 17);
                    if (goodCardIndex > -1) return deck.splice(goodCardIndex, 1)[0];
                }
            }
            
            // Si no se manipula, devolver carta normal
            return deck.pop();
        }

        function adjBet(m) {
            const el = document.getElementById('betInput');
            let v = parseFloat(el.value) * m;
            if(v<1) v=1; el.value = v.toFixed(0);
        }

        function renderCardHTML(card, hidden = false) {
            if (hidden) return `<div class="card card-hidden"></div>`;
            const color = (card.suit === '♥' || card.suit === '♦') ? 'red' : 'black';
            return `
                <div class="card ${color}">
                    <div class="card-val-top">${card.value}<br><span class="text-[10px] lg:text-xs">${card.suit}</span></div>
                    <div class="card-suit-center">${card.suit}</div>
                    <div class="card-val-bot">${card.value}<br><span class="text-[10px] lg:text-xs">${card.suit}</span></div>
                </div>
            `;
        }

        function updateUI(showHidden = false) {
            const dContainer = document.getElementById('dealer-hand');
            const pContainer = document.getElementById('player-hand');
            
            dContainer.innerHTML = dealerHand.map((c, i) => renderCardHTML(c, i === 0 && !showHidden)).join('');
            pContainer.innerHTML = playerHand.map(c => renderCardHTML(c)).join('');

            const pScore = calculateScore(playerHand);
            const dScore = calculateScore(dealerHand); 
            
            document.getElementById('player-score').innerText = pScore;
            document.getElementById('player-score').classList.add('visible');

            if(!showHidden && dealerHand.length > 0) {
                 // Si está oculta, mostrar solo el valor de la segunda carta (o algo dummy)
                 // Blackjack real: mostrar valor de carta visible.
                 // Aquí simplificamos mostrando "?" o el valor de la 2da carta
                 const visibleVal = dealerHand[1] ? dealerHand[1].weight : 0; 
                 document.getElementById('dealer-score').innerText = visibleVal; 
            } else {
                 document.getElementById('dealer-score').innerText = dScore;
            }
            document.getElementById('dealer-score').classList.add('visible');
        }

        function calculateScore(hand) {
            let score = 0;
            let aces = 0;
            for (let card of hand) {
                score += card.weight;
                if (card.value === 'A') aces++;
            }
            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }
            return score;
        }

        function playSound(id) {
            const s = document.getElementById(id);
            if(s) { s.currentTime = 0; s.play().catch(()=>{}); }
        }

        // --- GAME FLOW ---
        function startGame() {
            const bet = parseFloat(document.getElementById('betInput').value);
            if(isNaN(bet) || bet <= 0) return;
            if(bet > currentBalance) {
                const grp = document.querySelector('.input-group');
                grp.style.borderColor = 'red';
                setTimeout(() => grp.style.borderColor = 'rgba(255,255,255,0.1)', 500);
                return;
            }
            if(gameActive) return;

            currentBet = bet;
            updateBalanceUI(currentBalance - currentBet);
            updateParent(-currentBet);

            createDeck();
            dealerHand = [];
            playerHand = [];
            gameActive = true;
            document.getElementById('btnDouble').classList.remove('btn-disabled');

            document.getElementById('betControls').classList.add('hidden');
            document.getElementById('playControls').classList.remove('hidden');
            document.getElementById('resultOverlay').classList.remove('active');

            // Reparto inicial
            dealCard(playerHand, false);
            setTimeout(() => dealCard(dealerHand, true), 300);
            setTimeout(() => dealCard(playerHand, false), 600);
            setTimeout(() => {
                dealCard(dealerHand, true);
                updateUI(false); 
                checkNaturalBlackjack();
            }, 900);
        }

        function dealCard(hand, isDealer) {
            // Usar RNG Rigged
            const card = getRiggedCard(hand, isDealer);
            hand.push(card);
            updateUI(false); // Mantener oculto si es necesario
            playSound('sfx-flip');
        }

        function checkNaturalBlackjack() {
            const pScore = calculateScore(playerHand);
            if(pScore === 21) {
                stand(); 
            }
        }

        function hit() {
            if(!gameActive) return;
            document.getElementById('btnDouble').classList.add('btn-disabled'); 
            dealCard(playerHand, false);
            
            const score = calculateScore(playerHand);
            if(score > 21) {
                endGame('BUST');
            } else if (score === 21) {
                setTimeout(stand, 500); 
            }
        }

        function doubleDown() {
            if(playerHand.length !== 2) return;
            if(currentBalance < currentBet) return alert("Not enough balance");
            
            updateBalanceUI(currentBalance - currentBet);
            updateParent(-currentBet);
            currentBet *= 2;
            
            dealCard(playerHand, false);
            
            const score = calculateScore(playerHand);
            if(score > 21) endGame('BUST');
            else setTimeout(stand, 800);
        }

        function stand() {
            if(!gameActive) return;
            gameActive = false; 
            
            updateUI(true); // Revelar

            const dealLoop = setInterval(() => {
                const dScore = calculateScore(dealerHand);
                if(dScore < 17) {
                    dealCard(dealerHand, true);
                    updateUI(true);
                } else {
                    clearInterval(dealLoop);
                    determineWinner();
                }
            }, 800);
        }

        function determineWinner() {
            const pScore = calculateScore(playerHand);
            const dScore = calculateScore(dealerHand);

            if(dScore > 21) endGame('WIN'); 
            else if (pScore > dScore) endGame('WIN');
            else if (pScore === dScore) endGame('PUSH');
            else endGame('LOSE');
        }

        function endGame(result) {
            gameActive = false;
            updateUI(true); 
            
            let payout = 0;
            let text = "";
            let color = "";
            let sound = 'sfx-lose';

            if(result === 'BUST') {
                text = "BUSTED"; color = "text-red-500";
            } else if (result === 'LOSE') {
                text = "DEALER WINS"; color = "text-red-500";
            } else if (result === 'PUSH') {
                text = "PUSH"; color = "text-yellow-400";
                payout = currentBet;
                sound = 'sfx-flip'; 
            } else if (result === 'WIN') {
                text = "YOU WIN!"; color = "text-green-400";
                const isBJ = (playerHand.length === 2 && calculateScore(playerHand) === 21);
                payout = isBJ ? currentBet * 2.5 : currentBet * 2;
                if(isBJ) text = "BLACKJACK!";
                sound = 'sfx-win';
            }

            if(payout > 0) {
                updateBalanceUI(currentBalance + payout);
                updateParent(payout);
            }

            setTimeout(() => {
                playSound(sound);
                const ov = document.getElementById('resultOverlay');
                const title = document.getElementById('resultText');
                const pay = document.getElementById('payoutText');
                
                title.innerText = text;
                title.className = `result-text ${color}`;
                pay.innerText = payout > 0 ? `+${payout.toLocaleString()} PBJ` : `-${currentBet.toLocaleString()} PBJ`;
                pay.className = payout > 0 ? "text-xl font-bold text-green-400 mb-6 font-mono" : "text-xl font-bold text-red-400 mb-6 font-mono";
                
                ov.classList.add('active');
            }, 500);
        }

        function resetGame() {
            document.getElementById('resultOverlay').classList.remove('active');
            document.getElementById('playControls').classList.add('hidden');
            document.getElementById('betControls').classList.remove('hidden');
            
            playerHand = [];
            dealerHand = [];
            document.getElementById('player-score').classList.remove('visible');
            document.getElementById('dealer-score').classList.remove('visible');
            
            document.getElementById('dealer-hand').innerHTML = '<div class="card-slot opacity-20"></div>';
            document.getElementById('player-hand').innerHTML = '<div class="card-slot opacity-20"></div>';
        }
    </script>
</body>
</html>
