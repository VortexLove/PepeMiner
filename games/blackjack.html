<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Viewport optimizado para evitar zoom y scroll elástico en móvil -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blackjack | PepeCasino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS GENERALES Y RESPONSIVE --- */
        body { 
            background: transparent; color: white; font-family: 'Inter', sans-serif;
            overflow: hidden; user-select: none; height: 100vh; margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: center;
            touch-action: none; /* Bloquea gestos del navegador */
        }

        .game-wrapper {
            width: 100%; height: 100%;
            background: #121924; 
            display: flex; flex-direction: column-reverse; /* MÓVIL: Controles abajo */
            overflow: hidden;
            position: relative;
        }

        /* En Pantallas Grandes (Desktop) recuperamos el diseño original */
        @media (min-width: 1024px) {
            .game-wrapper {
                max-width: 1100px; height: 650px;
                border: 1px solid #1f2937; border-radius: 20px;
                flex-direction: row; /* DESKTOP: Controles izquierda */
                box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            }
        }

        /* --- CONTROLES --- */
        .controls { 
            background: #0b1016; 
            padding: 15px; 
            display: flex; flex-direction: column; gap: 10px; 
            border-top: 1px solid #1f2937; 
            z-index: 20;
            flex-shrink: 0; /* No encoger controles */
        }

        @media (min-width: 1024px) {
            .controls {
                width: 300px; height: 100%;
                border-top: none; border-right: 1px solid #1f2937;
                padding: 24px; gap: 20px;
            }
        }

        /* --- MESA DE JUEGO --- */
        .stage { 
            position: relative; 
            background: radial-gradient(circle at 50% 50%, #064e3b 0%, #022c22 100%);
            flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: space-between; 
            padding: 20px 10px;
            overflow-y: auto; /* Seguridad por si las cartas se salen */
        }

        /* --- UI COMPONENTES --- */
        .input-group { background: #05080a; border: 1px solid #1f2937; border-radius: 8px; padding: 5px; display: flex; align-items: center; }
        .input-clean { background: transparent; width: 100%; border: none; color: white; padding: 8px; font-weight: bold; outline: none; font-size: 14px; }
        
        .btn-action { 
            width: 100%; padding: 12px; border-radius: 8px; 
            font-weight: 900; text-transform: uppercase; transition: 0.1s; 
            letter-spacing: 0.5px; font-size: 14px;
            touch-action: manipulation; /* Mejor respuesta tactil */
        }
        @media (min-width: 1024px) { .btn-action { padding: 15px; border-radius: 12px; letter-spacing: 1px; font-size: 16px; } }

        .btn-deal { background: #00ff2a; color: black; box-shadow: 0 0 15px rgba(0,255,42,0.2); }
        .btn-deal:active { transform: scale(0.98); }
        
        .game-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: auto; }
        .btn-hit { background: #3b82f6; color: white; }
        .btn-stand { background: #eab308; color: black; }
        .btn-double { grid-column: span 2; background: #a855f7; color: white; }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }

        /* --- CARTAS RESPONSIVAS --- */
        /* MÓVIL (Por defecto) */
        .card-slot { width: 70px; height: 100px; border: 2px dashed rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        
        .card {
            width: 70px; height: 100px; background: white; border-radius: 6px;
            color: black; position: relative; font-family: 'Space Grotesk', sans-serif;
            box-shadow: -2px 2px 8px rgba(0,0,0,0.4);
            transition: transform 0.3s; 
            margin-left: -35px; /* Solapamiento móvil */
            display: flex; flex-direction: column; justify-content: space-between; padding: 4px;
            animation: deal 0.4s ease-out;
        }
        
        .card-val-top { font-size: 14px; font-weight: bold; line-height: 1; }
        .card-suit-center { font-size: 24px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .card-val-bot { font-size: 14px; font-weight: bold; line-height: 1; transform: rotate(180deg); }

        /* DESKTOP (Sobreescribir) */
        @media (min-width: 1024px) {
            .card-slot { width: 100px; height: 140px; border-radius: 10px; }
            .card {
                width: 100px; height: 140px; border-radius: 8px; padding: 8px;
                margin-left: -50px; /* Solapamiento Desktop */
                box-shadow: -5px 5px 15px rgba(0,0,0,0.5);
            }
            .card:hover { transform: translateY(-15px) !important; z-index: 10; }
            .card-val-top { font-size: 18px; }
            .card-suit-center { font-size: 36px; }
            .card-val-bot { font-size: 18px; }
        }

        .card:first-child { margin-left: 0; }
        .card.red { color: #dc2626; }
        .card.black { color: #000; }

        .card-hidden {
            background: repeating-linear-gradient(45deg, #1f2937, #1f2937 5px, #374151 5px, #374151 10px);
            border: 2px solid #4b5563; color: transparent;
        }

        @keyframes deal { from { opacity: 0; transform: translateY(-50px) translateX(50px) rotate(10deg); } to { opacity: 1; transform: translateY(0) rotate(0); } }

        /* --- SCORE BUBBLES --- */
        .score-bubble {
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2);
            padding: 2px 10px; border-radius: 20px; font-weight: bold; font-size: 12px;
            margin-bottom: 5px; color: #fbbf24; backdrop-filter: blur(4px);
            transition: 0.3s; opacity: 0;
        }
        @media (min-width: 1024px) { .score-bubble { padding: 5px 15px; font-size: 14px; margin-bottom: 10px; } }
        .score-bubble.visible { opacity: 1; }

        /* --- RESULT OVERLAY --- */
        .result-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .result-overlay.active { opacity: 1; pointer-events: auto; }
        .result-text { font-size: 2.5rem; font-weight: 900; text-transform: uppercase; margin-bottom: 10px; text-shadow: 0 5px 15px rgba(0,0,0,0.5); transform: scale(0.8); transition: 0.3s; }
        .result-overlay.active .result-text { transform: scale(1); }
    </style>
</head>
<body>

    <div class="game-wrapper">
        <!-- CONTROLES (Abajo en Móvil / Izquierda en Desktop) -->
        <div class="controls">
            <!-- Sección Apuesta -->
            <div>
                <div class="flex justify-between text-[10px] font-bold text-gray-500 uppercase mb-1">
                    <span>Bet Amount</span>
                    <span id="balanceDisplay">Loading...</span>
                </div>
                <div class="input-group">
                    <i class="fas fa-coins text-gray-500 ml-3 text-xs"></i>
                    <input type="number" id="betInput" value="10" class="input-clean">
                    <div class="flex gap-1 pr-1">
                        <button onclick="adjBet(0.5)" class="px-2 py-1 bg-[#1a242d] rounded text-[10px] font-bold text-gray-400 hover:text-white border border-white/5">½</button>
                        <button onclick="adjBet(2)" class="px-2 py-1 bg-[#1a242d] rounded text-[10px] font-bold text-gray-400 hover:text-white border border-white/5">2x</button>
                    </div>
                </div>
            </div>

            <!-- Botón DEAL -->
            <div id="betControls" class="mt-auto">
                <button onclick="startGame()" class="btn-action btn-deal shadow-lg">DEAL CARDS</button>
            </div>

            <!-- Botones JUEGO -->
            <div id="playControls" class="game-actions hidden mt-auto">
                <button onclick="hit()" class="btn-action btn-hit shadow-lg">HIT</button>
                <button onclick="stand()" class="btn-action btn-stand shadow-lg">STAND</button>
                <button id="btnDouble" onclick="doubleDown()" class="btn-action btn-double shadow-lg">DOUBLE</button>
            </div>
            
            <!-- Info Footer -->
            <div class="hidden lg:block mt-auto text-xs text-gray-600 text-center">
                Blackjack Pays 3:2 • Dealer stands on 17
            </div>
        </div>

        <!-- MESA DE JUEGO (Arriba en Móvil / Derecha en Desktop) -->
        <div class="stage">
            <!-- Dealer Area -->
            <div class="flex flex-col items-center justify-start pt-4 w-full">
                <div class="text-[10px] font-bold text-gray-400 uppercase mb-1">Dealer</div>
                <div id="dealer-score" class="score-bubble">0</div>
                <div id="dealer-hand" class="flex items-center justify-center pl-8 min-h-[110px] lg:min-h-[150px]">
                    <!-- Cartas Dealer -->
                    <div class="card-slot opacity-20"></div>
                </div>
            </div>

            <!-- Logo Central -->
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5 text-4xl lg:text-6xl font-black tracking-widest pointer-events-none select-none whitespace-nowrap">
                PEPEBJ
            </div>

            <!-- Player Area -->
            <div class="flex flex-col items-center justify-end pb-4 w-full">
                <div id="player-hand" class="flex items-center justify-center pl-8 min-h-[110px] lg:min-h-[150px]">
                    <!-- Cartas Player -->
                    <div class="card-slot opacity-20"></div>
                </div>
                <div id="player-score" class="score-bubble mt-2">0</div>
                <div class="text-[10px] font-bold text-gray-400 uppercase mt-1">You</div>
            </div>

            <!-- Overlay Resultado -->
            <div id="resultOverlay" class="result-overlay">
                <div id="resultText" class="result-text text-white">WINNER</div>
                <div id="payoutText" class="text-xl font-bold text-green-400 mb-6">+0.00 PBJ</div>
                <button onclick="resetGame()" class="px-8 py-3 bg-white text-black font-bold rounded-full hover:scale-105 transition shadow-[0_0_20px_rgba(255,255,255,0.3)]">PLAY AGAIN</button>
            </div>
        </div>
    </div>

    <!-- AUDIO -->
    <audio id="sfx-flip" src="https://assets.mixkit.co/active_storage/sfx/2070/2070-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
    <audio id="sfx-lose" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

    <script>
        // --- COMUNICACIÓN IFRAME ---
        let userBalance = 0;
        
        // Ajuste dinámico de altura para móviles con barras de navegación
        function fixHeight() {
            document.querySelector('.game-wrapper').style.height = window.innerHeight + 'px';
        }
        window.addEventListener('resize', fixHeight);
        fixHeight();

        window.addEventListener('message', (e) => {
            if (e.data.type === 'INIT_BALANCE' || e.data.type === 'SYNC_BALANCE') {
                userBalance = e.data.balance;
                const balEl = document.getElementById('balanceDisplay');
                if(balEl) balEl.innerText = userBalance.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:2});
            }
        });
        function updateParent(amount) { window.parent.postMessage({ type: 'UPDATE_BALANCE', amount: amount }, '*'); }

        // --- LÓGICA BLACKJACK (Intacta) ---
        const suits = ['♠', '♥', '♦', '♣'];
        const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        
        let deck = [];
        let dealerHand = [];
        let playerHand = [];
        let gameActive = false;
        let currentBet = 0;

        function createDeck() {
            deck = [];
            for (let suit of suits) {
                for (let value of values) {
                    deck.push({ value, suit, weight: getWeight(value) });
                }
            }
            deck.sort(() => Math.random() - 0.5); 
        }

        function getWeight(v) {
            if (v === 'J' || v === 'Q' || v === 'K') return 10;
            if (v === 'A') return 11;
            return parseInt(v);
        }

        function adjBet(m) {
            const el = document.getElementById('betInput');
            let v = parseFloat(el.value) * m;
            if(v<1) v=1; el.value = v.toFixed(0);
        }

        // RENDER CARTAS
        function renderCardHTML(card, hidden = false) {
            if (hidden) return `<div class="card card-hidden"></div>`;
            const color = (card.suit === '♥' || card.suit === '♦') ? 'red' : 'black';
            return `
                <div class="card ${color}">
                    <div class="card-val-top">${card.value}<br><span class="text-[10px] lg:text-xs">${card.suit}</span></div>
                    <div class="card-suit-center">${card.suit}</div>
                    <div class="card-val-bot">${card.value}<br><span class="text-[10px] lg:text-xs">${card.suit}</span></div>
                </div>
            `;
        }

        function updateUI(showHidden = false) {
            const dContainer = document.getElementById('dealer-hand');
            const pContainer = document.getElementById('player-hand');
            
            dContainer.innerHTML = dealerHand.map((c, i) => renderCardHTML(c, i === 0 && !showHidden)).join('');
            pContainer.innerHTML = playerHand.map(c => renderCardHTML(c)).join('');

            const pScore = calculateScore(playerHand);
            const dScore = calculateScore(dealerHand); 
            
            document.getElementById('player-score').innerText = pScore;
            document.getElementById('player-score').classList.add('visible');

            if(!showHidden && dealerHand.length > 0) {
                 document.getElementById('dealer-score').innerText = getWeight(dealerHand[1].value); 
            } else {
                 document.getElementById('dealer-score').innerText = dScore;
            }
            document.getElementById('dealer-score').classList.add('visible');
        }

        function calculateScore(hand) {
            let score = 0;
            let aces = 0;
            for (let card of hand) {
                score += card.weight;
                if (card.value === 'A') aces++;
            }
            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }
            return score;
        }

        function playSound(id) {
            const s = document.getElementById(id);
            s.currentTime = 0; s.play().catch(()=>{});
        }

        // --- GAME FLOW ---
        function startGame() {
            const bet = parseFloat(document.getElementById('betInput').value);
            if(bet > userBalance) return alert("Insufficient funds");
            if(gameActive) return;

            currentBet = bet;
            updateParent(-currentBet);
            createDeck();
            dealerHand = [];
            playerHand = [];
            gameActive = true;
            document.getElementById('btnDouble').classList.remove('btn-disabled');

            document.getElementById('betControls').classList.add('hidden');
            document.getElementById('playControls').classList.remove('hidden');
            document.getElementById('resultOverlay').classList.remove('active');

            dealCard(playerHand);
            setTimeout(() => dealCard(dealerHand), 300);
            setTimeout(() => dealCard(playerHand), 600);
            setTimeout(() => {
                dealCard(dealerHand);
                updateUI(false); 
                checkNaturalBlackjack();
            }, 900);
        }

        function dealCard(hand) {
            const card = deck.pop();
            hand.push(card);
            updateUI(false);
            playSound('sfx-flip');
        }

        function checkNaturalBlackjack() {
            const pScore = calculateScore(playerHand);
            if(pScore === 21) {
                stand(); 
            }
        }

        function hit() {
            if(!gameActive) return;
            document.getElementById('btnDouble').classList.add('btn-disabled'); 
            dealCard(playerHand);
            
            const score = calculateScore(playerHand);
            if(score > 21) {
                endGame('BUST');
            } else if (score === 21) {
                setTimeout(stand, 500); 
            }
        }

        function doubleDown() {
            if(playerHand.length !== 2) return;
            if(userBalance < currentBet) return alert("Not enough balance");
            
            updateParent(-currentBet);
            currentBet *= 2;
            
            dealCard(playerHand);
            
            const score = calculateScore(playerHand);
            if(score > 21) endGame('BUST');
            else setTimeout(stand, 800);
        }

        function stand() {
            if(!gameActive) return;
            gameActive = false; 
            
            updateUI(true); 

            const dealLoop = setInterval(() => {
                const dScore = calculateScore(dealerHand);
                if(dScore < 17) {
                    dealCard(dealerHand);
                    updateUI(true);
                } else {
                    clearInterval(dealLoop);
                    determineWinner();
                }
            }, 800);
        }

        function determineWinner() {
            const pScore = calculateScore(playerHand);
            const dScore = calculateScore(dealerHand);

            if(dScore > 21) endGame('WIN'); 
            else if (pScore > dScore) endGame('WIN');
            else if (pScore === dScore) endGame('PUSH');
            else endGame('LOSE');
        }

        function endGame(result) {
            gameActive = false;
            updateUI(true); 
            
            let payout = 0;
            let text = "";
            let color = "";
            let sound = 'sfx-lose';

            if(result === 'BUST') {
                text = "BUSTED"; color = "text-red-500";
            } else if (result === 'LOSE') {
                text = "DEALER WINS"; color = "text-red-500";
            } else if (result === 'PUSH') {
                text = "PUSH"; color = "text-yellow-400";
                payout = currentBet;
                sound = 'sfx-flip'; 
            } else if (result === 'WIN') {
                text = "YOU WIN!"; color = "text-green-400";
                const isBJ = (playerHand.length === 2 && calculateScore(playerHand) === 21);
                payout = isBJ ? currentBet * 2.5 : currentBet * 2;
                if(isBJ) text = "BLACKJACK!";
                sound = 'sfx-win';
            }

            if(payout > 0) updateParent(payout);

            setTimeout(() => {
                playSound(sound);
                const ov = document.getElementById('resultOverlay');
                const title = document.getElementById('resultText');
                const pay = document.getElementById('payoutText');
                
                title.innerText = text;
                title.className = `result-text ${color}`;
                pay.innerText = payout > 0 ? `+${payout.toLocaleString()} PBJ` : `-${currentBet.toLocaleString()} PBJ`;
                pay.className = payout > 0 ? "text-xl font-bold text-green-400 mb-6" : "text-xl font-bold text-red-400 mb-6";
                
                ov.classList.add('active');
            }, 500);
        }

        function resetGame() {
            document.getElementById('resultOverlay').classList.remove('active');
            document.getElementById('playControls').classList.add('hidden');
            document.getElementById('betControls').classList.remove('hidden');
            
            playerHand = [];
            dealerHand = [];
            document.getElementById('player-score').classList.remove('visible');
            document.getElementById('dealer-score').classList.remove('visible');
            
            document.getElementById('dealer-hand').innerHTML = '<div class="card-slot opacity-20"></div>';
            document.getElementById('player-hand').innerHTML = '<div class="card-slot opacity-20"></div>';
        }
    </script>
</body>
</html>
