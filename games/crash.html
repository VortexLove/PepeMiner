<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Viewport estricto para evitar zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crash Royal | PepeCasino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700;900&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pepe-dark': '#020202',
                        'pepe-panel': '#121212',
                        'royal-gold': '#FFD700',
                    },
                    fontFamily: {
                        'display': ['Chakra Petch', 'sans-serif'],
                        'body': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background: transparent; color: white; font-family: 'Inter', sans-serif;
            overflow: hidden; user-select: none; height: 100vh; margin: 0;
            touch-action: none;
        }

        .game-wrapper {
            width: 100%; height: 100%;
            background: #020202; 
            display: flex; flex-direction: column-reverse; /* MÓVIL: Controles abajo */
            position: relative;
        }

        /* En PC: Diseño Horizontal */
        @media (min-width: 1024px) {
            .game-wrapper {
                flex-direction: row; /* PC: Controles izquierda */
                max-width: 1200px; height: 700px;
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 16px;
                margin: auto; /* Centrado */
                background: #050505;
                box-shadow: 0 0 50px rgba(0,0,0,0.8);
            }
        }

        /* --- CONTROLES --- */
        .controls { 
            background: #080808; 
            padding: 16px; 
            display: flex; flex-direction: column; gap: 12px; 
            border-top: 1px solid rgba(255, 215, 0, 0.1);
            z-index: 20;
            flex-shrink: 0;
        }

        @media (min-width: 1024px) {
            .controls {
                width: 320px; height: 100%;
                border-top: none; border-right: 1px solid rgba(255, 215, 0, 0.1);
                padding: 30px; gap: 20px;
            }
        }

        .input-group { 
            background: #121212; border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 8px; padding: 4px; display: flex; align-items: center; 
            transition: 0.3s;
        }
        .input-group:focus-within { border-color: #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
        .input-clean { background: transparent; width: 100%; border: none; color: white; padding: 12px; font-weight: bold; outline: none; font-family: 'Chakra Petch'; }

        .btn-action {
            width: 100%; padding: 16px; border-radius: 8px; font-weight: 900; font-size: 1.1rem;
            text-transform: uppercase; transition: 0.2s; letter-spacing: 1px; font-family: 'Chakra Petch';
            position: relative; overflow: hidden;
        }
        
        .btn-bet { 
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); 
            color: black; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            border: 1px solid #FFE4B5;
        }
        .btn-bet:active { transform: scale(0.98); filter: brightness(0.9); }
        
        .btn-cashout { 
            background: #22c55e; color: black; 
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); 
            animation: pulse 1s infinite; 
            border: 1px solid #86efac;
        }
        
        .btn-disabled { background: #1f2937; color: #6b7280; cursor: not-allowed; box-shadow: none; border: 1px solid #374151; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* --- STAGE / GRAPH --- */
        .stage { 
            position: relative; flex: 1; overflow: hidden; 
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at 50% 100%, #1a1a00 0%, #020202 70%);
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* --- UI OVERLAYS --- */
        .overlay-ui { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .mult-number { 
            font-size: 4rem; font-weight: 900; font-family: 'Chakra Petch', sans-serif; 
            tabular-nums; text-shadow: 0 0 20px rgba(255, 215, 0, 0.3); 
        }
        @media (min-width: 1024px) { .mult-number { font-size: 6rem; } }

        .crashed-text { color: #ef4444; text-shadow: 0 0 20px rgba(239, 68, 68, 0.6); transform: scale(1.1); transition: 0.3s; }
        
        .history-bar { 
            position: absolute; top: 15px; right: 15px; 
            display: flex; flex-direction: column-reverse; gap: 5px; z-index: 10; 
            max-height: 200px; overflow: hidden;
        }
        @media (min-width: 1024px) { .history-bar { flex-direction: row; } }

        .pill { 
            padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; 
            background: rgba(255,255,255,0.05); color: #9ca3af; border: 1px solid rgba(255,255,255,0.1);
            font-family: 'Chakra Petch';
        }
        .pill.win { color: #FFD700; border-color: #FFD700; }
        .pill.loss { color: #ef4444; border-color: #ef4444; }

        /* NOTIFICACION GANADOR */
        .cashout-notif {
            position: absolute; bottom: 30%; 
            background: rgba(0, 0, 0, 0.8); 
            border: 1px solid #FFD700; color: #FFD700; 
            padding: 15px 30px; border-radius: 12px; 
            font-weight: 900; font-size: 1.5rem; font-family: 'Chakra Petch';
            animation: slideUp 0.4s ease-out forwards;
            opacity: 0; transform: translateY(20px); backdrop-filter: blur(5px);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
            text-align: center;
        }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="game-wrapper">
        <!-- CONTROLES (Abajo en móvil / Izquierda en PC) -->
        <div class="controls">
            <!-- Balance Info -->
            <div class="flex justify-between items-center bg-[#121212] p-2 rounded border border-white/5">
                <span class="text-[10px] text-gray-500 font-bold uppercase">Balance</span>
                <span class="text-gold font-mono font-bold" id="balanceDisplay">Loading...</span>
            </div>

            <!-- Inputs -->
            <div class="space-y-4 flex-1 lg:flex-none flex flex-col justify-center">
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Bet Amount</label>
                    <div class="input-group">
                        <input type="number" id="betInput" value="100" class="input-clean">
                        <div class="flex gap-1 pr-1">
                            <button onclick="adjBet(0.5)" class="px-3 py-1 bg-[#222] rounded text-[10px] font-bold text-gray-400 hover:text-white border border-white/5">½</button>
                            <button onclick="adjBet(2)" class="px-3 py-1 bg-[#222] rounded text-[10px] font-bold text-gray-400 hover:text-white border border-white/5">2x</button>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Auto Cashout (x)</label>
                    <div class="input-group">
                        <input type="number" id="autoCashout" value="2.00" step="0.1" class="input-clean text-gold">
                    </div>
                </div>
            </div>

            <!-- Info Profit -->
            <div class="grid grid-cols-2 gap-2 mt-2">
                <div class="bg-[#121212] p-2 rounded text-center border border-white/5">
                    <p class="text-[9px] text-gray-500 uppercase">Potential Win</p>
                    <p class="text-sm font-bold text-green-400 font-mono" id="potentialProfit">0.00</p>
                </div>
                <div class="bg-[#121212] p-2 rounded text-center border border-white/5">
                    <p class="text-[9px] text-gray-500 uppercase">Status</p>
                    <p class="text-xs font-bold text-white uppercase tracking-widest" id="gameStatus">Ready</p>
                </div>
            </div>

            <!-- Boton Principal -->
            <button id="mainBtn" onclick="handleAction()" class="btn-action btn-bet shadow-lg mt-auto">PLACE BET</button>
        </div>

        <!-- ESCENARIO DE JUEGO -->
        <div class="stage" id="stageContainer">
            <div class="history-bar" id="historyBar"></div>
            
            <canvas id="gameCanvas"></canvas>
            
            <!-- Texto Central -->
            <div class="overlay-ui">
                <div id="multiplierText" class="mult-number text-white">1.00x</div>
                <div id="statusLabel" class="text-xs font-bold tracking-[0.3em] text-gray-600 mt-2">NEXT ROUND</div>
            </div>
            
            <!-- Notificación Ganadora -->
            <div id="cashoutNotif" class="cashout-notif hidden"></div>
        </div>
    </div>

    <!-- AUDIO -->
    <audio id="sfx-engine" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" loop></audio>
    <audio id="sfx-crash" src="https://assets.mixkit.co/active_storage/sfx/1707/1707-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

    <script>
        // --- COMUNICACIÓN IFRAME ---
        let userBalance = 0;
        
        // Ajuste de altura para móviles
        function fixHeight() {
            document.querySelector('.game-wrapper').style.height = window.innerHeight + 'px';
        }
        window.addEventListener('resize', fixHeight);
        fixHeight();

        window.addEventListener('message', (e) => {
            if (e.data.type === 'INIT_BALANCE' || e.data.type === 'SYNC_BALANCE') {
                userBalance = e.data.balance;
                document.getElementById('balanceDisplay').innerText = userBalance.toLocaleString(undefined, {minimumFractionDigits:2});
            }
        });
        function updateParent(amount) { window.parent.postMessage({ type: 'UPDATE_BALANCE', amount: amount }, '*'); }

        // --- MOTOR DEL JUEGO CRASH ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const multText = document.getElementById('multiplierText');
        const mainBtn = document.getElementById('mainBtn');
        const profitDisplay = document.getElementById('potentialProfit');

        // Variables de Estado
        let gameState = 'IDLE'; 
        let currentMultiplier = 1.00;
        let crashPoint = 0;
        let startTime = 0;
        let betAmount = 0;
        let cashedOut = false;
        let particles = [];
        let rocketY = 0;

        // INIT
        window.onload = () => {
            resize();
            animate();
            window.addEventListener('resize', resize);
        };
        
        function resize() {
            canvas.width = document.getElementById('stageContainer').clientWidth;
            canvas.height = document.getElementById('stageContainer').clientHeight;
        }

        // --- LÓGICA DE JUEGO (HOUSE EDGE 10%) ---
        function generateCrashPoint() {
            // 1. Instant Crash (House takes all): 5% de probabilidad de crashear en 1.00x
            if (Math.random() < 0.05) return 1.00;

            // 2. Distribución con Edge del 5% adicional (Total ~10% edge)
            // Formula justa: 0.99 / (1-r)
            // Formula Casa: 0.95 / (1-r)
            const r = Math.random();
            const crash = 0.95 / (1 - r);
            
            return Math.max(1.00, crash);
        }

        function handleAction() {
            if (gameState === 'IDLE' || gameState === 'CRASHED') startGame();
            else if (gameState === 'RUNNING') cashOut();
        }

        function adjBet(m) {
            const el = document.getElementById('betInput');
            let v = parseFloat(el.value) * m;
            if(v<1) v=1; el.value = v.toFixed(0);
        }

        function startGame() {
            const bet = parseFloat(document.getElementById('betInput').value);
            if(isNaN(bet) || bet <= 0) return alert("Invalid Bet");
            if(bet > userBalance) return alert("Insufficient Balance");

            // Descontar apuesta
            betAmount = bet;
            updateParent(-betAmount);

            // Reset Variables
            gameState = 'RUNNING';
            cashedOut = false;
            currentMultiplier = 1.00;
            startTime = Date.now();
            crashPoint = generateCrashPoint();
            particles = [];
            
            // UI Update
            mainBtn.innerText = "CASHOUT";
            mainBtn.className = "btn-action btn-cashout";
            document.getElementById('betInput').disabled = true;
            document.getElementById('cashoutNotif').classList.add('hidden');
            document.getElementById('statusLabel').innerText = "TO THE MOON";
            multText.className = "mult-number text-white";
            document.getElementById('gameStatus').innerText = "LIVE";
            document.getElementById('gameStatus').className = "text-xs font-bold text-green-500 animate-pulse uppercase tracking-widest";

            // Audio loop
            // document.getElementById('sfx-engine').currentTime = 0;
            // document.getElementById('sfx-engine').play().catch(()=>{});
        }

        function cashOut() {
            if(gameState !== 'RUNNING' || cashedOut) return;
            cashedOut = true;

            const win = betAmount * currentMultiplier;
            const profit = win - betAmount;
            updateParent(win); // Devolver apuesta + ganancia
            
            document.getElementById('sfx-win').play().catch(()=>{});

            // UI Feedback
            mainBtn.innerText = "WAIT FOR NEXT ROUND";
            mainBtn.className = "btn-action btn-disabled";
            
            const notif = document.getElementById('cashoutNotif');
            notif.innerHTML = `
                <div class="text-xs text-gray-400 uppercase tracking-widest mb-1">Cashed Out</div>
                <div class="text-white">+${win.toLocaleString(undefined, {maximumFractionDigits:0})} PBJ</div>
            `;
            notif.classList.remove('hidden');
        }

        function crash() {
            gameState = 'CRASHED';
            // document.getElementById('sfx-engine').pause();
            document.getElementById('sfx-crash').play().catch(()=>{});

            // Explosion
            createExplosion(canvas.width * 0.7, getRocketY(Date.now() - startTime));

            // UI
            multText.innerText = crashPoint.toFixed(2) + "x";
            multText.classList.add('crashed-text');
            document.getElementById('statusLabel').innerText = "CRASHED";
            
            mainBtn.innerText = "PLACE BET";
            mainBtn.className = "btn-action btn-bet";
            document.getElementById('betInput').disabled = false;
            document.getElementById('gameStatus').innerText = "ENDED";
            document.getElementById('gameStatus').className = "text-xs font-bold text-red-500 uppercase tracking-widest";

            addToHistory(crashPoint);
        }

        // --- RENDER LOOP ---
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Grid de fondo
            drawGrid();

            if (gameState === 'RUNNING') {
                const now = Date.now();
                const elapsed = (now - startTime) / 1000;
                
                // Función de crecimiento (Exponential simple)
                currentMultiplier = 1.0 + (elapsed * elapsed * 0.1) + (elapsed * 0.05);
                
                // Update UI
                multText.innerText = currentMultiplier.toFixed(2) + "x";
                if(!cashedOut) {
                    profitDisplay.innerText = ((currentMultiplier * betAmount) - betAmount).toFixed(2);
                }
                
                // Color dinámico
                if(currentMultiplier >= 2) multText.style.color = "#FFD700";
                
                // Auto Cashout Check
                const auto = parseFloat(document.getElementById('autoCashout').value);
                if(!cashedOut && auto && currentMultiplier >= auto) cashOut();

                // Crash Check
                if(currentMultiplier >= crashPoint) crash();

                // Dibujar Gráfico
                drawGraph(elapsed, currentMultiplier);
                
            } else {
                // Estado IDLE o CRASHED (Dibujar línea base estática)
                drawParticles(); // Si quedan partículas de explosión
            }

            requestAnimationFrame(animate);
        }

        function drawGrid() {
            ctx.strokeStyle = "rgba(255, 255, 255, 0.05)";
            ctx.lineWidth = 1;
            // Horizontal lines
            for(let i=0; i<canvas.height; i+=50) {
                ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(canvas.width, i); ctx.stroke();
            }
            // Vertical lines
            for(let i=0; i<canvas.width; i+=50) {
                ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke();
            }
        }

        function getRocketY(elapsedMs) {
            // Simular curva hacia arriba (invertido porque Y=0 es arriba)
            // Limitamos para que no se salga de pantalla
            const progress = Math.min(1, elapsedMs / 8000); 
            return canvas.height - 50 - (progress * (canvas.height - 150));
        }

        function drawGraph(elapsed, mult) {
            const x = Math.min(canvas.width * 0.8, 50 + (elapsed * 30));
            const y = getRocketY(elapsed * 1000);

            // Línea
            ctx.beginPath();
            ctx.strokeStyle = cashedOut ? "rgba(255, 215, 0, 0.3)" : "#FFD700";
            ctx.lineWidth = 4;
            ctx.moveTo(0, canvas.height);
            ctx.quadraticCurveTo(x/2, canvas.height, x, y);
            ctx.stroke();

            // Relleno bajo la curva
            ctx.lineTo(x, canvas.height);
            ctx.lineTo(0, canvas.height);
            ctx.fillStyle = cashedOut ? "rgba(255, 215, 0, 0.05)" : "rgba(255, 215, 0, 0.1)";
            ctx.fill();

            // Cohete (Circulo brillante por ahora)
            if(!cashedOut) {
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI*2);
                ctx.fillStyle = "white";
                ctx.fill();
                // Glow
                ctx.shadowColor = "#FFD700";
                ctx.shadowBlur = 20;
                ctx.stroke();
                ctx.shadowBlur = 0;
                
                // Humo
                particles.push({x: x, y: y, vx: -2 - Math.random(), vy: Math.random(), life: 1, color: 'rgba(255,255,255,0.5)'});
            }

            drawParticles();
        }

        function createExplosion(x, y) {
            for(let i=0; i<30; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random()-0.5) * 10,
                    vy: (Math.random()-0.5) * 10,
                    life: 1,
                    color: '#ef4444'
                });
            }
        }

        function drawParticles() {
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy;
                p.life -= 0.02;
                if(p.life <= 0) particles.splice(i, 1);
                else {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
                }
            }
            ctx.globalAlpha = 1;
        }

        function addToHistory(val) {
            const bar = document.getElementById('historyBar');
            const pill = document.createElement('div');
            let type = 'loss';
            if (val >= 2) type = 'win';
            
            pill.className = `pill ${type}`;
            pill.innerText = val.toFixed(2) + "x";
            
            bar.prepend(pill);
            if(bar.children.length > 6) bar.removeChild(bar.lastChild);
        }
    </script>
</body>
</html>
