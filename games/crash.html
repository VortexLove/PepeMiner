<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crash | PepeCasino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { 
            background: transparent; 
            color: white; 
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            user-select: none;
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-wrapper {
            width: 100%;
            max-width: 1100px;
            height: 650px;
            background: #121924;
            border: 1px solid #1f2937;
            border-radius: 20px;
            display: grid;
            grid-template-columns: 300px 1fr;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* Panel de Control */
        .controls { background: #0b1016; padding: 24px; display: flex; flex-direction: column; gap: 20px; border-right: 1px solid #1f2937; }
        
        .input-group { background: #05080a; border: 1px solid #1f2937; border-radius: 8px; padding: 5px; display: flex; align-items: center; }
        .input-clean { background: transparent; width: 100%; border: none; color: white; padding: 10px; font-weight: bold; outline: none; }

        /* Escenario */
        .stage { position: relative; background: radial-gradient(circle at 10% 90%, #1a2530 0%, #05080a 70%); flex: 1; overflow: hidden; display: flex; align-items: center; justify-content: center; }

        /* Botón gigante */
        .btn-action {
            width: 100%; padding: 18px; border-radius: 12px; font-weight: 900; font-size: 1.2rem;
            text-transform: uppercase; transition: 0.2s; letter-spacing: 1px;
        }
        .btn-bet { background: #00ff2a; color: black; box-shadow: 0 0 20px rgba(0,255,42,0.2); }
        .btn-bet:hover { transform: translateY(-2px); box-shadow: 0 0 30px rgba(0,255,42,0.4); }
        .btn-cashout { background: #eab308; color: black; box-shadow: 0 0 20px rgba(234, 179, 8, 0.2); }
        .btn-cashout:hover { filter: brightness(1.1); }
        
        .btn-disabled { background: #374151; color: #9ca3af; cursor: not-allowed; box-shadow: none; }

        /* UI Flotante */
        .crash-info { position: absolute; top: 20px; right: 20px; text-align: right; }
        .history-pill { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; background: #374151; }
        .history-pill.win { background: #00ff2a; color: black; }
        .history-pill.lose { background: #ef4444; color: white; }

        /* Canvas */
        #crashCanvas { width: 100%; height: 100%; }

        /* Mobile */
        @media (max-width: 900px) {
            .game-wrapper { grid-template-columns: 1fr; display: flex; flex-direction: column-reverse; height: 100vh; border-radius: 0; border: none; }
            .stage { height: 60%; }
            .controls { height: 40%; padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="game-wrapper">
        <!-- CONTROLES IZQUIERDOS -->
        <div class="controls">
            <div>
                <div class="flex justify-between text-[10px] font-bold text-gray-500 uppercase mb-1">
                    <span>Bet Amount</span>
                    <span id="balanceDisplay">Loading...</span>
                </div>
                <div class="input-group">
                    <i class="fas fa-coins text-gray-500 ml-3"></i>
                    <input type="number" id="betInput" value="10" class="input-clean">
                    <button onclick="adjBet(0.5)" class="px-2 py-1 text-[10px] font-bold text-gray-400 hover:text-white">½</button>
                    <button onclick="adjBet(2)" class="px-2 py-1 text-[10px] font-bold text-gray-400 hover:text-white">2x</button>
                </div>
            </div>

            <div>
                <div class="flex justify-between text-[10px] font-bold text-gray-500 uppercase mb-1">
                    <span>Auto Cashout (x)</span>
                </div>
                <div class="input-group">
                    <i class="fas fa-lock text-gray-500 ml-3"></i>
                    <input type="number" id="autoCashout" value="2.00" class="input-clean">
                </div>
            </div>

            <div class="mt-auto">
                <button id="mainBtn" onclick="action()" class="btn-action btn-bet">BET</button>
            </div>
        </div>

        <!-- ESCENARIO -->
        <div class="stage" id="stage">
            <div class="crash-info">
                <div class="text-[10px] font-bold text-gray-500 uppercase mb-1">Recent History</div>
                <div id="historyRow"></div>
            </div>
            
            <!-- Texto Multiplicador Gigante -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div id="multDisplay" class="text-7xl md:text-9xl font-black text-white font-[Space_Grotesk] tracking-tighter tabular-nums">1.00x</div>
                <div id="statusText" class="absolute mt-32 text-sm font-bold uppercase tracking-widest text-gray-500 hidden">Crashed</div>
            </div>

            <canvas id="crashCanvas"></canvas>
        </div>
    </div>

    <!-- AUDIO -->
    <audio id="sfx-tick" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sfx-explode" src="https://assets.mixkit.co/active_storage/sfx/1707/1707-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

    <script>
        // --- COMUNICACIÓN CON PADRE (Iframe Infrastructure) ---
        let userBalance = 0;
        
        window.addEventListener('message', (e) => {
            if (e.data.type === 'INIT_BALANCE' || e.data.type === 'SYNC_BALANCE') {
                userBalance = e.data.balance;
                document.getElementById('balanceDisplay').innerText = userBalance.toFixed(2);
            }
        });

        function updateParent(amount) {
            window.parent.postMessage({ type: 'UPDATE_BALANCE', amount: amount }, '*');
        }

        // --- GAME LOGIC ---
        const canvas = document.getElementById('crashCanvas');
        const ctx = canvas.getContext('2d');
        const multDisplay = document.getElementById('multDisplay');
        const mainBtn = document.getElementById('mainBtn');
        const statusText = document.getElementById('statusText');

        // Estado del Juego
        let state = 'IDLE'; // IDLE, RUNNING, CRASHED
        let currentMult = 1.00;
        let crashPoint = 0;
        let startTime = 0;
        let betAmount = 0;
        let hasCashedOut = false;
        let animationId;
        
        // Gráfico
        let graphData = []; // {x, y}

        // Init
        resize();
        window.addEventListener('resize', resize);
        
        function resize() {
            canvas.width = document.getElementById('stage').clientWidth;
            canvas.height = document.getElementById('stage').clientHeight;
            drawGraph(); // Redibujar si está estático
        }

        function adjBet(m) {
            const el = document.getElementById('betInput');
            let v = parseFloat(el.value) * m;
            if(v<1) v=1; el.value = v.toFixed(2);
        }

        // BOTÓN PRINCIPAL
        function action() {
            if(state === 'IDLE') {
                startGame();
            } else if (state === 'RUNNING') {
                cashOut();
            }
        }

        function startGame() {
            const bet = parseFloat(document.getElementById('betInput').value);
            if(isNaN(bet) || bet <= 0) return;
            if(bet > userBalance) return alert("Insufficient Balance");

            // Descontar saldo
            betAmount = bet;
            updateParent(-betAmount);

            // Reset UI
            state = 'RUNNING';
            hasCashedOut = false;
            currentMult = 1.00;
            graphData = [{x:0, y: canvas.height}];
            statusText.classList.add('hidden');
            multDisplay.style.color = "white";
            
            // Determinar punto de Crash (Simulación Provably Fair)
            // Fórmula simple de casino: E = 0.99 / (1 - random)
            // Genera muchos 1.xx y pocos 100.xx
            crashPoint = Math.max(1.00, (0.99 / (1 - Math.random())));
            if(Math.random() < 0.05) crashPoint = 1.00; // Instant crash chance

            // Cambiar botón
            mainBtn.innerText = "CASHOUT";
            mainBtn.className = "btn-action btn-cashout";

            // Iniciar Loop
            startTime = Date.now();
            loop();
        }

        function cashOut() {
            if(state !== 'RUNNING' || hasCashedOut) return;
            hasCashedOut = true;
            
            const win = betAmount * currentMult;
            updateParent(win); // Pagar al usuario
            
            // UI Feedback
            document.getElementById('sfx-win').play();
            mainBtn.innerText = "WAITING...";
            mainBtn.className = "btn-action btn-disabled";
            
            // Visual ganar
            const profit = win - betAmount;
            multDisplay.innerHTML = `<span class="text-green-500">${currentMult.toFixed(2)}x</span> <div class="text-sm text-white">+${profit.toFixed(2)}</div>`;
        }

        function loop() {
            if(state !== 'RUNNING') return;

            const now = Date.now();
            const elapsed = (now - startTime) / 1000; // segundos
            
            // Función de crecimiento exponencial
            // 1.0 + x^2 * factor (ajustar velocidad)
            currentMult = 1.0 + Math.pow(elapsed, 1.5) * 0.15;
            
            // Actualizar Display
            if(!hasCashedOut) multDisplay.innerText = currentMult.toFixed(2) + "x";

            // Auto Cashout Logic
            const autoTarget = parseFloat(document.getElementById('autoCashout').value);
            if(!hasCashedOut && autoTarget && currentMult >= autoTarget) {
                cashOut();
            }

            // Crash Check
            if(currentMult >= crashPoint) {
                crash();
            } else {
                drawGraph(elapsed);
                animationId = requestAnimationFrame(loop);
            }
        }

        function crash() {
            state = 'CRASHED';
            cancelAnimationFrame(animationId);
            document.getElementById('sfx-explode').play();

            // UI Crash
            multDisplay.innerText = crashPoint.toFixed(2) + "x";
            multDisplay.style.color = "#ef4444"; // Rojo
            statusText.innerText = `CRASHED @ ${crashPoint.toFixed(2)}x`;
            statusText.classList.remove('hidden');

            // Reset Botón
            mainBtn.innerText = "BET";
            mainBtn.className = "btn-action btn-bet";

            // Añadir al historial
            addToHistory(crashPoint);
        }

        // DIBUJAR CANVAS
        function drawGraph(elapsed) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Configurar Escala
            // El gráfico debe mantenerse dentro de la vista, así que "alejamos" la cámara
            // conforme sube el tiempo y el multiplicador
            
            const w = canvas.width;
            const h = canvas.height;
            const padding = 50;

            ctx.beginPath();
            ctx.moveTo(0, h); // Esquina inf izq

            // Curva Bezier Simulada
            // Punto inicio: 0, h
            // Punto fin: w * 0.8, h * 0.2 (arriba derecha)
            // Control: curva
            
            // Simulación visual simple: Dibujar línea desde inicio hasta progreso actual
            // Para hacerlo "infinito", simplemente dibujamos una curva estática que parece crecer
            // y movemos el "cohete" a lo largo de ella.
            
            // Mejor approach: Dibujar una curva cuadrática simple que representa el crecimiento
            
            const progress = Math.min(1, elapsed / 10); // Ejemplo de normalización visual

            ctx.strokeStyle = state === 'CRASHED' ? '#ef4444' : '#00ff2a';
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            
            // Dibujamos la curva
            // Start: (0, h)
            // End: (w-padding, h - (h*progress))
            
            // Truco visual de Crash: La curva siempre se ve igual, solo cambia el numero
            // Pero para hacerlo "real", haremos que la linea crezca
            
            let endX = (w * 0.8);
            let endY = h - (h * 0.6); // Punto fijo visual de "acción"
            
            // Shake effect if high multiplier
            let shakeX = 0, shakeY = 0;
            if(currentMult > 10 && state === 'RUNNING') {
                shakeX = (Math.random()-0.5)*5;
                shakeY = (Math.random()-0.5)*5;
            }

            // Dibujar linea
            ctx.beginPath();
            ctx.moveTo(0, h);
            ctx.quadraticCurveTo(w/2, h, endX + shakeX, endY + shakeY);
            ctx.stroke();

            // Dibujar Cohete/Bola en la punta
            ctx.beginPath();
            ctx.arc(endX + shakeX, endY + shakeY, 8, 0, Math.PI*2);
            ctx.fillStyle = "white";
            ctx.fill();
            
            // Glow
            ctx.shadowColor = state === 'CRASHED' ? '#ef4444' : '#00ff2a';
            ctx.shadowBlur = 20;
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        function addToHistory(val) {
            const div = document.getElementById('historyRow');
            const pill = document.createElement('span');
            pill.className = `history-pill ${val >= 2 ? 'win' : 'lose'}`;
            pill.innerText = val.toFixed(2) + "x";
            div.prepend(pill);
            if(div.children.length > 5) div.removeChild(div.lastChild);
        }

        // Initial Draw
        drawGraph(0);

    </script>
</body>
</html>
