<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PepeBlackJack | #1 Web3 Casino on Base</title>
    <meta name="description" content="Play, Stake, and Earn $PBJ. The wildest casino on Base chain.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ethers.js v5.7.2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Icons & Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;600;700;900&family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Configuraci√≥n Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pepe-dark': '#020304',
                        'pepe-panel': '#0c1116',
                        'pepe-card': '#131b24',
                        'neon': '#00ff41',
                    },
                    fontFamily: {
                        'brand': ['Chakra Petch', 'sans-serif'],
                        'body': ['Inter', 'sans-serif'],
                    },
                    screens: {
                        'xs': '375px', // Soporte para m√≥viles peque√±os
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --primary: #00ff41;
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --sidebar-width: 260px;
            --chat-width: 320px;
        }

        body { 
            background-color: #020304;
            color: #e5e7eb; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; /* Evita scroll en el body, lo manejamos internamente */
            -webkit-tap-highlight-color: transparent; /* Elimina flash azul en m√≥viles */
        }

        /* Tipograf√≠a Marca */
        .brand-font { font-family: 'Chakra Petch', sans-serif; letter-spacing: -0.02em; }

        /* Scrollbar Personalizado (Estilo Stealth) */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #05080a; }
        ::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Estructura Layout Responsive */
        .app-layout { 
            display: grid; 
            grid-template-columns: var(--sidebar-width) 1fr var(--chat-width); 
            grid-template-rows: 60px 1fr; /* Header m√°s compacto en m√≥vil */
            height: 100vh; 
            transition: all 0.3s ease;
        }

        /* Media Queries M√≥vil y Tablet */
        @media (max-width: 1280px) {
            .app-layout { grid-template-columns: var(--sidebar-width) 1fr 0px; }
            .chat-sidebar { position: fixed; right: 0; top: 60px; bottom: 0; width: 100%; max-width: 320px; transform: translateX(100%); z-index: 50; border-left: var(--glass-border); }
            .chat-sidebar.open { transform: translateX(0); }
        }

        @media (max-width: 1024px) {
            .app-layout { grid-template-columns: 0px 1fr 0px; }
            
            /* Sidebar M√≥vil (Drawer) */
            .sidebar { 
                position: fixed; 
                left: 0; 
                top: 0; 
                bottom: 0; 
                width: 280px; 
                transform: translateX(-100%); 
                z-index: 60; 
                box-shadow: 5px 0 30px rgba(0,0,0,0.5);
            }
            .sidebar.open { transform: translateX(0); }
        }

        /* Backdrop para m√≥vil */
        .mobile-backdrop {
            position: fixed; inset: 0; bg-black/80; backdrop-filter: blur(4px); z-index: 55; opacity: 0; pointer-events: none; transition: 0.3s;
            background: rgba(0,0,0,0.6);
        }
        .mobile-backdrop.active { opacity: 1; pointer-events: all; }

        /* Elementos UI */
        .sidebar { background: #080b0f; border-right: var(--glass-border); display: flex; flex-direction: column; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .header { grid-column: 1 / -1; grid-row: 1; z-index: 40; border-bottom: var(--glass-border); background: rgba(2, 3, 4, 0.9); backdrop-filter: blur(10px); }
        /* FixHeader para que cubra todo en movil cuando sidebar est√° oculto */
        @media (max-width: 1024px) { .header { grid-column: 1 / -1; } }
        
        .content-viewport { 
            grid-column: 2; 
            grid-row: 2; 
            position: relative; 
            overflow-y: auto; 
            overflow-x: hidden;
            background: radial-gradient(circle at 50% 0%, #0c151c 0%, #020304 60%);
        }
        .chat-sidebar { background: #080b0f; border-left: var(--glass-border); display: flex; flex-direction: column; transition: transform 0.3s ease; }

        /* Estilos Swap & Input */
        .input-group { background: #080b0f; border: 1px solid #1f2937; transition: 0.3s; }
        .input-group:focus-within { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 255, 65, 0.2); }

        /* Bot√≥n Jugar */
        .btn-play {
            background: var(--primary); color: #000; font-weight: 800; text-transform: uppercase; font-family: 'Chakra Petch';
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: 0.2s;
        }
        .btn-play:active { transform: scale(0.95); }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Web3Modal Customization (Hack simple para que combine) */
        w3m-modal { z-index: 100 !important; }
    </style>
</head>
<body>

    <!-- Backdrop para cerrar men√∫s en m√≥vil -->
    <div id="mobileBackdrop" class="mobile-backdrop" onclick="closeAllMenus()"></div>

    <div class="app-layout" id="appLayout">
        
        <!-- 1. HEADER (Mobile Optimized) -->
        <header class="header flex items-center justify-between px-4 md:px-6 h-full w-full">
            <div class="flex items-center gap-4">
                <!-- Mobile Menu Button -->
                <button onclick="toggleSidebar()" class="lg:hidden text-white text-xl hover:text-neon p-2">
                    <i class="fas fa-bars"></i>
                </button>
                
                <!-- Logo -->
                <div class="flex items-center gap-2 cursor-pointer" onclick="showSection('home')">
                    <img src="https://cryptologos.cc/logos/pepe-pepe-logo.png" class="w-8 h-8 md:w-9 md:h-9 animate-bounce">
                    <span class="font-black text-xl md:text-2xl text-white brand-font tracking-tighter">PEPE<span class="text-neon">BJ</span></span>
                </div>
            </div>

            <!-- Header Stats (Desktop Only) -->
            <div class="hidden md:flex items-center gap-3 bg-[#0c1116] border border-white/10 p-1.5 rounded-xl absolute left-1/2 transform -translate-x-1/2">
                <div class="flex items-center gap-2 px-3 border-r border-white/10">
                    <span class="text-[10px] text-gray-500 font-bold uppercase">Wallet</span>
                    <span class="font-mono font-bold text-white text-sm" id="headerWalletBal">0.00</span>
                </div>
                <div class="flex items-center gap-2 px-3 cursor-pointer" onclick="showSection('profile')">
                    <span class="text-[10px] text-gray-500 font-bold uppercase">Game</span>
                    <span class="font-mono font-bold text-neon text-sm" id="headerGameBal">0.00</span>
                    <i class="fas fa-coins text-yellow-500"></i>
                </div>
            </div>
            
            <!-- Right Actions -->
            <div class="flex gap-3 items-center">
                <!-- Mobile Balance (Simple) -->
                <div class="md:hidden flex flex-col items-end leading-none mr-2" onclick="showSection('profile')">
                    <span class="text-neon font-bold font-mono text-sm" id="mobileGameBal">0.00</span>
                    <span class="text-[9px] text-gray-500">PBJ</span>
                </div>

                <!-- Connect Button (Web3Modal target) -->
                <button id="connectBtn" class="bg-white text-black hover:bg-gray-200 px-3 py-1.5 md:px-5 md:py-2 rounded-lg text-xs font-bold shadow-lg transition flex items-center gap-2 brand-font uppercase">
                    <i class="fas fa-wallet"></i> <span class="hidden xs:inline">Connect</span>
                </button>
                
                <!-- Chat Toggle -->
                <button onclick="toggleChat()" class="w-9 h-9 flex items-center justify-center rounded-lg bg-[#131b24] border border-white/10 text-gray-400 hover:text-white relative">
                    <i class="fas fa-comments"></i>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full border border-[#131b24]"></span>
                </button>
            </div>
        </header>

        <!-- 2. SIDEBAR (Drawer) -->
        <nav id="sidebar" class="sidebar">
            <div class="p-6 flex items-center justify-between lg:justify-center border-b border-white/5 bg-[#05080a]">
                <span class="text-xs font-bold text-gray-500 tracking-[0.2em] uppercase">Navigation</span>
                <button onclick="toggleSidebar()" class="lg:hidden text-gray-500"><i class="fas fa-times"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto px-4 py-4 space-y-1 custom-scrollbar">
                <button onclick="navTo('home')" class="w-full text-left flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition group">
                    <i class="fas fa-home w-5 text-center group-hover:text-neon"></i> Home
                </button>
                <button onclick="navTo('profile')" class="w-full text-left flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition group">
                    <i class="fas fa-user-astronaut w-5 text-center group-hover:text-blue-400"></i> Profile
                </button>
                <button onclick="navTo('nft')" class="w-full text-left flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition group">
                    <i class="fas fa-layer-group w-5 text-center group-hover:text-purple-400"></i> NFT Vault
                </button>
                <button onclick="navTo('partners')" class="w-full text-left flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition group">
                    <i class="fas fa-handshake w-5 text-center group-hover:text-yellow-400"></i> Earn Cash
                </button>

                <p class="px-3 text-[10px] font-bold text-gray-600 uppercase mt-6 mb-2">Games</p>
                <div class="space-y-1">
                    <button onclick="loadGame('games/plinko.html', 'Plinko')" class="w-full text-left flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition"><i class="fas fa-caret-down text-pink-500 w-5"></i> Plinko</button>
                    <button onclick="loadGame('games/crash.html', 'Crash')" class="w-full text-left flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition"><i class="fas fa-rocket text-purple-500 w-5"></i> Crash</button>
                    <button onclick="loadGame('games/blackjack.html', 'Blackjack')" class="w-full text-left flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition"><i class="fas fa-heart text-red-500 w-5"></i> Blackjack</button>
                    <button onclick="loadGame('games/mines.html', 'Mines')" class="w-full text-left flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition"><i class="fas fa-bomb text-yellow-500 w-5"></i> Mines</button>
                </div>

                <!-- Mobile Only Wallet Stats in Menu -->
                <div class="lg:hidden mt-6 p-4 bg-[#131b24] rounded-xl border border-white/5">
                    <p class="text-[10px] text-gray-500 uppercase font-bold mb-2">My Wallet</p>
                    <div class="flex justify-between text-sm mb-1"><span class="text-gray-400">ETH</span> <span class="text-white font-bold" id="sidebarEthBal">0.00</span></div>
                    <div class="flex justify-between text-sm"><span class="text-gray-400">PBJ</span> <span class="text-white font-bold" id="sidebarPbjBal">0.00</span></div>
                </div>
            </div>
            
            <div class="p-4 border-t border-white/5 bg-[#05080a] text-center">
                <span class="inline-block w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></span>
                <span class="text-xs text-gray-400 font-bold"><span id="onlineUsers">420</span> Players Online</span>
            </div>
        </nav>

        <!-- 3. MAIN CONTENT -->
        <main class="content-viewport custom-scrollbar">
            
            <!-- Toast Notifications Container -->
            <div id="liveToastContainer" class="fixed bottom-4 left-4 right-4 z-50 flex flex-col-reverse gap-2 pointer-events-none md:max-w-sm"></div>

            <!-- A. HOME SECTION -->
            <div id="homeSection" class="w-full max-w-7xl mx-auto p-4 md:p-8 fade-in pb-20">
                
                <!-- Hero Section: Presale & Swap -->
                <div class="grid lg:grid-cols-12 gap-6 md:gap-8 mb-10">
                    <!-- Left: Hype Text -->
                    <div class="lg:col-span-7 flex flex-col justify-center pt-4 md:pt-0">
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="bg-neon/10 text-neon border border-neon/20 px-3 py-1 rounded text-[10px] font-bold uppercase animate-pulse">‚óè Live Presale</span>
                            <span class="bg-white/5 text-gray-300 border border-white/10 px-3 py-1 rounded text-[10px] font-bold uppercase">Audited</span>
                        </div>
                        <h1 class="text-4xl md:text-6xl lg:text-7xl font-black text-white leading-[0.9] brand-font mb-4">
                            OWN THE <br>
                            <span class="text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-600">CASINO</span>
                        </h1>
                        <p class="text-gray-400 text-sm md:text-lg mb-6 max-w-lg leading-relaxed">
                            Stake $PBJ NFTs to earn 50% of house profits. Connect any wallet to join the revolution on Base.
                        </p>
                        
                        <!-- Progress Bar -->
                        <div class="bg-[#0c1116] p-5 rounded-2xl border border-white/10 relative overflow-hidden">
                            <div class="flex justify-between items-end mb-2">
                                <div>
                                    <p class="text-[10px] text-gray-500 uppercase font-bold">Raised So Far</p>
                                    <p class="text-xl md:text-2xl font-bold text-white">$4,280,105</p>
                                </div>
                                <span class="text-neon font-bold text-lg">82%</span>
                            </div>
                            <div class="w-full h-3 bg-gray-800 rounded-full overflow-hidden">
                                <div class="h-full bg-neon w-[82%] shadow-[0_0_15px_#00ff41]"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Swap Interface -->
                    <div class="lg:col-span-5">
                        <div class="bg-[#131b24] border border-white/10 rounded-2xl p-5 shadow-2xl relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-white">Buy $PBJ</h3>
                                <div class="flex bg-black/40 rounded-lg p-1">
                                    <button class="px-3 py-1 rounded-md text-xs font-bold bg-[#2d3748] text-white" id="tabBuy" onclick="toggleSwapMode('buy')">Buy</button>
                                    <button class="px-3 py-1 rounded-md text-xs font-bold text-gray-500" id="tabSell" onclick="toggleSwapMode('sell')">Sell</button>
                                </div>
                            </div>

                            <div class="space-y-2">
                                <!-- Input A -->
                                <div class="input-group rounded-xl p-3">
                                    <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                                        <span>Pay with</span>
                                        <span>Bal: <span id="balInputA">0.00</span></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="inputA" placeholder="0.0" class="bg-transparent w-full text-xl font-bold text-white outline-none" oninput="handleInputA()">
                                        <div class="bg-black px-2 py-1 rounded-full flex items-center gap-1 border border-white/10 shrink-0" id="tokenA">
                                            <img src="https://cryptologos.cc/logos/ethereum-eth-logo.png" class="w-4 h-4"> <span class="text-xs font-bold">ETH</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex justify-center -my-3 relative z-10"><i class="fas fa-arrow-down bg-[#131b24] p-1.5 rounded-full border border-white/10 text-xs text-gray-500"></i></div>

                                <!-- Input B -->
                                <div class="input-group rounded-xl p-3">
                                    <div class="flex justify-between text-[10px] text-gray-400 mb-1"><span>Receive</span></div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="inputB" placeholder="0.0" class="bg-transparent w-full text-xl font-bold text-neon outline-none" oninput="handleInputB()">
                                        <div class="bg-black px-2 py-1 rounded-full flex items-center gap-1 border border-white/10 shrink-0" id="tokenB">
                                            <span class="text-sm">üê∏</span> <span class="text-xs font-bold">PBJ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button onclick="handleSwapAction()" id="swapMainBtn" class="btn-play w-full mt-4 py-3.5 rounded-xl text-sm shadow-[0_0_20px_rgba(0,255,65,0.3)]">
                                CONNECT WALLET
                            </button>
                            <p class="text-center text-[9px] text-gray-500 mt-3">1 ETH = 1,000,000 PBJ ‚Ä¢ Gas on Base</p>
                        </div>
                    </div>
                </div>

                <!-- Games Grid -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-white brand-font"><span class="text-neon mr-2">///</span>POPULAR GAMES</h3>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-4 mb-12">
                    <!-- Game Card Template -->
                    <div onclick="loadGame('games/plinko.html', 'Plinko')" class="group relative aspect-[3/4] rounded-xl bg-[#131b24] overflow-hidden cursor-pointer border border-white/5 active:scale-95 transition">
                        <img src="assets/img/game-plinko.png" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" alt="Plinko">
                        <div class="absolute bottom-0 w-full p-3 bg-gradient-to-t from-black to-transparent">
                            <h4 class="font-bold text-white text-sm">Plinko</h4>
                            <p class="text-[9px] text-neon">99% RTP</p>
                        </div>
                    </div>
                    <div onclick="loadGame('games/crash.html', 'Crash')" class="group relative aspect-[3/4] rounded-xl bg-[#131b24] overflow-hidden cursor-pointer border border-white/5 active:scale-95 transition">
                        <img src="assets/img/game-crash.png" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" alt="Crash">
                        <div class="absolute bottom-0 w-full p-3 bg-gradient-to-t from-black to-transparent">
                            <h4 class="font-bold text-white text-sm">Crash</h4>
                            <p class="text-[9px] text-purple-400">Multiplayer</p>
                        </div>
                    </div>
                    <div onclick="loadGame('games/blackjack.html', 'Blackjack')" class="group relative aspect-[3/4] rounded-xl bg-[#131b24] overflow-hidden cursor-pointer border border-white/5 active:scale-95 transition">
                        <img src="assets/img/game-blackjack.png" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" alt="Blackjack">
                        <div class="absolute bottom-0 w-full p-3 bg-gradient-to-t from-black to-transparent">
                            <h4 class="font-bold text-white text-sm">Blackjack</h4>
                            <p class="text-[9px] text-red-400">Live Dealer</p>
                        </div>
                    </div>
                    <div onclick="loadGame('games/mines.html', 'Mines')" class="group relative aspect-[3/4] rounded-xl bg-[#131b24] overflow-hidden cursor-pointer border border-white/5 active:scale-95 transition">
                        <img src="assets/img/game-mines.png" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" alt="Mines">
                        <div class="absolute bottom-0 w-full p-3 bg-gradient-to-t from-black to-transparent">
                            <h4 class="font-bold text-white text-sm">Mines</h4>
                            <p class="text-[9px] text-yellow-400">Strategic</p>
                        </div>
                    </div>
                    <div onclick="loadGame('games/dice.html', 'Dice')" class="group relative aspect-[3/4] rounded-xl bg-[#131b24] overflow-hidden cursor-pointer border border-white/5 active:scale-95 transition">
                        <img src="assets/img/game-dice.png" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" alt="Dice">
                        <div class="absolute bottom-0 w-full p-3 bg-gradient-to-t from-black to-transparent">
                            <h4 class="font-bold text-white text-sm">Dice</h4>
                            <p class="text-[9px] text-blue-400">Fast</p>
                        </div>
                    </div>
                </div>

                <!-- NFT Promo -->
                <div class="bg-gradient-to-br from-[#131b24] to-black rounded-2xl p-6 md:p-8 border border-white/5 flex flex-col md:flex-row items-center justify-between gap-6">
                    <div>
                        <h3 class="text-2xl font-black text-white brand-font mb-2">NFT VAULT</h3>
                        <p class="text-gray-400 text-sm max-w-md">Stake Pepe Cards and earn passive yield. 100% decentralized.</p>
                    </div>
                    <button onclick="navTo('nft')" class="btn-play px-6 py-3 rounded-lg text-sm bg-purple-600 text-white hover:bg-purple-500 shadow-lg border-none w-full md:w-auto">ENTER VAULT</button>
                </div>
            </div>

            <!-- B. PROFILE SECTION -->
            <div id="profileSection" class="hidden w-full max-w-5xl mx-auto p-4 md:p-8 fade-in pb-20">
                <h2 class="text-3xl font-black text-white brand-font mb-6">USER <span class="text-neon">PROFILE</span></h2>
                
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- User Info -->
                    <div class="bg-[#131b24] rounded-2xl p-6 text-center border border-white/5">
                        <img src="https://api.dicebear.com/9.x/avataaars/svg?seed=Pepe" class="w-20 h-20 rounded-full mx-auto mb-3 bg-black border-2 border-white/10" id="profileAvatar">
                        <h3 class="text-lg font-bold text-white" id="profileName">Guest</h3>
                        <p class="text-[10px] text-neon uppercase font-bold tracking-widest mb-4">Level 1</p>
                        <div class="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden mb-1"><div class="bg-neon w-[10%] h-full"></div></div>
                        <p class="text-[9px] text-gray-500">100 XP to Level 2</p>
                    </div>

                    <!-- Cashier -->
                    <div class="lg:col-span-2 bg-[#131b24] rounded-2xl p-6 border border-white/5">
                        <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-wallet text-gray-400"></i> Cashier</h3>
                        <div class="grid gap-4 md:grid-cols-2">
                            <div class="bg-[#080b0f] p-4 rounded-xl border border-white/5">
                                <p class="text-neon text-xs font-bold mb-2 uppercase">Deposit</p>
                                <input type="number" id="depositInput" placeholder="Amount" class="w-full bg-[#131b24] p-3 rounded-lg text-white font-bold mb-3 border border-white/5 outline-none focus:border-neon/50">
                                <button onclick="depositChips()" class="btn-play w-full py-2 rounded text-xs shadow-lg">DEPOSIT</button>
                            </div>
                            <div class="bg-[#080b0f] p-4 rounded-xl border border-white/5">
                                <p class="text-red-500 text-xs font-bold mb-2 uppercase">Withdraw</p>
                                <input type="number" id="withdrawInput" placeholder="Amount" class="w-full bg-[#131b24] p-3 rounded-lg text-white font-bold mb-3 border border-white/5 outline-none focus:border-red-500/50">
                                <button onclick="withdrawChips()" class="w-full py-2 rounded text-xs font-bold bg-white/10 hover:bg-white/20 text-white transition">WITHDRAW</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- C. NFT SECTION -->
            <div id="nftSection" class="hidden w-full max-w-7xl mx-auto p-4 md:p-8 fade-in pb-20">
                <div class="flex flex-col md:flex-row justify-between items-end mb-8 border-b border-white/10 pb-4">
                    <div>
                        <h2 class="text-3xl font-black text-white brand-font">MINING <span class="text-purple-500">VAULT</span></h2>
                    </div>
                    <div class="flex gap-2 mt-4 md:mt-0 bg-[#131b24] p-1 rounded-lg">
                        <button onclick="switchNftTab('mint')" id="tabMint" class="px-4 py-2 rounded text-xs font-bold bg-purple-600 text-white transition">MINT</button>
                        <button onclick="switchNftTab('inventory')" id="tabInventory" class="px-4 py-2 rounded text-xs font-bold text-gray-400 hover:text-white transition">MY CARDS</button>
                    </div>
                </div>

                <div id="nftMintView" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                
                <div id="nftInventoryView" class="hidden">
                    <div class="bg-purple-900/20 border border-purple-500/20 rounded-xl p-4 mb-6 flex justify-between items-center">
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase font-bold">Unclaimed Yield</p>
                            <p class="text-xl font-bold text-white font-mono"><span id="pendingRewards">0.00</span> PBJ</p>
                        </div>
                        <button onclick="claimRewards()" class="px-4 py-2 bg-white text-purple-900 font-bold rounded text-xs shadow-lg">CLAIM</button>
                    </div>
                    <div id="myNftGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                </div>
            </div>

            <!-- D. AFFILIATES -->
            <div id="partnersSection" class="hidden w-full max-w-4xl mx-auto p-4 md:p-8 fade-in pb-20">
                <div class="bg-[#131b24] rounded-3xl p-6 md:p-10 text-center border border-white/5 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-yellow-500"></div>
                    <h2 class="text-3xl md:text-5xl font-black text-white mb-4 brand-font">EARN <span class="text-yellow-400">CASH</span></h2>
                    <p class="text-gray-400 mb-8 text-sm">Refer friends and get up to 50% revenue share instantly.</p>
                    
                    <div class="bg-black/50 p-2 rounded-xl flex items-center border border-white/10 mb-8">
                        <input type="text" id="referralLinkInput" value="Connect Wallet first..." class="w-full bg-transparent p-3 text-xs text-white font-mono outline-none" readonly>
                        <button onclick="copyRefLink()" class="bg-yellow-500 text-black px-4 py-2 rounded-lg font-bold text-xs"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 md:gap-4">
                        <div class="bg-white/5 p-4 rounded-xl border border-white/5"><p class="text-xl font-bold text-yellow-500">30%</p><p class="text-[10px] text-gray-400">Tier 1</p></div>
                        <div class="bg-white/5 p-4 rounded-xl border border-white/5"><p class="text-xl font-bold text-yellow-500">40%</p><p class="text-[10px] text-gray-400">Tier 2</p></div>
                        <div class="bg-white/5 p-4 rounded-xl border border-white/5"><p class="text-xl font-bold text-yellow-500">50%</p><p class="text-[10px] text-gray-400">Whale</p></div>
                    </div>
                </div>
            </div>

            <!-- GAME IFRAME CONTAINER -->
            <div id="gameContainer" class="hidden absolute inset-0 z-50 bg-[#020304] flex flex-col h-full w-full">
                <div class="h-14 flex items-center justify-between px-4 bg-[#0c1116] border-b border-white/5 shrink-0">
                    <button onclick="showSection('home')" class="text-gray-400 hover:text-white flex items-center gap-2 text-xs font-bold uppercase"><i class="fas fa-arrow-left"></i> Exit</button>
                    <div class="flex items-center gap-2 bg-black/40 px-3 py-1 rounded-full border border-white/5">
                        <span class="text-[9px] text-gray-500 font-bold uppercase">Bal</span>
                        <span class="text-neon font-bold text-xs font-mono" id="inGameBalance">0.00</span>
                    </div>
                </div>
                <iframe id="gameFrame" class="w-full h-full border-none" src="about:blank" allow="autoplay"></iframe>
            </div>

        </main>

        <!-- 4. CHAT SIDEBAR (Right Drawer) -->
        <aside id="chatSidebar" class="chat-sidebar">
            <div class="h-14 border-b border-white/5 flex justify-between items-center px-4 bg-[#0c1116]">
                <span class="font-bold text-white text-xs uppercase tracking-wider flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Chat
                </span>
                <button onclick="toggleChat()" class="lg:hidden text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-[#05080a]"></div>
            
            <div class="p-3 bg-[#0c1116] border-t border-white/5 safe-area-bottom">
                <div class="relative">
                    <input type="text" placeholder="Type..." class="w-full bg-[#05080a] text-xs text-white p-3 rounded-xl border border-white/10 outline-none focus:border-neon/50">
                    <button class="absolute right-2 top-2 text-gray-500 hover:text-white"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </aside>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <!-- Importar Web3Modal como Modulo -->
    <script type="module">
        import { createWeb3Modal, defaultConfig } from 'https://cdn.jsdelivr.net/npm/@web3modal/ethers5@4.0.0/dist/index.js'

        // 1. Configuraci√≥n Web3Modal (AppKit)
        const projectId = '2f5f4a7c870241940914856001227806' // ID p√∫blico de prueba (funciona para demos)

        const mainnet = {
            chainId: 8453,
            name: 'Base',
            currency: 'ETH',
            explorerUrl: 'https://basescan.org',
            rpcUrl: 'https://mainnet.base.org'
        }

        const metadata = {
            name: 'PepeBlackJack',
            description: 'Web3 Casino on Base',
            url: 'https://pepeblackjack.io',
            icons: ['https://cryptologos.cc/logos/pepe-pepe-logo.png']
        }

        const modal = createWeb3Modal({
            ethersConfig: defaultConfig({ metadata }),
            chains: [mainnet],
            projectId,
            themeMode: 'dark',
            themeVariables: {
                '--w3m-accent': '#00ff41',
                '--w3m-border-radius-master': '1px'
            }
        })

        // Exponer modal globalmente
        window.web3Modal = modal;
        
        // Listener de eventos Web3Modal
        modal.subscribeProvider(handleProviderChange);

        let provider, signer, userAddress;

        async function handleProviderChange({ provider: walletProvider, address, isConnected }) {
            if (isConnected && walletProvider) {
                // Instanciar Provider de Ethers
                provider = new ethers.providers.Web3Provider(walletProvider);
                signer = provider.getSigner();
                userAddress = address;
                
                // Actualizar UI
                const btn = document.getElementById('connectBtn');
                btn.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full"></span> <span class="font-mono">${address.substring(0,4)}...${address.substring(38)}</span>`;
                btn.onclick = () => modal.open({ view: 'Account' });

                document.getElementById('swapMainBtn').innerText = "SWAP ETH FOR PBJ";
                
                // Cargar contratos y balances
                updateWalletData();
                renderNftMintOptions(); // Recargar para activar botones
            } else {
                // Desconectado
                userAddress = null;
                document.getElementById('connectBtn').innerHTML = `<i class="fas fa-wallet"></i> <span class="hidden xs:inline">Connect</span>`;
                document.getElementById('connectBtn').onclick = () => modal.open();
                document.getElementById('headerWalletBal').innerText = "0.00";
                document.getElementById('swapMainBtn').innerText = "CONNECT WALLET";
            }
        }

        // --- Funciones Globales para el HTML ---
        window.connectWallet = () => modal.open();
        
        // --- CONTRATOS & L√ìGICA EXISTENTE ---
        const PBJ_ADDRESS = "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5";
        const NFT_ADDRESS = "0xDE05dAf2cbF59ce9094979d639393ADED494e920";
        const TREASURY_ADDRESS = "0x711ec57A367C381Be6f9d9C5523F2e85C88E03AA"; 
        const RATE = 1000000;
        
        const PBJ_ABI = ["function balanceOf(address) view returns (uint256)", "function transfer(address recipient, uint256 amount) returns (bool)", "function approve(address, uint256) returns (bool)", "function allowance(address, address) view returns (uint256)", "function decimals() view returns (uint8)"];
        const NFT_ABI = ["function mint(uint256 _id, uint256 _amount)", "function stake(uint256 _id, uint256 _amount)", "function unstake(uint256 _id, uint256 _amount)", "function claim()", "function getPendingRewards(address _user) view returns (uint256)", "function balanceOf(address, uint256) view returns (uint256)", "function getStakedBalance(address _user, uint256 _id) view returns (uint256)", "function isApprovedForAll(address account, address operator) view returns (bool)", "function setApprovalForAll(address operator, bool approved)"];

        let gameBalance = parseFloat(localStorage.getItem('pepe_chips') || '0');
        let swapMode = 'buy';

        // Inicializaci√≥n
        window.onload = () => {
            updateUI();
            renderNftMintOptions();
            startFakeActivity();
        };

        // UI Helpers
        window.updateWalletData = async () => {
            if(!userAddress || !provider) return;
            const pbjContract = new ethers.Contract(PBJ_ADDRESS, PBJ_ABI, provider);
            
            try {
                const rawBal = await pbjContract.balanceOf(userAddress);
                const walletBalance = parseFloat(ethers.utils.formatEther(rawBal));
                const ethRaw = await provider.getBalance(userAddress);
                const ethBal = parseFloat(ethers.utils.formatEther(ethRaw)).toFixed(4);
                
                document.getElementById('headerWalletBal').innerText = walletBalance.toLocaleString(undefined, {maximumFractionDigits: 0});
                document.getElementById('sidebarEthBal').innerText = ethBal;
                document.getElementById('sidebarPbjBal').innerText = walletBalance.toLocaleString(undefined, {maximumFractionDigits:0});
                document.getElementById('cashierWalletBal').innerText = walletBalance.toLocaleString();
                
                if(document.getElementById('balInputA')) {
                    document.getElementById('balInputA').innerText = swapMode === 'buy' ? ethBal : walletBalance.toLocaleString();
                }
                
                // Generar Link Ref
                document.getElementById('referralLinkInput').value = window.location.origin + "/?ref=" + userAddress;
            } catch(e) { console.error(e); }
        }

        window.updateUI = () => {
            const chips = gameBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('headerGameBal').innerText = chips;
            document.getElementById('mobileGameBal').innerText = chips;
            document.getElementById('inGameBalance').innerText = chips;
            if(document.getElementById('cashierGameBal')) document.getElementById('cashierGameBal').innerText = chips;
        }

        // Navigation
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const bd = document.getElementById('mobileBackdrop');
            sb.classList.toggle('open');
            bd.classList.toggle('active');
        }

        window.toggleChat = () => {
            const cs = document.getElementById('chatSidebar');
            if (window.innerWidth >= 1280) {
                const layout = document.getElementById('appLayout');
                // Desktop toggle logic
                const cols = getComputedStyle(layout).gridTemplateColumns;
                if(cols.includes('320px')) layout.style.gridTemplateColumns = '260px 1fr 0px';
                else layout.style.gridTemplateColumns = '260px 1fr 320px';
            } else {
                cs.classList.toggle('open');
            }
        }

        window.closeAllMenus = () => {
            document.getElementById('sidebar').classList.remove('open');
            if(window.innerWidth < 1280) document.getElementById('chatSidebar').classList.remove('open');
            document.getElementById('mobileBackdrop').classList.remove('active');
        }

        window.navTo = (section) => {
            window.showSection(section);
            window.closeAllMenus();
        }

        window.showSection = (id) => {
            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('gameFrame').src = 'about:blank';
            ['homeSection','profileSection','nftSection','partnersSection'].forEach(s => {
                const el = document.getElementById(s);
                if(el) el.classList.add('hidden');
            });
            const target = document.getElementById(id+'Section');
            if(target) target.classList.remove('hidden');
            window.scrollTo(0,0);
        }

        window.loadGame = (url, title) => {
            window.showSection('none'); // Ocultar todo
            window.closeAllMenus();
            const container = document.getElementById('gameContainer');
            container.classList.remove('hidden');
            const f = document.getElementById('gameFrame');
            f.src = url;
            f.onload = () => f.contentWindow.postMessage({type: 'INIT_BALANCE', balance: gameBalance}, '*');
        }

        // SWAP Logic
        window.toggleSwapMode = (mode) => {
            swapMode = mode;
            const btn = document.getElementById('swapMainBtn');
            const tA = document.getElementById('tokenA');
            const tB = document.getElementById('tokenB');
            const tabBuy = document.getElementById('tabBuy');
            const tabSell = document.getElementById('tabSell');

            document.getElementById('inputA').value = '';
            document.getElementById('inputB').value = '';

            if(mode === 'buy') {
                tabBuy.classList.replace('text-gray-500', 'text-white'); tabBuy.classList.replace('bg-transparent', 'bg-[#2d3748]');
                tabSell.classList.replace('text-white', 'text-gray-500'); tabSell.classList.replace('bg-[#2d3748]', 'bg-transparent');
                tA.innerHTML = '<img src="https://cryptologos.cc/logos/ethereum-eth-logo.png" class="w-4 h-4"> <span class="text-xs font-bold">ETH</span>';
                tB.innerHTML = '<span class="text-sm">üê∏</span> <span class="text-xs font-bold">PBJ</span>';
                btn.innerText = userAddress ? "SWAP ETH FOR PBJ" : "CONNECT WALLET";
                btn.disabled = false; btn.classList.remove('opacity-50');
            } else {
                tabSell.classList.replace('text-gray-500', 'text-white'); tabSell.classList.replace('bg-transparent', 'bg-[#2d3748]');
                tabBuy.classList.replace('text-white', 'text-gray-500'); tabBuy.classList.replace('bg-[#2d3748]', 'bg-transparent');
                tA.innerHTML = '<span class="text-sm">üê∏</span> <span class="text-xs font-bold">PBJ</span>';
                tB.innerHTML = '<img src="https://cryptologos.cc/logos/ethereum-eth-logo.png" class="w-4 h-4"> <span class="text-xs font-bold">ETH</span>';
                btn.innerText = "TRADING ENABLED SOON";
                btn.disabled = true; btn.classList.add('opacity-50');
            }
            window.updateWalletData();
        }

        window.handleInputA = () => {
            const valA = parseFloat(document.getElementById('inputA').value);
            if(isNaN(valA)) return document.getElementById('inputB').value = '';
            document.getElementById('inputB').value = swapMode === 'buy' ? (valA * RATE) : (valA / RATE).toFixed(6);
        }

        window.handleInputB = () => {
            const valB = parseFloat(document.getElementById('inputB').value);
            if(isNaN(valB)) return document.getElementById('inputA').value = '';
            document.getElementById('inputA').value = swapMode === 'buy' ? (valB / RATE).toFixed(6) : (valB * RATE);
        }

        window.handleSwapAction = async () => {
            if(!userAddress) return modal.open();
            const val = document.getElementById('inputA').value;
            if(!val || val <= 0) return;
            try {
                Swal.fire({title: 'Confirm', didOpen: () => Swal.showLoading(), background:'#131b24', color:'white'});
                const tx = await signer.sendTransaction({ to: PBJ_ADDRESS, value: ethers.utils.parseEther(val) });
                Swal.fire({title: 'Pending...', text: 'Waiting for blockchain', background:'#131b24', color:'white'});
                await tx.wait();
                window.updateWalletData();
                Swal.fire({icon: 'success', title: 'Success!', background:'#131b24', color:'white'});
            } catch(e) { Swal.fire({icon: 'error', title: 'Failed', text: e.message, background:'#131b24', color:'white'}); }
        }

        // NFT & MOCK DATA LOGIC
        const NFT_LEVELS = [
            {name: "Common", price: "5,000", img: "common"},
            {name: "Uncommon", price: "10,000", img: "uncommon"},
            {name: "Rare", price: "25,000", img: "rare"},
            {name: "Epic", price: "50,000", img: "epic"},
            {name: "Legendary", price: "100,000", img: "legendary"}
        ];

        window.renderNftMintOptions = () => {
            let html = "";
            NFT_LEVELS.forEach((tier, i) => {
                html += `<div class="bg-[#131b24] p-3 rounded-xl border border-white/5 relative group">
                    <img src="assets/img/nft-${tier.img}.png" class="w-full h-32 object-cover rounded-lg mb-2 opacity-80 group-hover:opacity-100 transition">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-white font-bold text-xs uppercase">${tier.name}</span>
                        <span class="text-neon text-xs font-mono">${tier.price}</span>
                    </div>
                    <button onclick="mintNft(${i}, '${tier.price.replace(',','')}')" class="w-full bg-white/5 hover:bg-white/20 text-white py-2 rounded text-[10px] font-bold uppercase border border-white/10 transition">Mint</button>
                </div>`;
            });
            const el = document.getElementById('nftMintView');
            if(el) el.innerHTML = html;
        }

        window.mintNft = async (id, price) => {
            if(!userAddress) return modal.open();
            // L√≥gica simulada visualmente si no hay contrato real conectado en demo
            Swal.fire({title: 'Minting...', didOpen:()=>Swal.showLoading(), background:'#131b24', color:'white'});
            setTimeout(() => Swal.fire({icon:'success', title:'Minted!', background:'#131b24', color:'white'}), 2000);
        }

        window.depositChips = () => {
            if(!userAddress) return modal.open();
            const amount = document.getElementById('depositInput').value;
            if(!amount) return;
            Swal.fire({title: 'Confirm Deposit', text: `Deposit ${amount} PBJ?`, showCancelButton:true, background:'#131b24', color:'white', confirmButtonColor: '#00ff41'}).then((res) => {
                if(res.isConfirmed) {
                    gameBalance += parseFloat(amount);
                    localStorage.setItem('pepe_chips', gameBalance);
                    updateUI();
                    Swal.fire({icon:'success', title:'Chips Added', background:'#131b24', color:'white'});
                }
            });
        }
        
        window.withdrawChips = () => {
            const amount = parseFloat(document.getElementById('withdrawInput').value);
            if(amount > gameBalance) return Swal.fire({icon:'error', title:'Insufficient Funds', background:'#131b24', color:'white'});
            gameBalance -= amount;
            localStorage.setItem('pepe_chips', gameBalance);
            updateUI();
            Swal.fire({icon:'success', title:'Withdrawal Pending', text:'Funds sent to wallet.', background:'#131b24', color:'white'});
        }

        window.copyRefLink = () => {
            const input = document.getElementById('referralLinkInput');
            navigator.clipboard.writeText(input.value);
            Swal.fire({icon:'success', title:'Copied', timer:1000, showConfirmButton:false, background:'#131b24', color:'white'});
        }

        // Activity Loop
        window.startFakeActivity = () => {
            setInterval(() => document.getElementById('onlineUsers').innerText = 400 + Math.floor(Math.random()*50), 3000);
            const msgs = ["LFG!", "Just won big", "Plinko rigged? jk", "To the moon üöÄ", "Nice UI"];
            const names = ["Chad", "Pepe", "Wojak", "Elon"];
            setInterval(() => {
                const div = document.createElement('div');
                div.className = "flex gap-2 text-xs mb-2 fade-in";
                div.innerHTML = `<span class="font-bold text-gray-400">${names[Math.floor(Math.random()*names.length)]}:</span> <span class="text-gray-300">${msgs[Math.floor(Math.random()*msgs.length)]}</span>`;
                document.getElementById('chatMessages').appendChild(div);
                if(document.getElementById('chatMessages').children.length > 20) document.getElementById('chatMessages').firstChild.remove();
            }, 4000);
            
            // Live Wins Toast
            setInterval(() => {
                const container = document.getElementById('liveToastContainer');
                const div = document.createElement('div');
                div.className = "bg-[#131b24]/90 backdrop-blur border border-neon/20 p-3 rounded-xl flex items-center gap-3 shadow-xl fade-in";
                div.innerHTML = `<i class="fas fa-trophy text-neon"></i> <div><p class="text-[9px] text-gray-400 font-bold uppercase">Winner</p><p class="text-xs text-white">0x...${Math.floor(Math.random()*999)} won <span class="text-neon font-bold">${Math.floor(Math.random()*1000)} PBJ</span></p></div>`;
                container.appendChild(div);
                setTimeout(() => div.remove(), 4000);
            }, 6000);
        }

        window.switchNftTab = (tab) => {
            if(tab === 'mint') {
                document.getElementById('nftMintView').classList.remove('hidden');
                document.getElementById('nftInventoryView').classList.add('hidden');
                document.getElementById('tabMint').classList.add('bg-purple-600', 'text-white');
                document.getElementById('tabMint').classList.remove('text-gray-400');
                document.getElementById('tabInventory').classList.remove('bg-purple-600', 'text-white');
            } else {
                document.getElementById('nftMintView').classList.add('hidden');
                document.getElementById('nftInventoryView').classList.remove('hidden');
                document.getElementById('tabInventory').classList.add('bg-purple-600', 'text-white');
                document.getElementById('tabInventory').classList.remove('text-gray-400');
                document.getElementById('tabMint').classList.remove('bg-purple-600', 'text-white');
                window.loadInventory();
            }
        }
        
        window.loadInventory = async () => {
             // Mock inventory for demo
             const grid = document.getElementById('myNftGrid');
             grid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">No NFTs found. <br><span class="text-xs">Connect wallet to view</span></div>`;
        }

    </script>
</body>
</html>
